<!DOCTYPE html>
<!-- saved from url=(0044)file:///C:/Users/user/Downloads/index_4.html -->
<html lang="ko">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>몬스터 카드 시스템 v3</title>
  <link href="file:///C:/Users/user/Downloads/index_files/css2" rel="stylesheet">
  <style>
    :root {
      --bg: #080a0f;
      --bg1: #0d1018;
      --bg2: #111520;
      --bg3: #161c2a;
      --border: #1e2a3d;
      --border2: #2a3a56;
      --border3: #3a5080;
      --t1: #9ca3af;
      --t2: #4ade80;
      --t3: #38bdf8;
      --t4: #a78bfa;
      --t5: #f97316;
      --t6: #f43f5e;
      --t7: #fbbf24;
      --t7g: rgba(251, 191, 36, .3);
      --gold: #e8b84b;
      --gold2: #f5d070;
      --silver: #8baabb;
      --green: #34d399;
      --red: #f87171;
      --blue: #60a5fa;
      --text1: #e2e8f4;
      --text2: #7a90b0;
      --text3: #3d5070;
      --pair-c: #34d399;
      --twopair-c: #22d3ee;
      --triple-c: #e8b84b;
      --fullhouse-c: #a78bfa;
      --straight-c: #f87171;
      --e1: #4ade80;
      --e2: #38bdf8;
      --e3: #a78bfa;
      --e4: #f97316;
      --e5: #f43f5e;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: var(--bg);
      color: var(--text1);
      font-family: 'Noto Sans KR', sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse 80% 50% at 15% 0%, rgba(74, 110, 200, .06) 0%, transparent 60%),
        radial-gradient(ellipse 60% 40% at 85% 90%, rgba(139, 92, 246, .05) 0%, transparent 60%),
        url("data:image/svg+xml,%3Csvg width='40' height='40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 20 L20 0 L40 20 L20 40 Z' fill='none' stroke='%231a2540' stroke-width='0.5'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 0;
    }

    .app {
      position: relative;
      z-index: 1;
      max-width: 1500px;
      margin: 0 auto;
      padding: 16px 20px 40px;
    }

    /* 헤더 */
    header {
      text-align: center;
      padding: 20px 0 16px;
      margin-bottom: 16px;
      position: relative;
    }

    header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 300px;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--gold), transparent);
    }

    .header-title {
      font-family: 'Cinzel Decorative', serif;
      font-size: 22px;
      font-weight: 900;
      letter-spacing: 3px;
      background: linear-gradient(135deg, var(--gold2), var(--gold), #a07828);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .header-sub {
      font-family: 'Rajdhani', sans-serif;
      font-size: 11px;
      color: var(--text3);
      letter-spacing: 4px;
      text-transform: uppercase;
      margin-top: 3px;
    }

    /* 탭 */
    .tabs {
      display: flex;
      gap: 3px;
      background: var(--bg1);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 3px;
      margin-bottom: 16px;
    }

    .tab-btn {
      flex: 1;
      padding: 9px 12px;
      background: transparent;
      border: none;
      color: var(--text2);
      font-family: 'Rajdhani', sans-serif;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 1px;
      cursor: pointer;
      border-radius: 6px;
      transition: all .2s;
      text-transform: uppercase;
    }

    .tab-btn:hover {
      color: var(--text1);
      background: var(--bg2);
    }

    .tab-btn.active {
      background: var(--bg3);
      color: var(--gold);
      border: 1px solid var(--border2);
    }

    /* 패널 */
    .panel {
      background: var(--bg1);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }

    .panel-hd {
      padding: 11px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-title {
      font-family: 'Rajdhani', sans-serif;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 2px;
      color: var(--gold);
      text-transform: uppercase;
    }

    .panel-bd {
      padding: 16px;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 16px;
    }

    .col {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    @media(max-width:900px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    /* 폼 */
    .form-group {
      margin-bottom: 13px;
    }

    .form-label {
      display: block;
      font-family: 'Rajdhani', sans-serif;
      font-size: 10px;
      font-weight: 700;
      color: var(--text2);
      letter-spacing: 2px;
      text-transform: uppercase;
      margin-bottom: 5px;
    }

    .form-input {
      width: 100%;
      padding: 8px 11px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 5px;
      color: var(--text1);
      font-family: 'Noto Sans KR', sans-serif;
      font-size: 12px;
      outline: none;
      transition: border-color .2s;
    }

    .form-input:focus {
      border-color: var(--border3);
      box-shadow: 0 0 0 2px rgba(74, 110, 200, .12);
    }

    .stat-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    /* 티어 버튼 */
    .tier-selector {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .tier-btn {
      flex: 1;
      min-width: 40px;
      padding: 6px 4px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text3);
      border-radius: 5px;
      cursor: pointer;
      font-family: 'Rajdhani', sans-serif;
      font-size: 11px;
      font-weight: 700;
      text-align: center;
      transition: all .2s;
    }

    .tier-btn:hover {
      opacity: .85;
    }

    .tier-btn.active {
      color: #fff !important;
      /* 글자색을 흰색으로 고정 */
      font-weight: 800;
    }

    .tier-btn[data-tier="1"].active {
      background: var(--t1);
      border-color: var(--t1);
    }

    .tier-btn[data-tier="2"].active {
      background: var(--t2);
      border-color: var(--t2);
    }

    .tier-btn[data-tier="3"].active {
      background: var(--t3);
      border-color: var(--t3);
    }

    .tier-btn[data-tier="4"].active {
      background: var(--t4);
      border-color: var(--t4);
    }

    .tier-btn[data-tier="5"].active {
      background: var(--t5);
      border-color: var(--t5);
    }

    .tier-btn[data-tier="6"].active {
      background: var(--t6);
      border-color: var(--t6);
    }

    .tier-btn[data-tier="7"].active {
      background: var(--t7);
      border-color: var(--t7);
      color: #1a0f00 !important;
    }

    /* 버튼 */
    .btn-primary {
      width: 100%;
      padding: 11px;
      background: linear-gradient(135deg, #152040, #1e3060);
      border: 1px solid var(--border3);
      color: var(--gold2);
      font-family: 'Rajdhani', sans-serif;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 2px;
      border-radius: 6px;
      cursor: pointer;
      text-transform: uppercase;
      transition: all .2s;
      position: relative;
      overflow: hidden;
    }

    .btn-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, .05), transparent);
      transition: left .4s;
    }

    .btn-primary:hover::before {
      left: 100%;
    }

    .btn-primary:hover {
      border-color: var(--gold);
      box-shadow: 0 0 16px rgba(232, 184, 75, .15);
      transform: translateY(-1px);
    }

    .btn-danger {
      padding: 4px 9px;
      background: rgba(248, 113, 113, .1);
      border: 1px solid rgba(248, 113, 113, .25);
      color: var(--red);
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Rajdhani', sans-serif;
      font-size: 11px;
      font-weight: 700;
      transition: all .2s;
    }

    .btn-danger:hover {
      background: rgba(248, 113, 113, .25);
    }

    .btn-sm {
      padding: 4px 10px;
      background: rgba(60, 80, 150, .2);
      border: 1px solid var(--border);
      color: var(--silver);
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Rajdhani', sans-serif;
      font-size: 11px;
      font-weight: 700;
      transition: all .2s;
    }

    .btn-sm:hover {
      background: rgba(60, 80, 150, .4);
      border-color: var(--border2);
    }

    /* 강화 버튼 (인벤토리 카드용) */
    .btn-enh {
      padding: 4px 9px;
      background: rgba(249, 115, 22, .1);
      border: 1px solid rgba(249, 115, 22, .3);
      color: #fb923c;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Rajdhani', sans-serif;
      font-size: 11px;
      font-weight: 700;
      transition: all .2s;
      letter-spacing: .5px;
    }

    .btn-enh:hover {
      background: rgba(249, 115, 22, .25);
      border-color: #fb923c;
    }

    /* 슬롯 강화 버튼 */
    .slot-enh-btn {
      margin-top: 5px;
      width: 84px;
      padding: 4px 0;
      background: rgba(249, 115, 22, .12);
      border: 1px solid rgba(249, 115, 22, .35);
      color: #fb923c;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Rajdhani', sans-serif;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: .5px;
      transition: all .2s;
    }

    .slot-enh-btn:hover {
      background: rgba(249, 115, 22, .3);
      border-color: #fb923c;
      box-shadow: 0 0 8px rgba(249, 115, 22, .2);
    }

    /* 세트 도감 아이템 레이아웃 */
    .set-guide-item {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 14px;
      margin-bottom: 12px;
      position: relative;
      transition: border-color 0.2s;
    }

    .set-guide-item:hover {
      border-color: var(--border2);
    }

    /* 세트 도감 내 카드 버튼 스타일 */
    .set-member-btn {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 10px;
      margin: 3px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 5px;
      font-size: 11px;
      color: var(--text2);
      cursor: pointer;
      transition: all 0.2s;
    }

    .set-member-btn.owned {
      border-color: var(--gold);
      color: var(--gold2);
      background: rgba(232, 184, 75, 0.05);
    }

    .set-member-btn:hover {
      border-color: var(--border3);
      background: var(--bg3);
      transform: translateY(-1px);
    }

    /* 세트 장착 전용 버튼 */
    .btn-set-equip {
      padding: 5px 12px;
      background: rgba(60, 80, 150, 0.2);
      border: 1px solid var(--border3);
      color: var(--silver);
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Rajdhani', sans-serif;
      font-size: 11px;
      font-weight: 700;
      transition: all 0.2s;
    }

    .btn-set-equip:hover {
      background: rgba(60, 80, 150, 0.4);
      color: var(--text1);
      border-color: var(--gold);
    }

    /* --- 강화 단계 버튼 전용 디자인 --- */
    /* 1. 기본 상태 */
    .step-btn {
      flex: 1;
      min-width: 40px;
      padding: 8px 4px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text3);
      /* 평소엔 눈에 덜 띄게 */
      border-radius: 5px;
      cursor: pointer;
      font-family: 'Rajdhani', sans-serif;
      font-size: 11px;
      font-weight: 700;
      transition: all 0.2s;
    }

    /* 2. 마우스 올렸을 때 */
    .step-btn:hover:not(.active) {
      background: var(--bg3);
      color: var(--text1);
    }

    /* 3. 클릭해서 선택되었을 때 (가장 중요) */
    .step-btn.active {
      background: rgba(232, 184, 75, 0.2) !important;
      /* 은은한 골드 배경 */
      color: var(--gold2) !important;
      /* 폰트를 골드색으로 고정 (검정 방지) */
      border: 1px solid var(--gold) !important;
      /* 테두리 강조 */
      text-shadow: 0 0 8px rgba(232, 184, 75, 0.6);
      /* 글자 발광 효과 */
      box-shadow: inset 0 0 10px rgba(232, 184, 75, 0.1);
    }

    /* =========================================
   카드 툴팁 오버레이
   ========================================= */
    .card-tooltip-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .65);
      backdrop-filter: blur(3px);
      -webkit-backdrop-filter: blur(3px);
      z-index: 600;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .card-tooltip-overlay.open {
      display: flex;
      animation: fadeInOverlay .18s ease;
    }

    .card-tooltip-modal {
      background: var(--bg1);
      border: 1px solid var(--border2);
      border-radius: 14px;
      width: 360px;
      max-width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      animation: slideUp .2s cubic-bezier(.16, 1, .3, 1);
    }

    .card-tooltip-modal::-webkit-scrollbar {
      width: 3px;
    }

    .card-tooltip-modal::-webkit-scrollbar-thumb {
      background: var(--border);
    }

    /* 툴팁 헤더 */
    .ctt-header {
      padding: 20px 20px 16px;
      display: flex;
      align-items: center;
      gap: 16px;
      border-bottom: 1px solid var(--border);
      position: relative;
    }

    .ctt-big-icon {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      flex-shrink: 0;
      border: 2px solid;
    }

    .ctt-title-block {
      flex: 1;
    }

    .ctt-name {
      font-size: 16px;
      font-weight: 700;
      color: var(--text1);
      margin-bottom: 3px;
    }

    .ctt-sub {
      font-family: 'Rajdhani', sans-serif;
      font-size: 10px;
      letter-spacing: 1.5px;
      margin-bottom: 6px;
    }

    .ctt-close-hint {
      position: absolute;
      top: 12px;
      right: 14px;
      font-family: 'Rajdhani', sans-serif;
      font-size: 9px;
      color: var(--text3);
      letter-spacing: 1px;
    }

    /* 툴팁 바디 */
    .ctt-body {
      padding: 14px 20px;
    }

    .ctt-section-label {
      font-family: 'Rajdhani', sans-serif;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 2px;
      color: var(--text3);
      text-transform: uppercase;
      margin-bottom: 8px;
      margin-top: 14px;
    }

    .ctt-section-label:first-child {
      margin-top: 0;
    }

    .ctt-stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 8px;
      border-radius: 5px;
      background: rgba(255, 255, 255, .02);
      border: 1px solid var(--border);
      margin-bottom: 4px;
    }

    .ctt-stat-name {
      font-family: 'Rajdhani', sans-serif;
      font-size: 10px;
      color: var(--text2);
    }

    .ctt-stat-val {
      font-family: 'Rajdhani', sans-serif;
      font-size: 12px;
      font-weight: 700;
      color: var(--gold2);
    }

    /* 업그레이드 단계 테이블 */
    .ctt-upgrade-table {
      width: 100%;
      border-collapse: collapse;
      font-family: 'Rajdhani', sans-serif;
      font-size: 10px;
    }

    .ctt-upgrade-table th {
      color: var(--text3);
      font-weight: 700;
      letter-spacing: 1px;
      padding: 4px 8px;
      border-bottom: 1px solid var(--border);
      text-align: center;
    }

    .ctt-upgrade-table td {
      padding: 4px 8px;
      text-align: center;
      border-bottom: 1px solid rgba(30, 42, 61, .4);
    }

    .ctt-upgrade-table tr:last-child td {
      border-bottom: none;
    }

    .ctt-upgrade-table tr.active-step td {
      background: rgba(232, 184, 75, .06);
      color: var(--gold2);
      font-weight: 700;
    }

    .ctt-upgrade-table td:first-child {
      color: var(--text3);
    }

    /* 세트 효과 칩 */
    .ctt-set-effects {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .ctt-set-row {
      padding: 7px 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
    }

    .ctt-set-type {
      font-family: 'Rajdhani', sans-serif;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 1px;
      margin-bottom: 3px;
    }

    .ctt-set-desc {
      font-size: 10px;
      color: var(--text2);
      line-height: 1.5;
    }

    /* 툴팁 푸터 (액션 버튼) */
    .ctt-footer {
      padding: 14px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
    }

    .btn-export {
      padding: 4px 10px;
      background: rgba(52, 211, 153, .1);
      border: 1px solid rgba(52, 211, 153, .25);
      color: var(--green);
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Rajdhani', sans-serif;
      font-size: 11px;
      font-weight: 700;
      transition: all .2s;
      letter-spacing: .5px;
    }

    .btn-export:hover {
      background: rgba(52, 211, 153, .25);
      border-color: var(--green);
    }

    .btn-import {
      padding: 4px 10px;
      background: rgba(56, 189, 248, .1);
      border: 1px solid rgba(56, 189, 248, .25);
      color: var(--t3);
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Rajdhani', sans-serif;
      font-size: 11px;
      font-weight: 700;
      transition: all .2s;
      letter-spacing: .5px;
    }

    .btn-import:hover {
      background: rgba(56, 189, 248, .25);
      border-color: var(--t3);
    }

    /* 카드 아이템 */
    .card-item {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 7px;
      padding: 12px 14px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      cursor: pointer;
      transition: all .2s;
      position: relative;
      user-select: none;
      min-height: auto !important;
      height: auto !important;
    }

    .card-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 3px;
      height: 100%;
    }

    .card-item[data-tier="1"]::before {
      background: var(--t1);
    }

    .card-item[data-tier="2"]::before {
      background: var(--t2);
    }

    .card-item[data-tier="3"]::before {
      background: var(--t3);
    }

    .card-item[data-tier="4"]::before {
      background: var(--t4);
    }

    .card-item[data-tier="5"]::before {
      background: var(--t5);
    }

    .card-item[data-tier="6"]::before {
      background: var(--t6);
    }

    .card-item[data-tier="7"]::before {
      background: var(--t7);
      box-shadow: 0 0 8px var(--t7g);
    }

    .card-item:hover {
      background: var(--bg3);
      border-color: var(--border2);
      transform: translateX(2px);
    }

    .card-item.dragging {
      opacity: .35;
      transform: scale(.97);
    }

    .card-item.equipped {
      border-color: var(--green);
      background: rgba(52, 211, 153, .04);
    }

    .card-icon {
      width: 46px;
      height: 46px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
      background: rgba(255, 255, 255, .03);
      border: 1px solid var(--border);
    }

    .card-info {
      flex: 1;
      min-width: 0;
    }

    .card-tier-badge {
      font-family: 'Rajdhani', sans-serif;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 1px;
      padding: 1px 5px;
      border-radius: 3px;
      display: inline-block;
      margin-bottom: 2px;
    }

    .tb1 {
      background: rgba(156, 163, 175, .15);
      color: var(--t1);
      border: 1px solid rgba(156, 163, 175, .2);
    }

    .tb2 {
      background: rgba(74, 222, 128, .12);
      color: var(--t2);
      border: 1px solid rgba(74, 222, 128, .2);
    }

    .tb3 {
      background: rgba(56, 189, 248, .12);
      color: var(--t3);
      border: 1px solid rgba(56, 189, 248, .2);
    }

    .tb4 {
      background: rgba(167, 139, 250, .12);
      color: var(--t4);
      border: 1px solid rgba(167, 139, 250, .2);
    }

    .tb5 {
      background: rgba(249, 115, 22, .12);
      color: var(--t5);
      border: 1px solid rgba(249, 115, 22, .2);
    }

    .tb6 {
      background: rgba(244, 63, 94, .12);
      color: var(--t6);
      border: 1px solid rgba(244, 63, 94, .2);
    }

    .tb7 {
      background: rgba(251, 191, 36, .15);
      color: var(--t7);
      border: 1px solid rgba(251, 191, 36, .3);
    }

    .card-name {
      font-size: 12px;
      font-weight: 700;
      color: var(--text1);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .card-stats-row {
      font-size: 9px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 3px;
    }

    .stat-chip {
      padding: 1px 5px;
      background: rgba(255, 255, 255, .03);
      border: 1px solid var(--border);
      border-radius: 3px;
      font-size: 9px;
    }

    .stat-chip.hp {
      color: #f87171;
    }

    .stat-chip.atk {
      color: #fb923c;
    }

    .stat-chip.def {
      color: #60a5fa;
    }

    .stat-chip.spd {
      color: #4ade80;
    }

    .stat-chip.crit {
      color: #ff8a65;
    }

    .stat-chip.crit_dmg {
      color: #fbbf24;
    }

    /* 강화 배지 */
    .enh-badge {
      font-family: 'Rajdhani', sans-serif;
      font-size: 10px;
      font-weight: 700;
      padding: 1px 6px;
      border-radius: 3px;
      background: rgba(255, 255, 255, .05);
      border: 1px solid var(--border);
      color: var(--text3);
      white-space: nowrap;
      flex-shrink: 0;
    }

    .enh-badge.lv1 {
      color: var(--e1);
      border-color: rgba(74, 222, 128, .3);
      background: rgba(74, 222, 128, .08);
    }

    .enh-badge.lv2 {
      color: var(--e2);
      border-color: rgba(56, 189, 248, .3);
      background: rgba(56, 189, 248, .08);
    }

    .enh-badge.lv3 {
      color: var(--e3);
      border-color: rgba(167, 139, 250, .3);
      background: rgba(167, 139, 250, .08);
    }

    .enh-badge.lv4 {
      color: var(--e4);
      border-color: rgba(249, 115, 22, .3);
      background: rgba(249, 115, 22, .08);
    }

    .enh-badge.lv5 {
      color: var(--e5);
      border-color: rgba(244, 63, 94, .3);
      background: rgba(244, 63, 94, .08);
      animation: glow5 2s ease-in-out infinite;
    }

    @keyframes glow5 {

      0%,
      100% {
        box-shadow: 0 0 4px rgba(244, 63, 94, .2);
      }

      50% {
        box-shadow: 0 0 10px rgba(244, 63, 94, .5);
      }
    }

    /* 카드 목록 스크롤 */
    .card-list {
      display: flex;
      flex-direction: column;
      gap: 5px;
      max-height: calc(100vh - 350px) !important;
      overflow-y: auto;
      padding-right: 6px;
    }

    .card-list::-webkit-scrollbar {
      width: 3px;
    }

    .card-list::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 2px;
    }

    /* 슬롯 */
    .slots-grid {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .slot {
      width: 122px;
      min-height: 155px;
      background: var(--bg2);
      border: 2px dashed var(--border);
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all .25s;
      position: relative;
      overflow: hidden;
    }

    .slot.drag-over {
      border-color: var(--gold);
      background: rgba(232, 184, 75, .05);
      box-shadow: 0 0 16px rgba(232, 184, 75, .1) inset;
    }

    .slot.filled {
      border-style: solid;
      cursor: pointer;
    }

    .slot.filled:hover {
      filter: brightness(1.1);
    }

    .slot.filled[data-tier="1"] {
      border-color: var(--t1);
    }

    .slot.filled[data-tier="2"] {
      border-color: var(--t2);
    }

    .slot.filled[data-tier="3"] {
      border-color: var(--t3);
    }

    .slot.filled[data-tier="4"] {
      border-color: var(--t4);
    }

    .slot.filled[data-tier="5"] {
      border-color: var(--t5);
    }

    .slot.filled[data-tier="6"] {
      border-color: var(--t6);
    }

    .slot.filled[data-tier="7"] {
      border-color: var(--t7);
      box-shadow: 0 0 10px var(--t7g) inset;
    }

    .slot-num {
      font-family: 'Rajdhani', sans-serif;
      font-size: 9px;
      font-weight: 700;
      color: var(--text3);
      letter-spacing: 2px;
      position: absolute;
      top: 7px;
      left: 9px;
    }

    .slot-empty-ico {
      font-size: 26px;
      opacity: .1;
      margin-bottom: 6px;
    }

    .slot-empty-txt {
      font-family: 'Rajdhani', sans-serif;
      font-size: 9px;
      color: var(--text3);
      letter-spacing: 1px;
      text-align: center;
      padding: 0 8px;
    }

    .slot-ico {
      font-size: 32px;
      margin-bottom: 6px;
    }

    .slot-name {
      font-size: 10px;
      font-weight: 700;
      color: var(--text1);
      text-align: center;
      padding: 0 6px;
      line-height: 1.3;
    }

    .slot-tier {
      font-family: 'Rajdhani', sans-serif;
      font-size: 9px;
      font-weight: 700;
      margin: 2px 0 4px;
    }

    .slot-stats {
      font-size: 8px;
      color: var(--text2);
      text-align: center;
      line-height: 1.6;
    }

    .slot-enh {
      font-family: 'Rajdhani', sans-serif;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: .5px;
      margin-bottom: 3px;
    }

    .slot-remove {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 17px;
      height: 17px;
      background: rgba(248, 113, 113, .15);
      border: 1px solid rgba(248, 113, 113, .25);
      color: var(--red);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 9px;
      transition: all .2s;
      opacity: 0;
      z-index: 2;
    }

    .slot.filled:hover .slot-remove {
      opacity: 1;
    }

    .slot-remove:hover {
      background: rgba(248, 113, 113, .4);
    }

    /* 효과 합산 */
    .set-area {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 14px;
    }

    .set-area-title {
      font-family: 'Rajdhani', sans-serif;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 2px;
      color: var(--text3);
      text-transform: uppercase;
      margin-bottom: 10px;
    }

    .eff-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 5px;
      margin-bottom: 5px;
      border: 1px solid transparent;
    }

    .eff-row.ind {
      background: rgba(255, 255, 255, .015);
      border-color: var(--border);
    }

    .eff-row.sp {
      background: rgba(61, 184, 122, .05);
      border-color: rgba(61, 184, 122, .15);
    }

    .eff-row.st {
      background: rgba(34, 211, 238, .05);
      border-color: rgba(34, 211, 238, .15);
    }

    .eff-row.tr {
      background: rgba(232, 184, 75, .05);
      border-color: rgba(232, 184, 75, .15);
    }

    .eff-row.fh {
      background: rgba(167, 139, 250, .05);
      border-color: rgba(167, 139, 250, .15);
    }

    .eff-row.str {
      background: rgba(248, 113, 113, .07);
      border-color: rgba(248, 113, 113, .2);
    }

    .eff-badge {
      font-family: 'Rajdhani', sans-serif;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 1px;
      padding: 1px 6px;
      border-radius: 3px;
      flex-shrink: 0;
      white-space: nowrap;
      margin-top: 1px;
    }

    .eff-label {
      font-size: 11px;
      font-weight: 700;
      color: var(--text1);
      margin-bottom: 2px;
    }

    .eff-desc {
      font-size: 10px;
      color: var(--text2);
      line-height: 1.5;
    }

    .eff-stats {
      font-size: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 3px;
    }

    .eff-stat-chip {
      padding: 1px 6px;
      border-radius: 3px;
      font-weight: 700;
      font-size: 9px;
      background: rgba(52, 211, 153, .12);
      color: var(--green);
      border: 1px solid rgba(52, 211, 153, .18);
    }

    .total-stats {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 7px;
      padding: 12px 14px;
      margin-top: 10px;
    }

    .total-stats-title {
      font-family: 'Rajdhani', sans-serif;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 2px;
      color: var(--gold);
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .total-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }

    .total-item {
      background: rgba(255, 255, 255, .02);
      border: 1px solid var(--border);
      border-radius: 5px;
      padding: 7px 8px;
      text-align: center;
    }

    .total-name {
      font-family: 'Rajdhani', sans-serif;
      font-size: 8px;
      color: var(--text3);
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-bottom: 2px;
    }

    .total-val {
      font-family: 'Rajdhani', sans-serif;
      font-size: 17px;
      font-weight: 700;
      line-height: 1;
    }

    .total-val.hp {
      color: #f87171;
    }

    .total-val.atk {
      color: #fb923c;
    }

    .total-val.def {
      color: #60a5fa;
    }

    .total-val.spd {
      color: #4ade80;
    }

    .total-val.crit {
      color: #ff8a65;
    }

    .total-val.crit_dmg {
      color: #fbbf24;
    }

    /* 빈 상태 */
    .empty {
      text-align: center;
      padding: 32px 16px;
      color: var(--text3);
      font-size: 11px;
      letter-spacing: 1px;
    }

    .empty-ico {
      font-size: 30px;
      opacity: .25;
      margin-bottom: 8px;
    }

    /* 구분선 */
    .divider {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 14px 0;
    }

    .divider-line {
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .divider-txt {
      font-family: 'Rajdhani', sans-serif;
      font-size: 9px;
      color: var(--text3);
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    /* 아이콘 선택 */
    .icon-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }

    .icon-btn {
      width: 34px;
      height: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      border-radius: 5px;
      cursor: pointer;
      transition: all .15s;
      background: rgba(255, 255, 255, .02);
      border: 1px solid var(--border);
    }

    .icon-btn.active {
      background: rgba(60, 80, 150, .3);
      border-color: var(--border3);
    }

    .icon-btn:hover {
      background: rgba(60, 80, 150, .2);
    }

    /* 필터 */
    .filter-bar {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .filter-chip {
      padding: 3px 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text3);
      border-radius: 20px;
      cursor: pointer;
      font-family: 'Rajdhani', sans-serif;
      font-size: 10px;
      font-weight: 700;
      transition: all .2s;
    }

    .filter-chip:hover {
      color: var(--text1);
    }

    .filter-chip.active {
      background: rgba(60, 80, 150, .2);
      border-color: var(--border3);
      color: var(--silver);
    }

    /* 세트 목록 */
    .set-card-item {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 14px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all .2s;
      position: relative;
    }

    .set-card-item:hover {
      border-color: var(--border2);
      transform: translateX(2px);
    }

    .set-card-item.type-pair {
      border-left: 3px solid var(--pair-c);
    }

    .set-card-item.type-twopair {
      border-left: 3px solid var(--twopair-c);
    }

    .set-card-item.type-triple {
      border-left: 3px solid var(--triple-c);
    }

    .set-card-item.type-fullhouse {
      border-left: 3px solid var(--fullhouse-c);
    }

    .set-card-item.type-straight {
      border-left: 3px solid var(--straight-c);
    }

    .set-card-item.type-none {
      border-left: 3px solid var(--text3);
    }

    .set-hd {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .set-rank {
      font-family: 'Rajdhani', sans-serif;
      font-size: 11px;
      font-weight: 700;
      color: var(--text3);
    }

    .set-score {
      margin-left: auto;
      font-family: 'Rajdhani', sans-serif;
      font-size: 11px;
      font-weight: 700;
      color: var(--gold);
      background: rgba(232, 184, 75, .08);
      border: 1px solid rgba(232, 184, 75, .18);
      padding: 1px 8px;
      border-radius: 4px;
    }

    .set-chips {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
      margin-bottom: 7px;
    }

    .set-chip {
      display: flex;
      align-items: center;
      gap: 3px;
      padding: 2px 7px;
      background: rgba(255, 255, 255, .02);
      border: 1px solid var(--border);
      border-radius: 3px;
      font-size: 9px;
      color: var(--text2);
    }

    .set-eff-chips {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    .set-eff-chip {
      font-family: 'Rajdhani', sans-serif;
      font-size: 9px;
      font-weight: 700;
      padding: 2px 7px;
      border-radius: 3px;
    }

    .set-apply {
      position: absolute;
      right: 10px;
      bottom: 10px;
      padding: 4px 12px;
      background: rgba(60, 80, 150, .2);
      border: 1px solid var(--border2);
      color: var(--silver);
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Rajdhani', sans-serif;
      font-size: 10px;
      font-weight: 700;
      transition: all .2s;
    }

    .set-apply:hover {
      background: rgba(60, 80, 150, .4);
      color: var(--text1);
    }

    /* =========================================
   강화 config 탭
   ========================================= */
    .config-section-title {
      font-family: 'Rajdhani', sans-serif;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 2px;
      color: var(--text3);
      text-transform: uppercase;
      margin-bottom: 12px;
    }

    .config-table {
      width: 100%;
      border-collapse: collapse;
    }

    .config-table th {
      font-family: 'Rajdhani', sans-serif;
      font-size: 9px;
      font-weight: 700;
      color: var(--text3);
      letter-spacing: 1px;
      text-align: center;
      padding: 6px 10px;
      border-bottom: 1px solid var(--border);
      text-transform: uppercase;
    }

    .config-table td {
      padding: 7px 10px;
      text-align: center;
      border-bottom: 1px solid rgba(30, 42, 61, .5);
    }

    .config-table tr:last-child td {
      border-bottom: none;
    }

    .config-table tr:hover td {
      background: rgba(255, 255, 255, .015);
    }

    .config-lv-label {
      font-family: 'Rajdhani', sans-serif;
      font-size: 12px;
      font-weight: 700;
    }

    .config-input {
      width: 64px;
      padding: 5px 8px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text1);
      font-family: 'Rajdhani', sans-serif;
      font-size: 12px;
      font-weight: 700;
      text-align: center;
      outline: none;
      transition: all .2s;
    }

    .config-input:focus {
      border-color: var(--border3);
      box-shadow: 0 0 0 2px rgba(74, 110, 200, .1);
    }

    .prob-bar-wrap {
      width: 80px;
      height: 6px;
      background: var(--bg);
      border-radius: 3px;
      overflow: hidden;
      display: inline-block;
      vertical-align: middle;
      margin-left: 6px;
    }

    .prob-bar {
      height: 100%;
      border-radius: 3px;
      transition: width .3s;
    }

    .config-note {
      font-size: 10px;
      color: var(--text3);
      line-height: 1.7;
      font-family: 'Rajdhani', sans-serif;
      padding: 12px 14px;
      background: rgba(255, 255, 255, .02);
      border-radius: 6px;
      border: 1px solid var(--border);
      margin-top: 16px;
    }

    /* =========================================
   강화 오버레이
   ========================================= */
    .enh-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .75);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      z-index: 700;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .enh-overlay.open {
      display: flex;
      animation: fadeInOverlay .2s ease;
    }

    @keyframes fadeInOverlay {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .enh-modal {
      background: var(--bg1);
      border: 1px solid var(--border2);
      border-radius: 16px;
      width: 480px;
      max-width: 100%;
      /* 모바일에서 너무 꽉 차지 않도록 약간의 여유 부여 */
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      /* 내부 요소들을 세로로 정렬 */
      overflow: hidden;
      /* 모달 자체 스크롤은 막고 내부 바디에 부여 */
      position: relative;
      animation: slideUp .25s cubic-bezier(.16, 1, .3, 1);
    }

    .enh-modal::-webkit-scrollbar {
      width: 3px;
    }

    .enh-modal::-webkit-scrollbar-thumb {
      background: var(--border);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* 모달 상단 카드 헤더 */
    .enh-card-header {
      padding: 24px 24px 20px;
      display: flex;
      align-items: center;
      gap: 18px;
      position: relative;
    }

    .enh-card-header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 24px;
      right: 24px;
      height: 1px;
      background: var(--border);
    }

    .enh-card-big-icon {
      width: 64px;
      height: 64px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 34px;
      flex-shrink: 0;
      border: 2px solid;
      position: relative;
    }

    .enh-card-header-info {
      flex: 1;
    }

    .enh-card-header-name {
      font-size: 17px;
      font-weight: 700;
      color: var(--text1);
      margin-bottom: 3px;
    }

    .enh-card-header-sub {
      font-family: 'Rajdhani', sans-serif;
      font-size: 11px;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    /* 레벨 파이프 */
    .lv-bar {
      display: flex;
      gap: 5px;
      align-items: center;
    }

    .lv-pip {
      width: 32px;
      height: 7px;
      border-radius: 4px;
      background: var(--bg);
      border: 1px solid var(--border);
      transition: all .3s;
    }

    .lv-pip.filled {
      border-color: transparent;
    }

    .lv-pip.p1 {
      background: var(--e1);
    }

    .lv-pip.p2 {
      background: var(--e2);
    }

    .lv-pip.p3 {
      background: var(--e3);
    }

    .lv-pip.p4 {
      background: var(--e4);
    }

    .lv-pip.p5 {
      background: var(--e5);
      animation: pipGlow5 1.5s ease-in-out infinite;
    }

    @keyframes pipGlow5 {

      0%,
      100% {
        box-shadow: 0 0 4px rgba(244, 63, 94, .3);
      }

      50% {
        box-shadow: 0 0 10px rgba(244, 63, 94, .7);
      }
    }

    .lv-label {
      font-family: 'Rajdhani', sans-serif;
      font-size: 11px;
      font-weight: 700;
      color: var(--text3);
      letter-spacing: 1px;
    }

    .enh-modal-close {
      position: absolute;
      top: 14px;
      right: 16px;
      width: 26px;
      height: 26px;
      background: rgba(255, 255, 255, .05);
      border: 1px solid var(--border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
      color: var(--text3);
      transition: all .2s;
      line-height: 1;
    }

    .enh-modal-close:hover {
      color: var(--text1);
      background: rgba(255, 255, 255, .1);
    }

    /* 확률 섹션 */
    .enh-section {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
    }

    .enh-section-label {
      font-family: 'Rajdhani', sans-serif;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 2px;
      color: var(--text3);
      text-transform: uppercase;
      margin-bottom: 10px;
    }

    .prob-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .prob-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      text-align: center;
    }

    .prob-card-label {
      font-family: 'Rajdhani', sans-serif;
      font-size: 9px;
      letter-spacing: 1px;
      color: var(--text3);
      margin-bottom: 4px;
    }

    .prob-card-val {
      font-family: 'Rajdhani', sans-serif;
      font-size: 22px;
      font-weight: 700;
      line-height: 1;
    }

    .prob-card-val.succ {
      color: var(--green);
    }

    .prob-card-val.fail {
      color: var(--red);
    }

    .prob-card-val.dest {
      color: #ff3030;
    }

    /* 스탯 비교 섹션 */
    .stat-compare-grid {
      display: grid;
      gap: 6px;
    }

    .stat-compare-row {
      display: grid;
      grid-template-columns: 80px 1fr 24px 1fr;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
    }

    .stat-cmp-name {
      font-family: 'Rajdhani', sans-serif;
      font-size: 10px;
      color: var(--text3);
      letter-spacing: 1px;
    }

    .stat-cmp-before {
      font-family: 'Rajdhani', sans-serif;
      font-size: 12px;
      font-weight: 700;
      color: var(--text2);
      text-align: right;
    }

    .stat-cmp-arrow {
      font-size: 10px;
      color: var(--text3);
      text-align: center;
    }

    .stat-cmp-after {
      font-family: 'Rajdhani', sans-serif;
      font-size: 13px;
      font-weight: 700;
      text-align: left;
    }

    .stat-cmp-after.up {
      color: var(--green);
    }

    .stat-cmp-diff {
      font-family: 'Rajdhani', sans-serif;
      font-size: 9px;
      color: var(--green);
      margin-left: 3px;
    }

    /* 강화 버튼 섹션 */
    .enh-action {
      padding: 20px 24px 24px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .btn-enhance {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #1a0a00, #3a1800);
      border: 1px solid rgba(249, 115, 22, .45);
      color: #fb923c;
      font-family: 'Rajdhani', sans-serif;
      font-size: 15px;
      font-weight: 700;
      letter-spacing: 2px;
      border-radius: 8px;
      cursor: pointer;
      text-transform: uppercase;
      transition: all .25s;
      position: relative;
      overflow: hidden;
    }

    .btn-enhance::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(249, 115, 22, .08), transparent);
      transition: left .4s;
    }

    .btn-enhance:hover:not(:disabled)::before {
      left: 100%;
    }

    .btn-enhance:hover:not(:disabled) {
      box-shadow: 0 0 24px rgba(249, 115, 22, .25);
      border-color: rgba(249, 115, 22, .8);
      transform: translateY(-1px);
    }

    .btn-enhance:disabled {
      opacity: .3;
      cursor: not-allowed;
      transform: none;
    }

    .btn-enhance.max {
      background: linear-gradient(135deg, #1a1000, #3a2800);
      border-color: rgba(251, 191, 36, .4);
      color: var(--t7);
      cursor: not-allowed;
    }

    .enh-action-note {
      font-family: 'Rajdhani', sans-serif;
      font-size: 10px;
      color: var(--text3);
      text-align: center;
      line-height: 1.6;
      letter-spacing: .5px;
    }

    /* =========================================
   강화 결과 팝업
   ========================================= */
    .result-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .85);
      z-index: 800;
      align-items: center;
      justify-content: center;
    }

    .result-overlay.show {
      display: flex;
    }

    .result-box {
      background: var(--bg1);
      border: 1px solid var(--border2);
      border-radius: 16px;
      width: 340px;
      max-width: 95vw;
      text-align: center;
      padding: 36px 28px 28px;
      position: relative;
      overflow: hidden;
    }

    .result-box.suc {
      border-color: rgba(52, 211, 153, .4);
    }

    .result-box.fail {
      border-color: rgba(248, 113, 113, .3);
    }

    .result-box.dest {
      border-color: rgba(248, 113, 113, .6);
    }

    .result-ico {
      font-size: 56px;
      margin-bottom: 10px;
    }

    .result-title {
      font-family: 'Cinzel Decorative', serif;
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: 2px;
    }

    .result-title.s {
      color: var(--green);
    }

    .result-title.f {
      color: var(--red);
    }

    .result-title.d {
      color: #ff2020;
      text-shadow: 0 0 20px rgba(255, 32, 32, .5);
    }

    .result-desc {
      font-size: 12px;
      color: var(--text2);
      margin-bottom: 20px;
      line-height: 1.7;
    }

    .sparks {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
    }

    .spark {
      position: absolute;
      width: 5px;
      height: 5px;
      border-radius: 50%;
      animation: spk .7s ease-out forwards;
    }

    @keyframes spk {
      0% {
        opacity: 1;
        transform: translate(0, 0) scale(1);
      }

      100% {
        opacity: 0;
        transform: translate(var(--tx), var(--ty)) scale(0);
      }
    }

    /* 강화 로그 */
    .enh-log {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 7px;
      padding: 10px 12px;
      max-height: 150px;
      overflow-y: auto;
    }

    .enh-log::-webkit-scrollbar {
      width: 3px;
    }

    .enh-log::-webkit-scrollbar-thumb {
      background: var(--border);
    }

    .log-row {
      font-size: 10px;
      padding: 3px 0;
      border-bottom: 1px solid rgba(30, 42, 61, .4);
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .log-row:last-child {
      border-bottom: none;
    }

    .log-time {
      color: var(--text3);
      font-family: 'Rajdhani', sans-serif;
      font-size: 9px;
      flex-shrink: 0;
    }

    .log-txt.ok {
      color: var(--green);
    }

    .log-txt.fail {
      color: var(--text2);
    }

    .log-txt.dest {
      color: var(--red);
    }

    /* 카드 선택 모달 (슬롯용) */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .7);
      z-index: 500;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal-inner {
      background: var(--bg1);
      border: 1px solid var(--border2);
      border-radius: 12px;
      width: 480px;
      max-width: 95vw;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .modal-hd {
      padding: 13px 18px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-family: 'Rajdhani', sans-serif;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 1px;
      color: var(--gold);
    }

    .modal-close-btn {
      background: none;
      border: none;
      color: var(--text3);
      cursor: pointer;
      font-size: 18px;
      padding: 0 4px;
      transition: color .2s;
    }

    .modal-close-btn:hover {
      color: var(--text1);
    }

    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 14px;
    }

    .modal-body .card-list {
      max-height: none;
    }

    /* =========================================
   세트 정의 UI
   ========================================= */
    .set-def-card {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 14px;
      margin-bottom: 8px;
      position: relative;
    }

    .set-def-card.grade-pair {
      border-left: 3px solid var(--pair-c);
    }

    .set-def-card.grade-triple {
      border-left: 3px solid var(--triple-c);
    }

    .set-def-card.grade-straight {
      border-left: 3px solid var(--straight-c);
    }

    .set-def-name {
      font-size: 13px;
      font-weight: 700;
      color: var(--text1);
      margin-bottom: 4px;
    }

    .set-def-grade {
      font-family: 'Rajdhani', sans-serif;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 1px;
      padding: 1px 6px;
      border-radius: 3px;
      display: inline-block;
      margin-bottom: 6px;
    }

    .set-def-members {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 6px;
    }

    .set-def-chip {
      font-family: 'Rajdhani', sans-serif;
      font-size: 10px;
      padding: 2px 7px;
      background: rgba(255, 255, 255, .04);
      border: 1px solid var(--border2);
      border-radius: 4px;
      color: var(--text2);
    }

    .set-def-desc {
      font-size: 10px;
      color: var(--text2);
      line-height: 1.5;
      margin-bottom: 6px;
    }

    .set-def-effect {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 8px;
    }

    .set-def-efx-chip {
      font-size: 9px;
      padding: 1px 6px;
      background: rgba(52, 211, 153, .08);
      border: 1px solid rgba(52, 211, 153, .2);
      border-radius: 3px;
      color: var(--green);
      font-family: 'Rajdhani', sans-serif;
      font-weight: 700;
    }

    .set-def-actions {
      display: flex;
      gap: 6px;
    }

    .set-def-active {
      border-color: var(--gold);
      background: rgba(232, 184, 75, .04);
    }

    .set-def-active-badge {
      font-family: 'Rajdhani', sans-serif;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 1px;
      color: var(--gold);
      padding: 1px 6px;
      background: rgba(232, 184, 75, .12);
      border: 1px solid rgba(232, 184, 75, .3);
      border-radius: 3px;
      position: absolute;
      top: 10px;
      right: 10px;
    }

    /* 카드 선택 피커 */
    .card-picker-chip {
      font-family: 'Rajdhani', sans-serif;
      font-size: 10px;
      padding: 4px 8px;
      background: rgba(255, 255, 255, .03);
      border: 1px solid var(--border);
      border-radius: 5px;
      cursor: pointer;
      transition: all .15s;
      color: var(--text2);
    }

    .card-picker-chip:hover {
      border-color: var(--border2);
      color: var(--text1);
    }

    .card-picker-chip.selected {
      background: rgba(96, 165, 250, .12);
      border-color: var(--blue);
      color: var(--blue);
    }

    .card-picker-chip.disabled {
      opacity: .3;
      cursor: not-allowed;
    }

    /* 폼 보너스 스탯 행 */
    .sf-stat-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 8px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 5px;
      font-size: 10px;
    }

    .sf-stat-row-name {
      color: var(--text2);
      font-family: 'Rajdhani', sans-serif;
    }

    .sf-stat-row-val {
      color: var(--gold2);
      font-family: 'Rajdhani', sans-serif;
      font-weight: 700;
    }

    /* 발동 중인 세트 효과 행 */
    .active-set-row {
      padding: 10px 12px;
      border-radius: 7px;
      border: 1px solid var(--border);
      margin-bottom: 6px;
      background: rgba(255, 255, 255, .02);
    }

    .active-set-row.grade-pair {
      border-left: 3px solid var(--pair-c);
    }

    .active-set-row.grade-triple {
      border-left: 3px solid var(--triple-c);
    }

    .active-set-row.grade-straight {
      border-left: 3px solid var(--straight-c);
    }

    .active-set-name {
      font-size: 12px;
      font-weight: 700;
      color: var(--text1);
      margin-bottom: 3px;
    }

    .active-set-desc {
      font-size: 10px;
      color: var(--text2);
      line-height: 1.5;
    }

    .active-set-bonus {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 5px;
    }

    /* 발동 예정 세트 스타일 */
    .potential-set-row {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px dashed var(--border2);
      margin-bottom: 6px;
      background: rgba(255, 255, 255, 0.02);
    }

    .potential-badge {
      font-family: 'Rajdhani', sans-serif;
      font-size: 8px;
      font-weight: 700;
      padding: 1px 5px;
      background: var(--bg3);
      color: var(--text3);
      border: 1px solid var(--border);
      border-radius: 3px;
      white-space: nowrap;
    }

    .needed-card {
      color: var(--gold);
      font-weight: bold;
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    /* grade radio */
    /* 세트 등급 버튼 기본 스타일 */
    .grade-radio-label {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      padding: 8px 5px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 5px;
      cursor: pointer;
      font-size: 11px;
      font-family: 'Rajdhani', sans-serif;
      font-weight: 700;
      transition: all 0.2s;
      color: var(--text3);
      /* 기본 상태는 흐릿하게 */
    }

    .grade-radio-label:hover {
      border-color: var(--border2);
      background: var(--bg2);
    }

    /* 라디오 버튼이 체크되었을 때 부모 label 강조 (핵심) */
    .grade-radio-label:has(input:checked) {
      background: rgba(232, 184, 75, 0.15) !important;
      /* 은은한 골드 배경 */
      border: 1px solid var(--gold) !important;
      /* 골드 테두리 */
      box-shadow: inset 0 0 8px rgba(232, 184, 75, 0.1);
    }

    /* 체크된 버튼 내부의 글자색 유지 */
    .grade-radio-label:has(input[value="pair"]:checked) span {
      color: var(--pair-c) !important;
    }

    .grade-radio-label:has(input[value="triple"]:checked) span {
      color: var(--triple-c) !important;
    }

    .grade-radio-label:has(input[value="straight"]:checked) span {
      color: var(--straight-c) !important;
    }

    /* 실제 라디오 input은 숨김 */
    .grade-radio-label input {
      display: none;
    }

    #toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(16px);
      background: var(--bg1);
      border: 1px solid var(--border);
      color: var(--text1);
      padding: 9px 18px;
      border-radius: 6px;
      font-size: 11px;
      letter-spacing: .5px;
      opacity: 0;
      transition: all .3s;
      z-index: 1000;
      pointer-events: none;
      font-family: 'Rajdhani', sans-serif;
      font-weight: 700;
    }

    #toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    #toast.ok {
      border-color: var(--green);
      color: var(--green);
    }

    #toast.err {
      border-color: var(--red);
      color: var(--red);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(6px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .ani {
      animation: fadeIn .2s ease forwards;
    }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="header-title">MONSTER CARD SYSTEM</div>
      <div class="header-sub">Prototype v3.0 · Game Design Tool</div>
    </header>

    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab(&#39;equip&#39;)">⚔️ 카드 장착</button>
      <button class="tab-btn" onclick="switchTab(&#39;create&#39;)">✨ 카드 생성</button>
      <button class="tab-btn" onclick="switchTab(&#39;config&#39;)">⚙️ 강화 설정</button>
      <button class="tab-btn" onclick="switchTab(&#39;sets&#39;)">🃏 세트 조합</button>
    </div>

    <!-- ── 장착 탭 ── -->
    <div id="tab-equip" class="tab-content" style="display: block;">
      <div class="main-grid">
        <div class="col">
          <div class="panel">
            <div class="panel-hd">
              <div class="panel-title">📦 인벤토리</div>
              <button class="btn-import" style="margin-left:8px; padding:2px 8px; font-size:9px;"
                onclick="openObtainModal()">➕ 카드 획득</button>
              <span id="inv-count"
                style="font-size:10px;color:var(--text3);margin-left:auto;font-family:'Rajdhani',sans-serif;font-weight:700;">0장</span>
            </div>
            <div class="panel-bd" style="padding:12px;">
              <div class="filter-bar" id="inv-filter" style="display: flex; flex-direction: column; gap: 8px;">
                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                  <div class="filter-chip active" onclick="filterInv('all', this)">ALL</div>
                  <div class="filter-chip" onclick="filterInv('1', this)">T1</div>
                  <div class="filter-chip" onclick="filterInv('2', this)">T2</div>
                  <div class="filter-chip" onclick="filterInv('3', this)">T3</div>
                  <div class="filter-chip" onclick="filterInv('4', this)">T4</div>
                  <div class="filter-chip" onclick="filterInv('5', this)">T5</div>
                  <div class="filter-chip" onclick="filterInv('6', this)">T6</div>
                  <div class="filter-chip" onclick="filterInv('7', this)">T7</div>
                </div>

                <select id="inv-stat-filter" class="form-input" style="width: 100%; font-size: 11px; padding: 5px;"
                  onchange="renderInventory()">
                  <option value="">보유 스탯 필터: 전체</option>
                  <optgroup label="■ 주요 스탯">
                    <option value="AttackVary">공격력</option>
                    <option value="PhysicalDefenseVary">물리 방어력</option>
                    <option value="MagicDefenseVary">마법 방어력</option>
                  </optgroup>
                  <optgroup label="■ 세부 스탯">
                    <option value="AtkSpeedVaryper">공격 속도 (%)</option>
                    <option value="MoveSpeedVaryper">이동 속도 (%)</option>
                    <option value="MaxHpVary">최대 체력</option>
                    <option value="MaxMpVary">최대 마력</option>
                    <option value="RegenHpVary">체력 지속 회복량</option>
                    <option value="RegenMpVary">마력 지속 회복량</option>
                    <option value="DamageUpVaryper">주는 피해 증가 (%)</option>
                    <option value="DamageDownVaryper">받는 피해 감소 (%)</option>
                    <option value="PhysicalDamageUpVaryper">물리 피해 증가 (%)</option>
                    <option value="PhysicalDamageDownVaryper">물리 피해 감소 (%)</option>
                    <option value="MagicDamageUpVaryper">마법 피해 증가 (%)</option>
                    <option value="MagicDamageDownVaryper">마법 피해 감소 (%)</option>
                    <option value="PVEDamageUpVaryper">PVE 대미지 증가 (%)</option>
                    <option value="PVEDamageDownVaryper">PVE 대미지 감소 (%)</option>
                    <option value="PVPDamageUpVaryper">PVP 대미지 증가 (%)</option>
                    <option value="PVPDamageDownVaryper">PVP 대미지 감소 (%)</option>
                    <option value="DodgeVaryper">회피 (%)</option>
                    <option value="CriVaryper">치명타 확률 (%)</option>
                    <option value="CriDamageVaryper">치명타 피해 증가 (%)</option>
                    <option value="SkillCooldownAccVary">스킬 가속</option>
                    <option value="SCNegativeRecoveryVary">상태 이상 회복</option>
                    <option value="CostMpDownVaryper">마나 소모량 감소 (%)</option>
                    <option value="MountSpeedVaryper">탈 것 이동 속도 (%)</option>
                  </optgroup>
                </select>
              </div>
              <div class="card-list" id="inv-list" ondragover="e=&gt;e.preventDefault()" ondrop="onDropToList(event)">
                <div class="card-item equipped ani" data-tier="1" data-id="s7bcnxq"
                  onclick="openCardTooltip(&#39;s7bcnxq&#39;)" draggable="true"
                  ondragstart="if(document.getElementById(&#39;enh-overlay&#39;).classList.contains(&#39;open&#39;)){event.preventDefault();return;}onDragStart(event,&#39;s7bcnxq&#39;,null)">
                  <div class="card-icon">🌿</div>
                  <div class="card-info" style="flex:1;min-width:0;">
                    <div style="display:flex;align-items:center;gap:5px;flex-wrap:nowrap;overflow:hidden;">
                      <span class="card-tier-badge tb1" style="flex-shrink:0;">T1</span>
                      <span class="enh-badge">0강</span>
                      <span class="card-name"
                        style="font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">누이안</span>
                    </div>
                    <div class="card-stats-row"><span class="stat-chip">+25 최대 체력</span></div>
                    <div style="display:flex;gap:4px;align-items:center;margin-top:5px;">
                      <span
                        style="font-size:9px;color:var(--green);font-family:&#39;Rajdhani&#39;,sans-serif;font-weight:700;letter-spacing:.5px;">✓장착</span>
                      <button class="btn-enh"
                        onclick="event.stopPropagation();openEnhOverlay(&#39;s7bcnxq&#39;)">🔥강화</button>
                      <button class="btn-danger"
                        onclick="event.stopPropagation();deleteCard(&#39;s7bcnxq&#39;)">삭제</button>
                    </div>
                  </div>
                </div>
                <div class="card-item ani" data-tier="1" data-id="rjspw80" onclick="openCardTooltip(&#39;rjspw80&#39;)"
                  draggable="true"
                  ondragstart="if(document.getElementById(&#39;enh-overlay&#39;).classList.contains(&#39;open&#39;)){event.preventDefault();return;}onDragStart(event,&#39;rjspw80&#39;,null)">
                  <div class="card-icon">👹</div>
                  <div class="card-info" style="flex:1;min-width:0;">
                    <div style="display:flex;align-items:center;gap:5px;flex-wrap:nowrap;overflow:hidden;">
                      <span class="card-tier-badge tb1" style="flex-shrink:0;">T1</span>
                      <span class="enh-badge">0강</span>
                      <span class="card-name"
                        style="font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">오크</span>
                    </div>
                    <div class="card-stats-row"><span class="stat-chip">+10 물리 방어력</span></div>
                    <div style="display:flex;gap:4px;align-items:center;margin-top:5px;">
                      <button class="btn-sm" onclick="event.stopPropagation();quickEquip(&#39;rjspw80&#39;)">장착</button>
                      <button class="btn-enh"
                        onclick="event.stopPropagation();openEnhOverlay(&#39;rjspw80&#39;)">🔥강화</button>
                      <button class="btn-danger"
                        onclick="event.stopPropagation();deleteCard(&#39;rjspw80&#39;)">삭제</button>
                    </div>
                  </div>
                </div>
                <div class="card-item ani" data-tier="1" data-id="j4970y5" onclick="openCardTooltip(&#39;j4970y5&#39;)"
                  draggable="true"
                  ondragstart="if(document.getElementById(&#39;enh-overlay&#39;).classList.contains(&#39;open&#39;)){event.preventDefault();return;}onDragStart(event,&#39;j4970y5&#39;,null)">
                  <div class="card-icon">🦁</div>
                  <div class="card-info" style="flex:1;min-width:0;">
                    <div style="display:flex;align-items:center;gap:5px;flex-wrap:nowrap;overflow:hidden;">
                      <span class="card-tier-badge tb1" style="flex-shrink:0;">T1</span>
                      <span class="enh-badge">0강</span>
                      <span class="card-name"
                        style="font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">놀</span>
                    </div>
                    <div class="card-stats-row"><span class="stat-chip">+10 물리 방어력</span></div>
                    <div style="display:flex;gap:4px;align-items:center;margin-top:5px;">
                      <button class="btn-sm" onclick="event.stopPropagation();quickEquip(&#39;j4970y5&#39;)">장착</button>
                      <button class="btn-enh"
                        onclick="event.stopPropagation();openEnhOverlay(&#39;j4970y5&#39;)">🔥강화</button>
                      <button class="btn-danger"
                        onclick="event.stopPropagation();deleteCard(&#39;j4970y5&#39;)">삭제</button>
                    </div>
                  </div>
                </div>
                <div class="card-item ani" data-tier="1" data-id="q29b9ge" onclick="openCardTooltip(&#39;q29b9ge&#39;)"
                  draggable="true"
                  ondragstart="if(document.getElementById(&#39;enh-overlay&#39;).classList.contains(&#39;open&#39;)){event.preventDefault();return;}onDragStart(event,&#39;q29b9ge&#39;,null)">
                  <div class="card-icon">💀</div>
                  <div class="card-info" style="flex:1;min-width:0;">
                    <div style="display:flex;align-items:center;gap:5px;flex-wrap:nowrap;overflow:hidden;">
                      <span class="card-tier-badge tb1" style="flex-shrink:0;">T1</span>
                      <span class="enh-badge">0강</span>
                      <span class="card-name"
                        style="font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">스켈레톤</span>
                    </div>
                    <div class="card-stats-row"><span class="stat-chip">+3 체력 지속 회복량</span></div>
                    <div style="display:flex;gap:4px;align-items:center;margin-top:5px;">
                      <button class="btn-sm" onclick="event.stopPropagation();quickEquip(&#39;q29b9ge&#39;)">장착</button>
                      <button class="btn-enh"
                        onclick="event.stopPropagation();openEnhOverlay(&#39;q29b9ge&#39;)">🔥강화</button>
                      <button class="btn-danger"
                        onclick="event.stopPropagation();deleteCard(&#39;q29b9ge&#39;)">삭제</button>
                    </div>
                  </div>
                </div>
                <div class="card-item ani" data-tier="1" data-id="4o5b756" onclick="openCardTooltip(&#39;4o5b756&#39;)"
                  draggable="true"
                  ondragstart="if(document.getElementById(&#39;enh-overlay&#39;).classList.contains(&#39;open&#39;)){event.preventDefault();return;}onDragStart(event,&#39;4o5b756&#39;,null)">
                  <div class="card-icon">🌑</div>
                  <div class="card-info" style="flex:1;min-width:0;">
                    <div style="display:flex;align-items:center;gap:5px;flex-wrap:nowrap;overflow:hidden;">
                      <span class="card-tier-badge tb1" style="flex-shrink:0;">T1</span>
                      <span class="enh-badge">0강</span>
                      <span class="card-name"
                        style="font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">팬텀</span>
                    </div>
                    <div class="card-stats-row"><span class="stat-chip">+3 공격력</span></div>
                    <div style="display:flex;gap:4px;align-items:center;margin-top:5px;">
                      <button class="btn-sm" onclick="event.stopPropagation();quickEquip(&#39;4o5b756&#39;)">장착</button>
                      <button class="btn-enh"
                        onclick="event.stopPropagation();openEnhOverlay(&#39;4o5b756&#39;)">🔥강화</button>
                      <button class="btn-danger"
                        onclick="event.stopPropagation();deleteCard(&#39;4o5b756&#39;)">삭제</button>
                    </div>
                  </div>
                </div>
                <div class="card-item equipped ani" data-tier="1" data-id="c692ti5"
                  onclick="openCardTooltip(&#39;c692ti5&#39;)" draggable="true"
                  ondragstart="if(document.getElementById(&#39;enh-overlay&#39;).classList.contains(&#39;open&#39;)){event.preventDefault();return;}onDragStart(event,&#39;c692ti5&#39;,null)">
                  <div class="card-icon">💧</div>
                  <div class="card-info" style="flex:1;min-width:0;">
                    <div style="display:flex;align-items:center;gap:5px;flex-wrap:nowrap;overflow:hidden;">
                      <span class="card-tier-badge tb1" style="flex-shrink:0;">T1</span>
                      <span class="enh-badge">0강</span>
                      <span class="card-name"
                        style="font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">물 정령</span>
                    </div>
                    <div class="card-stats-row"><span class="stat-chip">+3 마력 지속 회복량</span></div>
                    <div style="display:flex;gap:4px;align-items:center;margin-top:5px;">
                      <span
                        style="font-size:9px;color:var(--green);font-family:&#39;Rajdhani&#39;,sans-serif;font-weight:700;letter-spacing:.5px;">✓장착</span>
                      <button class="btn-enh"
                        onclick="event.stopPropagation();openEnhOverlay(&#39;c692ti5&#39;)">🔥강화</button>
                      <button class="btn-danger"
                        onclick="event.stopPropagation();deleteCard(&#39;c692ti5&#39;)">삭제</button>
                    </div>
                  </div>
                </div>
                <div class="card-item equipped ani" data-tier="1" data-id="tasoy2e"
                  onclick="openCardTooltip(&#39;tasoy2e&#39;)" draggable="true"
                  ondragstart="if(document.getElementById(&#39;enh-overlay&#39;).classList.contains(&#39;open&#39;)){event.preventDefault();return;}onDragStart(event,&#39;tasoy2e&#39;,null)">
                  <div class="card-icon">🌿</div>
                  <div class="card-info" style="flex:1;min-width:0;">
                    <div style="display:flex;align-items:center;gap:5px;flex-wrap:nowrap;overflow:hidden;">
                      <span class="card-tier-badge tb1" style="flex-shrink:0;">T1</span>
                      <span class="enh-badge">0강</span>
                      <span class="card-name"
                        style="font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">나무 정령</span>
                    </div>
                    <div class="card-stats-row"><span class="stat-chip">+3 스킬 가속</span></div>
                    <div style="display:flex;gap:4px;align-items:center;margin-top:5px;">
                      <span
                        style="font-size:9px;color:var(--green);font-family:&#39;Rajdhani&#39;,sans-serif;font-weight:700;letter-spacing:.5px;">✓장착</span>
                      <button class="btn-enh"
                        onclick="event.stopPropagation();openEnhOverlay(&#39;tasoy2e&#39;)">🔥강화</button>
                      <button class="btn-danger"
                        onclick="event.stopPropagation();deleteCard(&#39;tasoy2e&#39;)">삭제</button>
                    </div>
                  </div>
                </div>
                <div class="card-item equipped ani" data-tier="1" data-id="fjk8pnk"
                  onclick="openCardTooltip(&#39;fjk8pnk&#39;)" draggable="true"
                  ondragstart="if(document.getElementById(&#39;enh-overlay&#39;).classList.contains(&#39;open&#39;)){event.preventDefault();return;}onDragStart(event,&#39;fjk8pnk&#39;,null)">
                  <div class="card-icon">🪨</div>
                  <div class="card-info" style="flex:1;min-width:0;">
                    <div style="display:flex;align-items:center;gap:5px;flex-wrap:nowrap;overflow:hidden;">
                      <span class="card-tier-badge tb1" style="flex-shrink:0;">T1</span>
                      <span class="enh-badge">0강</span>
                      <span class="card-name"
                        style="font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">바위 정령</span>
                    </div>
                    <div class="card-stats-row"><span class="stat-chip">+3 스킬 가속</span></div>
                    <div style="display:flex;gap:4px;align-items:center;margin-top:5px;">
                      <span
                        style="font-size:9px;color:var(--green);font-family:&#39;Rajdhani&#39;,sans-serif;font-weight:700;letter-spacing:.5px;">✓장착</span>
                      <button class="btn-enh"
                        onclick="event.stopPropagation();openEnhOverlay(&#39;fjk8pnk&#39;)">🔥강화</button>
                      <button class="btn-danger"
                        onclick="event.stopPropagation();deleteCard(&#39;fjk8pnk&#39;)">삭제</button>
                    </div>
                  </div>
                </div>
                <div class="card-item equipped ani" data-tier="1" data-id="g10fuep"
                  onclick="openCardTooltip(&#39;g10fuep&#39;)" draggable="true"
                  ondragstart="if(document.getElementById(&#39;enh-overlay&#39;).classList.contains(&#39;open&#39;)){event.preventDefault();return;}onDragStart(event,&#39;g10fuep&#39;,null)">
                  <div class="card-icon">🌱</div>
                  <div class="card-info" style="flex:1;min-width:0;">
                    <div style="display:flex;align-items:center;gap:5px;flex-wrap:nowrap;overflow:hidden;">
                      <span class="card-tier-badge tb1" style="flex-shrink:0;">T1</span>
                      <span class="enh-badge">0강</span>
                      <span class="card-name"
                        style="font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">이끼 정령</span>
                    </div>
                    <div class="card-stats-row"><span class="stat-chip">+3 스킬 가속</span></div>
                    <div style="display:flex;gap:4px;align-items:center;margin-top:5px;">
                      <span
                        style="font-size:9px;color:var(--green);font-family:&#39;Rajdhani&#39;,sans-serif;font-weight:700;letter-spacing:.5px;">✓장착</span>
                      <button class="btn-enh"
                        onclick="event.stopPropagation();openEnhOverlay(&#39;g10fuep&#39;)">🔥강화</button>
                      <button class="btn-danger"
                        onclick="event.stopPropagation();deleteCard(&#39;g10fuep&#39;)">삭제</button>
                    </div>
                  </div>
                </div>
                <div class="card-item ani" data-tier="2" data-id="ihnriil" onclick="openCardTooltip(&#39;ihnriil&#39;)"
                  draggable="true"
                  ondragstart="if(document.getElementById(&#39;enh-overlay&#39;).classList.contains(&#39;open&#39;)){event.preventDefault();return;}onDragStart(event,&#39;ihnriil&#39;,null)">
                  <div class="card-icon">⚔️</div>
                  <div class="card-info" style="flex:1;min-width:0;">
                    <div style="display:flex;align-items:center;gap:5px;flex-wrap:nowrap;overflow:hidden;">
                      <span class="card-tier-badge tb2" style="flex-shrink:0;">T2</span>
                      <span class="enh-badge">0강</span>
                      <span class="card-name"
                        style="font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">오크 족장</span>
                    </div>
                    <div class="card-stats-row"><span class="stat-chip">+0.4% 공격 속도</span></div>
                    <div style="display:flex;gap:4px;align-items:center;margin-top:5px;">
                      <button class="btn-sm" onclick="event.stopPropagation();quickEquip(&#39;ihnriil&#39;)">장착</button>
                      <button class="btn-enh"
                        onclick="event.stopPropagation();openEnhOverlay(&#39;ihnriil&#39;)">🔥강화</button>
                      <button class="btn-danger"
                        onclick="event.stopPropagation();deleteCard(&#39;ihnriil&#39;)">삭제</button>
                    </div>
                  </div>
                </div>
                <div class="card-item ani" data-tier="2" data-id="10selhk" onclick="openCardTooltip(&#39;10selhk&#39;)"
                  draggable="true"
                  ondragstart="if(document.getElementById(&#39;enh-overlay&#39;).classList.contains(&#39;open&#39;)){event.preventDefault();return;}onDragStart(event,&#39;10selhk&#39;,null)">
                  <div class="card-icon">🦅</div>
                  <div class="card-info" style="flex:1;min-width:0;">
                    <div style="display:flex;align-items:center;gap:5px;flex-wrap:nowrap;overflow:hidden;">
                      <span class="card-tier-badge tb2" style="flex-shrink:0;">T2</span>
                      <span class="enh-badge">0강</span>
                      <span class="card-name"
                        style="font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">놀 우두머리</span>
                    </div>
                    <div class="card-stats-row"><span class="stat-chip">+0.3% 이동 속도</span></div>
                    <div style="display:flex;gap:4px;align-items:center;margin-top:5px;">
                      <button class="btn-sm" onclick="event.stopPropagation();quickEquip(&#39;10selhk&#39;)">장착</button>
                      <button class="btn-enh"
                        onclick="event.stopPropagation();openEnhOverlay(&#39;10selhk&#39;)">🔥강화</button>
                      <button class="btn-danger"
                        onclick="event.stopPropagation();deleteCard(&#39;10selhk&#39;)">삭제</button>
                    </div>
                  </div>
                </div>
                <div class="card-item ani" data-tier="3" data-id="8sys69j" onclick="openCardTooltip(&#39;8sys69j&#39;)"
                  draggable="true"
                  ondragstart="if(document.getElementById(&#39;enh-overlay&#39;).classList.contains(&#39;open&#39;)){event.preventDefault();return;}onDragStart(event,&#39;8sys69j&#39;,null)">
                  <div class="card-icon">🦂</div>
                  <div class="card-info" style="flex:1;min-width:0;">
                    <div style="display:flex;align-items:center;gap:5px;flex-wrap:nowrap;overflow:hidden;">
                      <span class="card-tier-badge tb3" style="flex-shrink:0;">T3</span>
                      <span class="enh-badge">0강</span>
                      <span class="card-name"
                        style="font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">스칼니토스</span>
                    </div>
                    <div class="card-stats-row"><span class="stat-chip">+0.2% PVE 대미지 감소</span></div>
                    <div style="display:flex;gap:4px;align-items:center;margin-top:5px;">
                      <button class="btn-sm" onclick="event.stopPropagation();quickEquip(&#39;8sys69j&#39;)">장착</button>
                      <button class="btn-enh"
                        onclick="event.stopPropagation();openEnhOverlay(&#39;8sys69j&#39;)">🔥강화</button>
                      <button class="btn-danger"
                        onclick="event.stopPropagation();deleteCard(&#39;8sys69j&#39;)">삭제</button>
                    </div>
                  </div>
                </div>
                <div class="card-item ani" data-tier="3" data-id="9r43tpw" onclick="openCardTooltip(&#39;9r43tpw&#39;)"
                  draggable="true"
                  ondragstart="if(document.getElementById(&#39;enh-overlay&#39;).classList.contains(&#39;open&#39;)){event.preventDefault();return;}onDragStart(event,&#39;9r43tpw&#39;,null)">
                  <div class="card-icon">🐲</div>
                  <div class="card-info" style="flex:1;min-width:0;">
                    <div style="display:flex;align-items:center;gap:5px;flex-wrap:nowrap;overflow:hidden;">
                      <span class="card-tier-badge tb3" style="flex-shrink:0;">T3</span>
                      <span class="enh-badge">0강</span>
                      <span class="card-name"
                        style="font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">말카바돈</span>
                    </div>
                    <div class="card-stats-row"><span class="stat-chip">+0.2% PVE 대미지 증가</span></div>
                    <div style="display:flex;gap:4px;align-items:center;margin-top:5px;">
                      <button class="btn-sm" onclick="event.stopPropagation();quickEquip(&#39;9r43tpw&#39;)">장착</button>
                      <button class="btn-enh"
                        onclick="event.stopPropagation();openEnhOverlay(&#39;9r43tpw&#39;)">🔥강화</button>
                      <button class="btn-danger"
                        onclick="event.stopPropagation();deleteCard(&#39;9r43tpw&#39;)">삭제</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="panel">
            <div class="panel-hd">
              <div class="panel-title">⚔️ 카드 슬롯</div>
              <span
                style="font-size:10px;color:var(--text3);margin-left:auto;font-family:&#39;Rajdhani&#39;,sans-serif;">드래그
                장착 · 클릭으로 강화</span>
            </div>
            <div class="panel-bd">
              <div class="slots-grid" id="slots-grid">
                <div class="slot filled" id="slot-0" data-tier="1" ondragover="onDragOverSlot(event,0)"
                  ondrop="onDropSlot(event,0)" ondragleave="onDragLeaveSlot(0)" draggable="true"
                  ondragstart="onDragStart(event,&#39;s7bcnxq&#39;,0)" onclick="openCardTooltip(&#39;s7bcnxq&#39;)">
                  <div class="slot-num">SLOT 1</div>
                  <div class="slot-remove" onclick="event.stopPropagation();unequipSlot(0)">✕</div>
                  <div class="slot-ico">🌿</div>
                  <div class="slot-name">누이안</div>
                  <div class="slot-tier" style="color:var(--t1)">T1 · 누이안</div>

                  <div class="slot-stats">+25 최대 체력</div>
                  <button class="slot-enh-btn" onclick="event.stopPropagation();openEnhOverlay(&#39;s7bcnxq&#39;)">🔥
                    강화</button>
                </div>
                <div class="slot filled" id="slot-1" data-tier="1" ondragover="onDragOverSlot(event,1)"
                  ondrop="onDropSlot(event,1)" ondragleave="onDragLeaveSlot(1)" draggable="true"
                  ondragstart="onDragStart(event,&#39;fjk8pnk&#39;,1)" onclick="openCardTooltip(&#39;fjk8pnk&#39;)">
                  <div class="slot-num">SLOT 2</div>
                  <div class="slot-remove" onclick="event.stopPropagation();unequipSlot(1)">✕</div>
                  <div class="slot-ico">🪨</div>
                  <div class="slot-name">바위 정령</div>
                  <div class="slot-tier" style="color:var(--t1)">T1 · 바위 정령</div>

                  <div class="slot-stats">+3 스킬 가속</div>
                  <button class="slot-enh-btn" onclick="event.stopPropagation();openEnhOverlay(&#39;fjk8pnk&#39;)">🔥
                    강화</button>
                </div>
                <div class="slot filled" id="slot-2" data-tier="1" ondragover="onDragOverSlot(event,2)"
                  ondrop="onDropSlot(event,2)" ondragleave="onDragLeaveSlot(2)" draggable="true"
                  ondragstart="onDragStart(event,&#39;c692ti5&#39;,2)" onclick="openCardTooltip(&#39;c692ti5&#39;)">
                  <div class="slot-num">SLOT 3</div>
                  <div class="slot-remove" onclick="event.stopPropagation();unequipSlot(2)">✕</div>
                  <div class="slot-ico">💧</div>
                  <div class="slot-name">물 정령</div>
                  <div class="slot-tier" style="color:var(--t1)">T1 · 물 정령</div>

                  <div class="slot-stats">+3 마력 지속 회복량</div>
                  <button class="slot-enh-btn" onclick="event.stopPropagation();openEnhOverlay(&#39;c692ti5&#39;)">🔥
                    강화</button>
                </div>
                <div class="slot filled" id="slot-3" data-tier="1" ondragover="onDragOverSlot(event,3)"
                  ondrop="onDropSlot(event,3)" ondragleave="onDragLeaveSlot(3)" draggable="true"
                  ondragstart="onDragStart(event,&#39;tasoy2e&#39;,3)" onclick="openCardTooltip(&#39;tasoy2e&#39;)">
                  <div class="slot-num">SLOT 4</div>
                  <div class="slot-remove" onclick="event.stopPropagation();unequipSlot(3)">✕</div>
                  <div class="slot-ico">🌿</div>
                  <div class="slot-name">나무 정령</div>
                  <div class="slot-tier" style="color:var(--t1)">T1 · 나무 정령</div>

                  <div class="slot-stats">+3 스킬 가속</div>
                  <button class="slot-enh-btn" onclick="event.stopPropagation();openEnhOverlay(&#39;tasoy2e&#39;)">🔥
                    강화</button>
                </div>
                <div class="slot filled" id="slot-4" data-tier="1" ondragover="onDragOverSlot(event,4)"
                  ondrop="onDropSlot(event,4)" ondragleave="onDragLeaveSlot(4)" draggable="true"
                  ondragstart="onDragStart(event,&#39;g10fuep&#39;,4)" onclick="openCardTooltip(&#39;g10fuep&#39;)">
                  <div class="slot-num">SLOT 5</div>
                  <div class="slot-remove" onclick="event.stopPropagation();unequipSlot(4)">✕</div>
                  <div class="slot-ico">🌱</div>
                  <div class="slot-name">이끼 정령</div>
                  <div class="slot-tier" style="color:var(--t1)">T1 · 이끼 정령</div>

                  <div class="slot-stats">+3 스킬 가속</div>
                  <button class="slot-enh-btn" onclick="event.stopPropagation();openEnhOverlay(&#39;g10fuep&#39;)">🔥
                    강화</button>
                </div>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="panel">
              <div class="panel-hd">
                <div class="panel-title">✨ 효과 합산</div>
              </div>
              <div class="panel-bd">
                <div id="effect-summary">
                  <div class="set-area">
                    <div class="set-area-title">적용 중인 효과</div>
                    <div class="eff-row ind">
                      <span class="eff-badge" style="background:rgba(255,255,255,.06);color:var(--text3);">개별</span>
                      <div>
                        <div class="eff-label">개별 스탯 합산</div>
                        <div class="eff-stats"><span class="eff-stat-chip">+25 최대 체력</span><span
                            class="eff-stat-chip">+9
                            스킬 가속</span><span class="eff-stat-chip">+3 마력 지속 회복량</span></div>
                      </div>
                    </div>
                    <div class="active-set-row grade-straight">
                      <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
                        <span class="set-def-grade"
                          style="background:var(--straight-c)20;color:var(--straight-c);font-family:&#39;Rajdhani&#39;,sans-serif;font-size:9px;font-weight:700;letter-spacing:1px;padding:1px 6px;border-radius:3px;">⚡
                          스트레이트</span>
                        <span class="active-set-name">인간과 정령</span>
                      </div>
                      <div class="active-set-desc">대지의 정령들과 인간이 하나가 되어 자연의 모든 힘을 이끌어낸다.</div>
                      <div class="active-set-bonus"><span class="eff-stat-chip"
                          style="background:rgba(232,184,75,.08);border-color:rgba(232,184,75,.2);color:var(--gold2);">+200
                          최대 체력</span><span class="eff-stat-chip"
                          style="background:rgba(232,184,75,.08);border-color:rgba(232,184,75,.2);color:var(--gold2);">+5
                          체력 지속 회복량</span><span class="eff-stat-chip"
                          style="background:rgba(232,184,75,.08);border-color:rgba(232,184,75,.2);color:var(--gold2);">+10
                          스킬 가속</span></div>
                    </div>
                    <div class="active-set-row grade-triple">
                      <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
                        <span class="set-def-grade"
                          style="background:var(--triple-c)20;color:var(--triple-c);font-family:&#39;Rajdhani&#39;,sans-serif;font-size:9px;font-weight:700;letter-spacing:1px;padding:1px 6px;border-radius:3px;">⚡
                          트리플</span>
                        <span class="active-set-name">물나무인간</span>
                      </div>
                      <div class="active-set-desc">-</div>
                      <div class="active-set-bonus"><span class="eff-stat-chip"
                          style="background:rgba(232,184,75,.08);border-color:rgba(232,184,75,.2);color:var(--gold2);">+100
                          최대 체력</span></div>
                    </div>
                  </div>
                  <div class="total-stats">
                    <div class="total-stats-title">합산 스탯</div>
                    <div class="total-grid" style="grid-template-columns:repeat(3,1fr);">
                      <div class="total-item">
                        <div class="total-name">최대 체력</div>
                        <div class="total-val" style="color:var(--gold2);">+325<span
                            style="font-size:8px;color:var(--gold);margin-left:2px;">(세트+300)</span></div>
                      </div>
                      <div class="total-item">
                        <div class="total-name">스킬 가속</div>
                        <div class="total-val" style="color:var(--gold2);">+19<span
                            style="font-size:8px;color:var(--gold);margin-left:2px;">(세트+10)</span></div>
                      </div>
                      <div class="total-item">
                        <div class="total-name">마력 지속 회복량</div>
                        <div class="total-val" style="color:var(--green);">+3</div>
                      </div>
                      <div class="total-item">
                        <div class="total-name">체력 지속 회복량</div>
                        <div class="total-val" style="color:var(--gold2);">+5<span
                            style="font-size:8px;color:var(--gold);margin-left:2px;">(세트+5)</span></div>
                      </div>
                    </div>
                  </div>
                  <div
                    style="margin-top:8px;text-align:center;font-family:&#39;Rajdhani&#39;,sans-serif;font-size:12px;font-weight:700;letter-spacing:2px;color:var(--straight-c);">
                    🃏 스트레이트</div>
                </div>
              </div>
            </div>
            <div class="panel">
              <div class="panel-hd">
                <div class="panel-title">📚 전체 세트 도감</div>
                <span style="font-size:10px;color:var(--text3);margin-left:auto;font-family:'Rajdhani',sans-serif;">세트 및
                  카드 상세 정보</span>
              </div>
              <div class="panel-bd" style="padding:0;">
                <div
                  style="padding: 10px 12px; border-bottom: 1px solid var(--border); background: var(--bg); display: flex; flex-direction: column; gap: 8px;">
                  <input type="text" id="equip-set-search" class="form-input" placeholder="세트명 또는 구성 카드 검색..."
                    oninput="renderEquipSetList()">
                  <div class="filter-bar" id="equip-set-filter" style="margin-bottom: 0;">
                    <div class="filter-chip active" onclick="filterEquipSet('all', this)">ALL</div>
                    <div class="filter-chip" onclick="filterEquipSet('pair', this)">PAIR</div>
                    <div class="filter-chip" onclick="filterEquipSet('triple', this)">TRIPLE</div>
                    <div class="filter-chip" onclick="filterEquipSet('straight', this)">STRAIGHT</div>
                  </div>
                </div>
                <div id="equip-set-list" style="max-height: 480px; overflow-y: auto; padding: 12px;">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- ── 생성 탭 ── -->
  <div id="tab-create" class="tab-content" style="display:none;">
    <div class="main-grid">
      <div class="col">
        <div class="panel">
          <div class="panel-hd" style="padding: 0;">
            <div style="display: flex; width: 100%;">
              <div id="sub-tab-manual" class="tab-btn active"
                style="border-radius: 0; border-bottom: 2px solid var(--gold); font-size: 11px; height: 40px; display: flex; align-items: center; justify-content: center;"
                onclick="switchSubTab('manual')">✍️ 수동 생성</div>
              <div id="sub-tab-auto" class="tab-btn"
                style="border-radius: 0; font-size: 11px; height: 40px; display: flex; align-items: center; justify-content: center;"
                onclick="switchSubTab('auto')">🤖 자동 생성</div>
            </div>
          </div>

          <div id="panel-manual" class="panel-bd">
            <div class="form-group">
              <label class="form-label">카드 CID (자동 생성)</label>
              <input class="form-input" id="c-cid" readonly
                style="background:var(--bg2); color:var(--gold); font-weight:700;" placeholder="티어를 선택하면 CID가 부여됩니다.">
            </div>
            <div class="form-group">
              <label class="form-label">카드 이름</label>
              <input class="form-input" id="c-name" placeholder="예: 불꽃 고블린" maxlength="20">
            </div>
            <div class="form-group">
              <label class="form-label">아이콘</label>
              <div class="icon-grid" id="icon-grid"></div>
            </div>
            <div class="form-group">
              <label class="form-label">티어</label>
              <div class="tier-selector">
                <button class="tier-btn" data-tier="1" onclick="selTier(1,this)">T1</button>
                <button class="tier-btn" data-tier="2" onclick="selTier(2,this)">T2</button>
                <button class="tier-btn" data-tier="3" onclick="selTier(3,this)">T3</button>
                <button class="tier-btn" data-tier="4" onclick="selTier(4,this)">T4</button>
                <button class="tier-btn" data-tier="5" onclick="selTier(5,this)">T5</button>
                <button class="tier-btn" data-tier="6" onclick="selTier(6,this)">T6</button>
                <button class="tier-btn" data-tier="7" onclick="selTier(7,this)">T7</button>
              </div>
            </div>

            <div class="divider">
              <div class="divider-line"></div>
              <div class="divider-txt">1. 기본(0강) 효과 스탯</div>
              <div class="divider-line"></div>
            </div>
            <div id="stat-entries" style="display:flex;flex-direction:column;gap:5px;margin-bottom:8px;"></div>

            <div
              style="display:grid;grid-template-columns:1fr 90px auto;gap:6px;align-items:center;margin-bottom:13px;">
              <select class="form-input" id="stat-select" style="padding:7px 10px;">
                <option value="">-- 스탯 선택 --</option>
                <optgroup label="■ 주요 스탯">
                  <option value="AttackVary">공격력</option>
                  <option value="PhysicalDefenseVary">물리 방어력</option>
                  <option value="MagicDefenseVary">마법 방어력</option>
                </optgroup>
                <optgroup label="■ 세부 스탯">
                  <option value="AtkSpeedVaryper">공격 속도 (%)</option>
                  <option value="MoveSpeedVaryper">이동 속도 (%)</option>
                  <option value="MaxHpVary">최대 체력</option>
                  <option value="MaxMpVary">최대 마력</option>
                  <option value="RegenHpVary">체력 지속 회복량</option>
                  <option value="RegenMpVary">마력 지속 회복량</option>
                  <option value="DamageUpVaryper">주는 피해 증가 (%)</option>
                  <option value="DamageDownVaryper">받는 피해 감소 (%)</option>
                  <option value="PhysicalDamageUpVaryper">물리 피해 증가 (%)</option>
                  <option value="PhysicalDamageDownVaryper">물리 피해 감소 (%)</option>
                  <option value="MagicDamageUpVaryper">마법 피해 증가 (%)</option>
                  <option value="MagicDamageDownVaryper">마법 피해 감소 (%)</option>
                  <option value="PVEDamageUpVaryper">PVE 대미지 증가 (%)</option>
                  <option value="PVEDamageDownVaryper">PVE 대미지 감소 (%)</option>
                  <option value="PVPDamageUpVaryper">PVP 대미지 증가 (%)</option>
                  <option value="PVPDamageDownVaryper">PVP 대미지 감소 (%)</option>
                  <option value="DodgeVaryper">회피 (%)</option>
                  <option value="CriVaryper">치명타 확률 (%)</option>
                  <option value="CriDamageVaryper">치명타 피해 증가 (%)</option>
                  <option value="SkillCooldownAccVary">스킬 가속</option>
                  <option value="SCNegativeRecoveryVary">상태 이상 회복</option>
                  <option value="CostMpDownVaryper">마나 소모량 감소 (%)</option>
                  <option value="MountSpeedVaryper">탈 것 이동 속도 (%)</option>
                </optgroup>
              </select>
              <input class="form-input" id="stat-val" type="number" min="0" step="0.1" placeholder="값"
                style="padding:7px 10px;">
              <button class="btn-sm" onclick="addStatEntry()" style="padding:7px 10px;white-space:nowrap;">+ 추가</button>
            </div>

            <div class="divider">
              <div class="divider-line"></div>
              <div class="divider-txt">2. 강화 단계별 스탯 가산</div>
              <div class="divider-line"></div>
            </div>
            <div class="step-selector" style="margin-bottom: 10px;">
              <button class="step-btn active" id="step-btn-0" onclick="switchStep(0)">기본</button>
              <button class="step-btn" id="step-btn-1" onclick="switchStep(1)">+1</button>
              <button class="step-btn" id="step-btn-2" onclick="switchStep(2)">+2</button>
              <button class="step-btn" id="step-btn-3" onclick="switchStep(3)">+3</button>
              <button class="step-btn" id="step-btn-4" onclick="switchStep(4)">+4</button>
              <button class="step-btn" id="step-btn-5" onclick="switchStep(5)">+5</button>
            </div>

            <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:15px;">
              <div style="display:flex; gap:5px; align-items:center;">
                <button class="btn-sm" style="flex:2; background:rgba(232,184,75,0.1); border-color:var(--gold);"
                  onclick="copyBaseToAll()">
                  📋 0강 스탯에 n을 단계별로 더하여 전체 복사
                </button>
                <div style="display:flex; align-items:center; gap:3px; flex:1;">
                  <span style="font-size:10px; color:var(--text3);">n=</span>
                  <input type="number" id="copy-all-n" class="form-input" value="1" step="1"
                    style="padding:4px 8px; text-align:center;">
                </div>
              </div>

              <div style="display:flex; gap:5px; align-items:center;">
                <button class="btn-sm" style="flex:2;" onclick="copyPrevStep()">
                  ◀ 이전 단계수치에 n만큼 더하기
                </button>
                <div style="display:flex; align-items:center; gap:3px; flex:1;">
                  <span style="font-size:10px; color:var(--text3);">n=</span>
                  <input type="number" id="copy-prev-n" class="form-input" value="1" step="1"
                    style="padding:4px 8px; text-align:center;">
                </div>
              </div>
            </div>

            <button class="btn-primary" onclick="createCard()">✨ 카드 생성 완료</button>
          </div>

          <div id="panel-auto" class="panel-bd" style="display: none; padding:16px;">

            <!-- ── 파라미터 그리드 ── -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;">

              <!-- 티어 범위 -->
              <div>
                <div class="form-label">티어 범위</div>
                <div style="display:flex;gap:6px;align-items:center;">
                  <select id="ag-tier-from" class="form-input" style="width:72px;">
                    <option value="1">1T</option><option value="2">2T</option><option value="3">3T</option>
                    <option value="4">4T</option><option value="5">5T</option><option value="6">6T</option><option value="7">7T</option>
                  </select>
                  <span style="color:var(--text3);font-size:11px;">~</span>
                  <select id="ag-tier-to" class="form-input" style="width:72px;">
                    <option value="1">1T</option><option value="2">2T</option><option value="3">3T</option>
                    <option value="4">4T</option><option value="5">5T</option><option value="6">6T</option>
                    <option value="7" selected>7T</option>
                  </select>
                </div>
              </div>

              <!-- 티어당 카드 수 -->
              <div>
                <div class="form-label">티어당 카드 수 <span style="color:var(--text3);font-size:9px;">(일반 / 영웅 / 보스)</span></div>
                <div style="display:flex;gap:5px;">
                  <input id="ag-cnt-normal" class="form-input" type="number" min="0" max="20" value="5" style="width:52px;text-align:center;">
                  <input id="ag-cnt-hero"   class="form-input" type="number" min="0" max="20" value="2" style="width:52px;text-align:center;">
                  <input id="ag-cnt-boss"   class="form-input" type="number" min="0" max="20" value="1" style="width:52px;text-align:center;">
                </div>
              </div>

              <!-- 희귀도 가중치 -->
              <div>
                <div class="form-label">희귀도 가중치 <span style="color:var(--text3);font-size:9px;">(일반 / 영웅 / 보스)</span></div>
                <div style="display:flex;gap:5px;">
                  <input id="ag-w-normal" class="form-input" type="number" min="0.1" max="2" step="0.05" value="0.6" style="width:52px;text-align:center;">
                  <input id="ag-w-hero"   class="form-input" type="number" min="0.1" max="2" step="0.05" value="0.8" style="width:52px;text-align:center;">
                  <input id="ag-w-boss"   class="form-input" type="number" min="0.1" max="2" step="0.05" value="1.0" style="width:52px;text-align:center;">
                </div>
              </div>

              <!-- 세트 생성 옵션 -->
              <div>
                <div class="form-label">세트 자동 생성</div>
                <div style="display:flex;gap:5px;align-items:center;flex-wrap:wrap;">
                  <label style="display:flex;align-items:center;gap:4px;font-size:11px;color:var(--text2);cursor:pointer;">
                    <input type="checkbox" id="ag-gen-sets" checked style="accent-color:var(--gold);"> 세트도 생성
                  </label>
                  <div style="display:flex;align-items:center;gap:4px;font-size:11px;color:var(--text2);">
                    <span>Pair</span>
                    <input id="ag-set-pair"     class="form-input" type="number" min="0" max="30" value="8"  style="width:44px;text-align:center;">
                    <span>Triple</span>
                    <input id="ag-set-triple"   class="form-input" type="number" min="0" max="30" value="6"  style="width:44px;text-align:center;">
                    <span>Straight</span>
                    <input id="ag-set-straight" class="form-input" type="number" min="0" max="20" value="4"  style="width:44px;text-align:center;">
                  </div>
                </div>
              </div>
            </div>

            <!-- ── 기존 도감 처리 방식 ── -->
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:14px;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;">
              <span style="font-size:10px;color:var(--text2);">기존 도감 처리:</span>
              <label style="display:flex;align-items:center;gap:4px;font-size:11px;color:var(--text2);cursor:pointer;">
                <input type="radio" name="ag-mode" value="replace" checked style="accent-color:var(--gold);"> 전체 교체
              </label>
              <label style="display:flex;align-items:center;gap:4px;font-size:11px;color:var(--text2);cursor:pointer;">
                <input type="radio" name="ag-mode" value="append" style="accent-color:var(--gold);"> 추가
              </label>
            </div>

            <!-- ── 생성 버튼 ── -->
            <button class="btn-primary" onclick="runAutoGenerate()" style="margin-bottom:14px;">
              ⚡ 데이터 자동 생성
            </button>

            <!-- ── 미리보기 / 결과 ── -->
            <div id="ag-preview" style="display:none;">
              <div style="font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;color:var(--text3);text-transform:uppercase;margin-bottom:8px;">생성 결과 미리보기</div>
              <div id="ag-preview-body" style="font-size:10px;color:var(--text2);line-height:1.8;max-height:220px;overflow-y:auto;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;white-space:pre-wrap;"></div>
              <div style="display:flex;gap:6px;margin-top:10px;">
                <button class="btn-export" onclick="downloadAutoCSV('cards')"  style="flex:1;">⬇ MonsterCards_DB.csv</button>
                <button class="btn-export" onclick="downloadAutoCSV('sets')"   id="ag-dl-sets-btn" style="flex:1;">⬇ SetDefinitions_DB.csv</button>
                <button class="btn-primary" onclick="applyAutoGenerate()"      style="flex:1;padding:4px 8px;font-size:11px;">✅ 도감에 적용</button>
              </div>
            </div>

          </div>
        </div>
      </div>

      <div class="col">
        <div class="panel">
          <div class="panel-hd">
            <div class="panel-title">📦 카드 목록</div>
            <div style="margin-left:auto;display:flex;gap:6px;align-items:center;">
              <button class="btn-import" onclick="document.getElementById('csv-file-input').click()">⬆ CSV 가져오기</button>
              <input type="file" id="csv-file-input" accept=".csv" style="display:none;" onchange="importCSV(event)">
              <button class="btn-export" onclick="exportCSV()">⬇ CSV 내보내기</button>
              <button class="btn-danger" onclick="clearAll()">전체 삭제</button>
            </div>
          </div>
          <div class="panel-bd" style="padding:12px;">
            <div
              style="display:flex; flex-direction:column; gap:8px; margin-bottom:12px; padding:10px; background:var(--bg); border:1px solid var(--border); border-radius:8px;">
              <input type="text" id="master-search" class="form-input" placeholder="도감 카드명 검색..."
                oninput="renderCreatedList()">
              <div style="display:flex; gap:5px; align-items:center; flex-wrap:wrap;">
                <div class="filter-bar" id="master-filter" style="margin-bottom:0; flex:1;">
                  <div class="filter-chip active" onclick="filterMaster('all',this)">ALL</div>
                  <div class="filter-chip" onclick="filterMaster('1',this)">T1</div>
                  <div class="filter-chip" onclick="filterMaster('2',this)">T2</div>
                  <div class="filter-chip" onclick="filterMaster('3',this)">T3</div>
                  <div class="filter-chip" onclick="filterMaster('4',this)">T4</div>
                  <div class="filter-chip" onclick="filterMaster('5',this)">T5</div>
                  <div class="filter-chip" onclick="filterMaster('6',this)">T6</div>
                  <div class="filter-chip" onclick="filterMaster('7',this)">T7</div>
                </div>
                <select id="master-stat-filter" class="form-input" style="width:150px; font-size:11px;"
                  onchange="renderCreatedList()">
                  <option value="">스탯 필터: 전체</option>
                </select>
              </div>
            </div>
            <div class="card-list" id="created-list">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ── 강화 설정 탭 ── -->
  <div id="tab-config" class="tab-content" style="display:none;">
    <div style="max-width:700px;margin:0 auto;">
      <div class="panel" style="margin-bottom:16px;">
        <div class="panel-hd">
          <div class="panel-title">⚙️ 강화 확률 설정</div>
        </div>
        <div class="panel-bd">
          <table class="config-table">
            <thead>
              <tr>
                <th>강화 단계</th>
                <th>실패 확률 (%)</th>
                <th style="width:100px;"></th>
                <th>파괴 확률 (%)<br><span style="font-weight:400;font-size:8px;color:var(--text3)">(실패시 적용)</span></th>
                <th style="width:100px;"></th>
              </tr>
            </thead>
            <tbody id="config-tbody">
              <tr>
                <td><span class="config-lv-label" style="color:var(--e1)">0강 → +1강</span></td>
                <td>
                  <input class="config-input" type="number" min="0" max="100" value="0"
                    oninput="updateCfg(0,&#39;fail&#39;,this.value);updateProbBar(&#39;fbar0&#39;,0,this.value)">
                </td>
                <td>
                  <div class="prob-bar-wrap">
                    <div class="prob-bar" id="fbar0" style="width:0%;background:var(--red);"></div>
                  </div>
                </td>
                <td>
                  <input class="config-input" type="number" min="0" max="100" value="0"
                    oninput="updateCfg(0,&#39;destroy&#39;,this.value);updateProbBar(&#39;dbar0&#39;,0,this.value)">
                </td>
                <td>
                  <div class="prob-bar-wrap">
                    <div class="prob-bar" id="dbar0" style="width:0%;background:#ff3030;"></div>
                  </div>
                </td>
              </tr>
              <tr>
                <td><span class="config-lv-label" style="color:var(--e2)">1강 → +2강</span></td>
                <td>
                  <input class="config-input" type="number" min="0" max="100" value="20"
                    oninput="updateCfg(1,&#39;fail&#39;,this.value);updateProbBar(&#39;fbar1&#39;,20,this.value)">
                </td>
                <td>
                  <div class="prob-bar-wrap">
                    <div class="prob-bar" id="fbar1" style="width:20%;background:var(--red);"></div>
                  </div>
                </td>
                <td>
                  <input class="config-input" type="number" min="0" max="100" value="50"
                    oninput="updateCfg(1,&#39;destroy&#39;,this.value);updateProbBar(&#39;dbar1&#39;,50,this.value)">
                </td>
                <td>
                  <div class="prob-bar-wrap">
                    <div class="prob-bar" id="dbar1" style="width:50%;background:#ff3030;"></div>
                  </div>
                </td>
              </tr>
              <tr>
                <td><span class="config-lv-label" style="color:var(--e3)">2강 → +3강</span></td>
                <td>
                  <input class="config-input" type="number" min="0" max="100" value="50"
                    oninput="updateCfg(2,&#39;fail&#39;,this.value);updateProbBar(&#39;fbar2&#39;,50,this.value)">
                </td>
                <td>
                  <div class="prob-bar-wrap">
                    <div class="prob-bar" id="fbar2" style="width:50%;background:var(--red);"></div>
                  </div>
                </td>
                <td>
                  <input class="config-input" type="number" min="0" max="100" value="50"
                    oninput="updateCfg(2,&#39;destroy&#39;,this.value);updateProbBar(&#39;dbar2&#39;,50,this.value)">
                </td>
                <td>
                  <div class="prob-bar-wrap">
                    <div class="prob-bar" id="dbar2" style="width:50%;background:#ff3030;"></div>
                  </div>
                </td>
              </tr>
              <tr>
                <td><span class="config-lv-label" style="color:var(--e4)">3강 → +4강</span></td>
                <td>
                  <input class="config-input" type="number" min="0" max="100" value="70"
                    oninput="updateCfg(3,&#39;fail&#39;,this.value);updateProbBar(&#39;fbar3&#39;,70,this.value)">
                </td>
                <td>
                  <div class="prob-bar-wrap">
                    <div class="prob-bar" id="fbar3" style="width:70%;background:var(--red);"></div>
                  </div>
                </td>
                <td>
                  <input class="config-input" type="number" min="0" max="100" value="50"
                    oninput="updateCfg(3,&#39;destroy&#39;,this.value);updateProbBar(&#39;dbar3&#39;,50,this.value)">
                </td>
                <td>
                  <div class="prob-bar-wrap">
                    <div class="prob-bar" id="dbar3" style="width:50%;background:#ff3030;"></div>
                  </div>
                </td>
              </tr>
              <tr>
                <td><span class="config-lv-label" style="color:var(--e5)">4강 → +5강</span></td>
                <td>
                  <input class="config-input" type="number" min="0" max="100" value="90"
                    oninput="updateCfg(4,&#39;fail&#39;,this.value);updateProbBar(&#39;fbar4&#39;,90,this.value)">
                </td>
                <td>
                  <div class="prob-bar-wrap">
                    <div class="prob-bar" id="fbar4" style="width:90%;background:var(--red);"></div>
                  </div>
                </td>
                <td>
                  <input class="config-input" type="number" min="0" max="100" value="50"
                    oninput="updateCfg(4,&#39;destroy&#39;,this.value);updateProbBar(&#39;dbar4&#39;,50,this.value)">
                </td>
                <td>
                  <div class="prob-bar-wrap">
                    <div class="prob-bar" id="dbar4" style="width:50%;background:#ff3030;"></div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
          <div class="config-note">
            ✦ 실패 확률 : 강화 시도 시 해당 확률로 강화 수치가 변하지 않습니다.<br>
            ✦ 파괴 확률 : 강화 실패 시 해당 확률로 원본 카드가 소멸합니다.<br>
            ✦ 재료 카드 없이 동일 카드 단독으로 강화합니다. 실패해도 강화 수치는 유지됩니다.
          </div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-hd">
          <div class="panel-title">📜 강화 기록</div>
        </div>
        <div class="panel-bd" style="padding:10px;">
          <div class="enh-log" id="enh-log">
            <div
              style="font-size:10px;color:var(--text3);text-align:center;padding:8px;font-family:&#39;Rajdhani&#39;,sans-serif;">
              강화 기록이 없습니다</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ── 세트 조합 탭 ── -->
  <div id="tab-sets" class="tab-content" style="display: none;">
    <div class="main-grid" style="grid-template-columns:1fr 1fr;">

      <!-- 세트 목록 -->
      <div class="panel">
        <div class="panel-hd">
          <div class="panel-title">🃏 세트 효과 목록</div>
          <div style="margin-left:auto; display:flex; gap:6px; align-items:center;">
            <button class="btn-import" onclick="document.getElementById('set-csv-input').click()">⬆ CSV 가져오기</button>
            <input type="file" id="set-csv-input" accept=".csv" style="display:none;" onchange="importSetsCSV(event)">
            <button class="btn-export" onclick="exportSetsCSV()">⬇ CSV 내보내기</button>
            <span style="font-size:10px;color:var(--text3);font-family:'Rajdhani',sans-serif;margin-left:5px;">카드 장착 시
              자동 발동</span>
          </div>
        </div>
        <div class="panel-bd" style="padding:10px;">
          <div
            style="display:flex; flex-direction:column; gap:8px; margin-bottom:15px; padding:10px; background:var(--bg); border:1px solid var(--border); border-radius:8px;">
            <input type="text" id="set-search" class="form-input" placeholder="세트명 또는 카드명 검색..."
              oninput="renderSetDefsList()">

            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <button id="filter-grade-toggle" class="btn-sm" style="min-width:100px; border-color:var(--border3);"
                onclick="toggleGradeFilter()">등급: 전체</button>

              <select id="filter-stat-dropdown" class="form-input" style="width:160px; font-size:11px;"
                onchange="toggleStatFilter(this.value)">
                <option value="">스탯 필터: 전체</option>
              </select>
            </div>
          </div>
          <div id="set-defs-list">
            <div class="set-def-card grade-pair set-def-active">
              <div class="set-def-active-badge">⚡ 발동 중</div>
              <div class="set-def-name">문명과 야성</div>
              <div class="set-def-grade" style="background:var(--pair-c)20;color:var(--pair-c);">페어 · 2장</div>
              <div class="set-def-members"><span class="set-def-chip">누이안</span><span class="set-def-chip">오크</span>
              </div>
              <div class="set-def-desc">자연의 지혜와 야수의 힘이 어우러져 공격력과 방어력이 증가한다.</div>
              <div class="set-def-effect"><span class="set-def-efx-chip">+30 공격력</span><span
                  class="set-def-efx-chip">+20 물리 방어력</span></div>
              <div class="set-def-actions">
                <button class="btn-sm" onclick="editSetDef(&#39;set_001&#39;)">편집</button>
                <button class="btn-danger" onclick="deleteSetDef(&#39;set_001&#39;)">삭제</button>
              </div>
            </div>
            <div class="set-def-card grade-triple">

              <div class="set-def-name">죽음의 그림자</div>
              <div class="set-def-grade" style="background:var(--triple-c)20;color:var(--triple-c);">트리플 · 3장</div>
              <div class="set-def-members"><span class="set-def-chip">스켈레톤</span><span
                  class="set-def-chip">팬텀</span><span class="set-def-chip">말카바돈</span></div>
              <div class="set-def-desc">저승의 세 수호자가 모이면 공포가 현실이 된다. 모든 피해가 대폭 증가한다.</div>
              <div class="set-def-effect"><span class="set-def-efx-chip">+15% 주는 피해 증가</span><span
                  class="set-def-efx-chip">+10% PVE 대미지 증가</span></div>
              <div class="set-def-actions">
                <button class="btn-sm" onclick="editSetDef(&#39;set_002&#39;)">편집</button>
                <button class="btn-danger" onclick="deleteSetDef(&#39;set_002&#39;)">삭제</button>
              </div>
            </div>
            <div class="set-def-card grade-straight">

              <div class="set-def-name">인간과 정령</div>
              <div class="set-def-grade" style="background:var(--straight-c)20;color:var(--straight-c);">스트레이트 · 5장
              </div>
              <div class="set-def-members"><span class="set-def-chip">나무 정령</span><span class="set-def-chip">바위
                  정령</span><span class="set-def-chip">이끼 정령</span><span class="set-def-chip">물 정령</span><span
                  class="set-def-chip">누이안</span></div>
              <div class="set-def-desc">대지의 정령들과 인간이 하나가 되어 자연의 모든 힘을 이끌어낸다.</div>
              <div class="set-def-effect"><span class="set-def-efx-chip">+200 최대 체력</span><span
                  class="set-def-efx-chip">+5 체력 지속 회복량</span><span class="set-def-efx-chip">+10 스킬 가속</span></div>
              <div class="set-def-actions">
                <button class="btn-sm" onclick="editSetDef(&#39;set_003&#39;)">편집</button>
                <button class="btn-danger" onclick="deleteSetDef(&#39;set_003&#39;)">삭제</button>
              </div>
            </div>
            <div class="set-def-card grade-triple">

              <div class="set-def-name">물나무인간</div>
              <div class="set-def-grade" style="background:var(--triple-c)20;color:var(--triple-c);">트리플 · 3장</div>
              <div class="set-def-members"><span class="set-def-chip">나무 정령</span><span
                  class="set-def-chip">누이안</span><span class="set-def-chip">물 정령</span></div>
              <div class="set-def-desc">-</div>
              <div class="set-def-effect"><span class="set-def-efx-chip">+100 최대 체력</span></div>
              <div class="set-def-actions">
                <button class="btn-sm" onclick="editSetDef(&#39;set_vse2pjo&#39;)">편집</button>
                <button class="btn-danger" onclick="deleteSetDef(&#39;set_vse2pjo&#39;)">삭제</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 세트 추가/편집 -->
      <div class="panel">
        <div class="panel-hd">
          <div class="panel-title" id="set-form-title">✨ 새 세트 추가</div>
          <button class="btn-sm" style="margin-left:auto;font-size:10px;" onclick="resetSetForm()">초기화</button>
        </div>
        <div class="panel-bd" style="padding:14px;">

          <!-- 세트 이름 -->
          <div style="margin-bottom:10px;">
            <div class="form-label">세트 이름</div>
            <input id="sf-name" class="form-input" type="text" placeholder="ex) 문명과 야성">
          </div>

          <!-- 세트 등급 -->
          <div style="margin-bottom:10px;">
            <div class="form-label">세트 등급</div>
            <div style="display:flex;gap:6px;">
              <label class="grade-radio-label" id="grl-pair">
                <input type="radio" name="sf-grade" value="pair" checked="" onchange="onGradeChange(this)">
                <span style="color:var(--pair-c)">페어 (2장)</span>
              </label>
              <label class="grade-radio-label" id="grl-triple">
                <input type="radio" name="sf-grade" value="triple" onchange="onGradeChange(this)">
                <span style="color:var(--triple-c)">트리플 (3장)</span>
              </label>
              <label class="grade-radio-label" id="grl-straight">
                <input type="radio" name="sf-grade" value="straight" onchange="onGradeChange(this)">
                <span style="color:var(--straight-c)">스트레이트 (5장)</span>
              </label>
            </div>
          </div>

          <!-- 카드 구성 -->
          <div style="margin-bottom:10px;">
            <div class="form-label">구성 카드 <span id="sf-card-hint" style="color: var(--pair-c); font-weight: 700;">2장
                선택</span></div>
            <div id="sf-card-picker"
              style="display:flex;flex-wrap:wrap;gap:5px;max-height:140px;overflow-y:auto;padding:6px;background:var(--bg);border:1px solid var(--border);border-radius:6px;">
            </div>

            <!-- 세트 설명 -->
            <div style="margin-bottom:10px;">
              <div class="form-label">세트 효과 설명</div>
              <textarea id="sf-desc" class="form-input" rows="2" placeholder="세트 발동 시 효과 설명"></textarea>
            </div>

            <!-- 보너스 스탯 -->
            <div style="margin-bottom:12px;">
              <div class="form-label">보너스 스탯 <span style="color:var(--text3);font-size:9px;">(선택)</span></div>
              <div style="display:flex;gap:6px;margin-bottom:6px;">
                <select id="sf-stat-key" class="form-input" style="flex:1;">
                </select>
                <input id="sf-stat-val" class="form-input" type="number" placeholder="값" style="width:72px;">
                <button class="btn-sm" onclick="addSetStat()">+</button>
              </div>
              <div id="sf-stat-list" style="display:flex;flex-direction:column;gap:4px;"><span
                  style="font-size:10px;color:var(--text3);">보너스 스탯 없음</span></div>
            </div>

            <input type="hidden" id="sf-edit-id" value="">
            <button class="btn-primary" style="width:100%;" onclick="saveSetDef()">💾 세트 저장</button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- ── 강화 오버레이 ── -->
  <div class="enh-overlay" id="enh-overlay">
    <div class="enh-modal" id="enh-modal" onclick="event.stopPropagation()">

      <!-- 카드 헤더 -->
      <div class="enh-card-header" id="enh-header"></div>

      <!-- 확률 섹션 -->
      <div class="enh-section" id="enh-prob-section">
        <div class="enh-section-label">강화 확률</div>
        <div class="prob-grid" id="enh-prob-grid"></div>
      </div>

      <!-- 스탯 비교 -->
      <div class="enh-section" id="enh-stat-section">
        <div class="enh-section-label">강화 후 능력치 변화</div>
        <div class="stat-compare-grid" id="enh-stat-compare"></div>
      </div>

      <!-- 강화 버튼 -->
      <div class="enh-action">
        <button class="btn-enhance" id="enh-do-btn" onclick="doEnhance()">🔥 강화 시도</button>
        <div class="enh-action-note" id="enh-action-note"></div>
      </div>
    </div>
  </div>

  <!-- ── 카드 툴팁 오버레이 ── -->
  <div class="card-tooltip-overlay" id="card-tooltip-overlay" onclick="closeCardTooltip()">
    <div class="card-tooltip-modal" id="card-tooltip-modal" onclick="event.stopPropagation()">
      <div class="ctt-header" id="ctt-header"></div>
      <div class="ctt-body" id="ctt-body"></div>
      <div class="ctt-footer" id="ctt-footer"></div>
    </div>
  </div>

  <!-- 강화 결과 팝업 -->
  <div class="result-overlay" id="result-overlay">
    <div class="result-box" id="result-box">
      <div class="sparks" id="result-sparks"></div>
      <div class="result-ico" id="result-ico"></div>
      <div class="result-title" id="result-title"></div>
      <div class="result-desc" id="result-desc"></div>
      <button class="btn-primary" style="width:160px;margin:0 auto;" onclick="closeResult()">확인</button>
    </div>
  </div>

  <!-- 카드 선택 모달 (슬롯용) -->
  <div class="modal-overlay" id="card-modal">
    <div class="modal-inner">
      <div class="modal-hd">
        <div class="modal-title" id="modal-title">카드 선택</div>
        <button class="modal-close-btn" onclick="closeModal()">✕</button>
      </div>
      <div class="modal-body">
        <div class="card-list" id="modal-card-list"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="">슬롯 2에 "바위 정령" 장착!</div>

  <script>
    // ==========================================
    // 상수 / 상태
    // ==========================================
    let cards = []; // 마스터 도감 데이터
    let userInventory = [];   // 유저가 실제로 소유한 카드 (인벤토리)
    let slots = [null, null, null, null, null];

    // ── 세트 정의 DB ──
    // { id, name, cardTypes:[], size:2|3|5, grade:'pair'|'triple'|'straight', desc, effect:{} }
    let setDefs = [
      // 1. 스트레이트 (고티어 말카바돈 포함으로 난이도 상승)
      {
        id: 'set_str_abyss', name: '심연의 개척자',
        cardTypes: ['누이안', '오크', '놀', '스켈레톤', '말카바돈'],
        size: 5, grade: 'straight',
        desc: '심연의 힘과 개척자의 의지가 만나 최강의 성능을 발휘합니다.',
        effect: { AttackVary: 50, MaxHpVary: 300, DamageUpVaryper: 15 }
      },
      // 2. 트리플 (정령 조합)
      {
        id: 'set_tri_element', name: '원소의 인도자',
        cardTypes: ['물 정령', '나무 정령', '바위 정령'],
        size: 3, grade: 'triple',
        desc: '순수 원소 정령들이 마력의 흐름을 원활하게 합니다.',
        effect: { SkillCooldownAccVary: 20, RegenMpVary: 10 }
      },
      {
        id: 'set_tri_earth', name: '대지의 수호자',
        cardTypes: ['이끼 정령', '나무 정령', '바위 정령'],
        size: 3, grade: 'triple',
        desc: '대지의 기운을 머금은 정령들이 견고한 방어를 제공합니다.',
        effect: { PhysicalDefenseVary: 40, SCNegativeRecoveryVary: 15 }
      },
      // 3. 페어 (기초 성능)
      {
        id: 'set_pair_wild', name: '야성의 지배자',
        cardTypes: ['오크 족장', '놀 우두머리'],
        size: 2, grade: 'pair',
        desc: '야생의 우두머리들이 빠른 속도를 선사합니다.',
        effect: { AtkSpeedVaryper: 1.5, MoveSpeedVaryper: 1.0 }
      },
      {
        id: 'set_pair_phantom', name: '망령의 기습',
        cardTypes: ['팬텀', '스켈레톤'],
        size: 2, grade: 'pair',
        desc: '어둠 속의 망령들이 치명적인 일격을 돕습니다.',
        effect: { CriVaryper: 3.0, AttackVary: 10 }
      },
      {
        id: 'set_pair_nature', name: '자연의 공명',
        cardTypes: ['이끼 정령', '물 정령'],
        size: 2, grade: 'pair',
        desc: '자연의 정령들이 끊임없는 생명력을 부여합니다.',
        effect: { RegenHpVary: 5, RegenMpVary: 5 }
      }
    ];
    let selTierVal = null;
    let selIconVal = '🔥';
    let invFilterVal = 'all';
    let dragCardId = null;
    let dragFromSlot = null;
    let activeModalSlot = null;
    let enhTargetId = null; // 현재 강화 오버레이에 열려있는 카드 ID

    // 강화 설정
    let enhConfig = [
      { fail: 0, destroy: 0 },
      { fail: 20, destroy: 50 },
      { fail: 50, destroy: 50 },
      { fail: 70, destroy: 50 },
      { fail: 90, destroy: 50 },
    ];

    const ICONS = ['🔥', '💧', '⚡', '🌿', '🌑', '❄️', '🐉', '🐺', '🦂', '🦁', '🐸', '🦊', '🦇', '🕷️', '💀', '⚔️', '🗡️', '🛡️', '🌀', '🌪️', '🔮', '💎', '👹', '👺', '🐲', '🦅', '🐍', '🦈', '🐯', '🦋'];

    // StatExpose.csv 기반 실제 스탯 목록
    // key: StatName(영문), label: 한글명, unit: 단위, sortOrder: 정렬
    const STAT_DEFS = [
      { key: 'AttackVary', label: '공격력', unit: '', sort: 1 },
      { key: 'PhysicalDefenseVary', label: '물리 방어력', unit: '', sort: 2 },
      { key: 'MagicDefenseVary', label: '마법 방어력', unit: '', sort: 3 },
      { key: 'AtkSpeedVaryper', label: '공격 속도', unit: '%', sort: 4 },
      { key: 'MoveSpeedVaryper', label: '이동 속도', unit: '%', sort: 5 },
      { key: 'MaxHpVary', label: '최대 체력', unit: '', sort: 6 },
      { key: 'MaxMpVary', label: '최대 마력', unit: '', sort: 7 },
      { key: 'RegenHpVary', label: '체력 지속 회복량', unit: '', sort: 8 },
      { key: 'RegenMpVary', label: '마력 지속 회복량', unit: '', sort: 9 },
      { key: 'DamageUpVaryper', label: '주는 피해 증가', unit: '%', sort: 10 },
      { key: 'DamageDownVaryper', label: '받는 피해 감소', unit: '%', sort: 11 },
      { key: 'PhysicalDamageUpVaryper', label: '물리 피해 증가', unit: '%', sort: 12 },
      { key: 'PhysicalDamageDownVaryper', label: '물리 피해 감소', unit: '%', sort: 13 },
      { key: 'MagicDamageUpVaryper', label: '마법 피해 증가', unit: '%', sort: 14 },
      { key: 'MagicDamageDownVaryper', label: '마법 피해 감소', unit: '%', sort: 15 },
      { key: 'PVEDamageUpVaryper', label: 'PVE 대미지 증가', unit: '%', sort: 16 },
      { key: 'PVEDamageDownVaryper', label: 'PVE 대미지 감소', unit: '%', sort: 17 },
      { key: 'PVPDamageUpVaryper', label: 'PVP 대미지 증가', unit: '%', sort: 18 },
      { key: 'PVPDamageDownVaryper', label: 'PVP 대미지 감소', unit: '%', sort: 19 },
      { key: 'DodgeVaryper', label: '회피', unit: '%', sort: 20 },
      { key: 'CriVaryper', label: '치명타 확률', unit: '%', sort: 21 },
      { key: 'CriDamageVaryper', label: '치명타 피해 증가', unit: '%', sort: 22 },
      { key: 'SkillCooldownAccVary', label: '스킬 가속', unit: '', sort: 23 },
      { key: 'SCNegativeRecoveryVary', label: '상태 이상 회복', unit: '', sort: 24 },
      { key: 'CostMpDownVaryper', label: '마나 소모량 감소', unit: '%', sort: 25 },
      { key: 'MountSpeedVaryper', label: '탈 것 이동 속도', unit: '%', sort: 26 },
    ];
    // 편의용 맵
    const STAT_MAP = Object.fromEntries(STAT_DEFS.map(s => [s.key, s]));
    const TCOLOR = { 1: 'var(--t1)', 2: 'var(--t2)', 3: 'var(--t3)', 4: 'var(--t4)', 5: 'var(--t5)', 6: 'var(--t6)', 7: 'var(--t7)' };
    const ECOLOR = { 1: 'var(--e1)', 2: 'var(--e2)', 3: 'var(--e3)', 4: 'var(--e4)', 5: 'var(--e5)' };
    const ENH_MULT = { 0: 1.00, 1: 1.10, 2: 1.22, 3: 1.36, 4: 1.52, 5: 1.70 };
    const TIER_BG = {
      1: 'rgba(156,163,175,.08)', 2: 'rgba(74,222,128,.06)',
      3: 'rgba(56,189,248,.06)', 4: 'rgba(167,139,250,.06)',
      5: 'rgba(249,115,22,.06)', 6: 'rgba(244,63,94,.06)',
      7: 'rgba(251,191,36,.08)'
    };

    // ==========================================
    // 초기화
    // ==========================================
    function init() {
      // 세트 폼 스탯 드롭다운 초기화
      const sfStatKey = document.getElementById('sf-stat-key');
      if (sfStatKey) {
        sfStatKey.innerHTML = `<option value="">스탯 선택</option>` +
          STAT_DEFS.map(s => `<option value="${s.key}">${s.label}${s.unit ? '(' + s.unit + ')' : ''}</option>`).join('');
      }
      renderIconGrid();
      renderSlots();
      renderConfigTable();
      loadSamples();

      // 데이터 로드 직후 모든 탭의 리스트를 강제 갱신
      renderAll();
      if (typeof renderSetFormCardPicker === 'function') renderSetFormCardPicker();
      renderStatFilterDropdown();
      renderMasterStatDropdown();
    }

    // 카드 생성 탭 내 서브 탭(수동/자동) 전환 함수
    function switchSubTab(sub) {
      const manualPanel = document.getElementById('panel-manual');
      const autoPanel = document.getElementById('panel-auto');
      const manualBtn = document.getElementById('sub-tab-manual');
      const autoBtn = document.getElementById('sub-tab-auto');

      // 1. 모든 패널 숨기기
      if (manualPanel) manualPanel.style.display = 'none';
      if (autoPanel) autoPanel.style.display = 'none';

      // 2. 모든 버튼 활성화 스타일 제거
      if (manualBtn) {
        manualBtn.classList.remove('active');
        manualBtn.style.borderBottom = 'none';
      }
      if (autoBtn) {
        autoBtn.classList.remove('active');
        autoBtn.style.borderBottom = 'none';
      }

      // 3. 선택된 탭만 활성화
      if (sub === 'manual') {
        if (manualPanel) manualPanel.style.display = 'block';
        if (manualBtn) {
          manualBtn.classList.add('active');
          manualBtn.style.borderBottom = '2px solid var(--gold)';
        }
      } else {
        if (autoPanel) autoPanel.style.display = 'block';
        if (autoBtn) {
          autoBtn.classList.add('active');
          autoBtn.style.borderBottom = '2px solid var(--gold)';
        }
      }
    }

    // PrototypeDB.csv 기반 카드 데이터
    // 업그레이드 단계 0~5 를 강화 레벨에 매핑 (enhance=0 → step0 스탯 사용)
    // card.upgradeStats[step] = { StatKey: value }
    const PROTOTYPE_DB = [
      // Cid 17010001 - 누이안 카드 (Tier1, 최대 체력)
      {
        cid: '17010001', name: '누이안', type: '누이안', icon: '🌿', tier: 1,
        upgradeStats: [
          { MaxHpVary: 25 }, { MaxHpVary: 40 }, { MaxHpVary: 55 }, { MaxHpVary: 70 }, { MaxHpVary: 85 }, { MaxHpVary: 100 }
        ],
        setEffects: { pair: '최대 체력 +5%', triple: '최대 체력 +12%, 체력 회복 +3', straight: '생명의 가호: 체력 상한 +20%' }
      },
      // Cid 17010002 - 오크 카드 (Tier1, 물리 방어력)
      {
        cid: '17010002', name: '오크', type: '오크', icon: '👹', tier: 1,
        upgradeStats: [
          { PhysicalDefenseVary: 10 }, { PhysicalDefenseVary: 15 }, { PhysicalDefenseVary: 20 }, { PhysicalDefenseVary: 25 }, { PhysicalDefenseVary: 30 }, { PhysicalDefenseVary: 35 }
        ],
        setEffects: { pair: '물리 방어 +5%', triple: '물리 방어 +12%, 받는 피해 감소 +2%', straight: '철벽: 물리 피해 감소 +10%' }
      },
      // Cid 17010003 - 놀 카드 (Tier1, 물리 방어력)
      {
        cid: '17010003', name: '놀', type: '놀', icon: '🦁', tier: 1,
        upgradeStats: [
          { PhysicalDefenseVary: 10 }, { PhysicalDefenseVary: 15 }, { PhysicalDefenseVary: 20 }, { PhysicalDefenseVary: 25 }, { PhysicalDefenseVary: 30 }, { PhysicalDefenseVary: 35 }
        ],
        setEffects: { pair: '물리 방어 +5%', triple: '물리 방어 +10%, 이동속도 +2%', straight: '맹수의 기운: 공격력 +8%' }
      },
      // Cid 17010004 - 스켈레톤 카드 (Tier1, 체력 지속 회복량)
      {
        cid: '17010004', name: '스켈레톤', type: '스켈레톤', icon: '💀', tier: 1,
        upgradeStats: [
          { RegenHpVary: 3 }, { RegenHpVary: 5 }, { RegenHpVary: 7 }, { RegenHpVary: 9 }, { RegenHpVary: 11 }, { RegenHpVary: 13 }
        ],
        setEffects: { pair: '체력 회복 +2', triple: '체력 회복 +5, 최대 체력 +50', straight: '불사의 인내: 전투 중 체력 회복 +20%' }
      },
      // Cid 17010005 - 팬텀 카드 (Tier1, 공격력)
      {
        cid: '17010005', name: '팬텀', type: '팬텀', icon: '🌑', tier: 1,
        upgradeStats: [
          { AttackVary: 3 }, { AttackVary: 5 }, { AttackVary: 7 }, { AttackVary: 9 }, { AttackVary: 11 }, { AttackVary: 13 }
        ],
        setEffects: { pair: '공격력 +4%', triple: '공격력 +10%, 치명타 확률 +1%', straight: '유령의 습격: 주는 피해 +8%' }
      },
      // Cid 17010006 - 물 정령 카드 (Tier1, 마력 지속 회복량)
      {
        cid: '17010006', name: '물 정령', type: '물 정령', icon: '💧', tier: 1,
        upgradeStats: [
          { RegenMpVary: 3 }, { RegenMpVary: 5 }, { RegenMpVary: 7 }, { RegenMpVary: 9 }, { RegenMpVary: 11 }, { RegenMpVary: 13 }
        ],
        setEffects: { pair: '마력 회복 +2', triple: '마력 회복 +5, 마나 소모 -2%', straight: '정령의 흐름: 스킬 쿨타임 -5%' }
      },
      // Cid 17010007 - 나무 정령 카드 (Tier1, 스킬 가속)
      {
        cid: '17010007', name: '나무 정령', type: '나무 정령', icon: '🌿', tier: 1,
        upgradeStats: [
          { SkillCooldownAccVary: 3 }, { SkillCooldownAccVary: 5 }, { SkillCooldownAccVary: 7 }, { SkillCooldownAccVary: 9 }, { SkillCooldownAccVary: 11 }, { SkillCooldownAccVary: 13 }
        ],
        setEffects: { pair: '스킬 가속 +2', triple: '스킬 가속 +5, 마력 회복 +2', straight: '자연의 리듬: 스킬 쿨타임 -8%' }
      },
      // Cid 17010008 - 바위 정령 카드 (Tier1, 스킬 가속)
      {
        cid: '17010008', name: '바위 정령', type: '바위 정령', icon: '🪨', tier: 1,
        upgradeStats: [
          { SkillCooldownAccVary: 3 }, { SkillCooldownAccVary: 5 }, { SkillCooldownAccVary: 7 }, { SkillCooldownAccVary: 9 }, { SkillCooldownAccVary: 11 }, { SkillCooldownAccVary: 13 }
        ],
        setEffects: { pair: '스킬 가속 +2', triple: '스킬 가속 +5, 물리 방어 +5', straight: '대지의 의지: 받는 피해 -5%' }
      },
      // Cid 17010009 - 이끼 정령 카드 (Tier1, 스킬 가속)
      {
        cid: '17010009', name: '이끼 정령', type: '이끼 정령', icon: '🌱', tier: 1,
        upgradeStats: [
          { SkillCooldownAccVary: 3 }, { SkillCooldownAccVary: 5 }, { SkillCooldownAccVary: 7 }, { SkillCooldownAccVary: 9 }, { SkillCooldownAccVary: 11 }, { SkillCooldownAccVary: 13 }
        ],
        setEffects: { pair: '스킬 가속 +2', triple: '스킬 가속 +5, 이동 속도 +1%', straight: '이끼의 연환: 상태이상 회복 +10' }
      },
      // Cid 17020001 - 오크 족장 카드 (Tier1, 공격 속도%)
      {
        cid: '17020001', name: '오크 족장', type: '오크 족장', icon: '⚔️', tier: 2,
        upgradeStats: [
          { AtkSpeedVaryper: 0.4 }, { AtkSpeedVaryper: 0.6 }, { AtkSpeedVaryper: 0.8 }, { AtkSpeedVaryper: 1.0 }, { AtkSpeedVaryper: 1.2 }, { AtkSpeedVaryper: 1.4 }
        ],
        setEffects: { pair: '공격 속도 +0.5%', triple: '공격 속도 +1%, 공격력 +5%', straight: '족장의 함성: 공격력 +15%' }
      },
      // Cid 17020002 - 놀 우두머리 카드 (Tier2, 이동 속도%)
      {
        cid: '17020002', name: '놀 우두머리', type: '놀 우두머리', icon: '🦅', tier: 2,
        upgradeStats: [
          { MoveSpeedVaryper: 0.3 }, { MoveSpeedVaryper: 0.5 }, { MoveSpeedVaryper: 0.7 }, { MoveSpeedVaryper: 0.9 }, { MoveSpeedVaryper: 1.1 }, { MoveSpeedVaryper: 1.3 }
        ],
        setEffects: { pair: '이동 속도 +0.5%', triple: '이동 속도 +1%, 회피 +1%', straight: '우두머리의 기동: PVE 대미지 +8%' }
      },
      // Cid 17030001 - 스칼니토스 카드 (Tier3, PVE 대미지 감소%)
      {
        cid: '17030001', name: '스칼니토스', type: '스칼니토스', icon: '🦂', tier: 3,
        upgradeStats: [
          { PVEDamageDownVaryper: 0.2 }, { PVEDamageDownVaryper: 0.3 }, { PVEDamageDownVaryper: 0.4 }, { PVEDamageDownVaryper: 0.5 }, { PVEDamageDownVaryper: 0.6 }, { PVEDamageDownVaryper: 0.7 }
        ],
        setEffects: { pair: 'PVE 피해 감소 +0.3%', triple: 'PVE 피해 감소 +0.7%, 물리 방어 +10', straight: '스칼니토스의 갑주: 받는 피해 감소 +3%' }
      },
      // Cid 17030002 - 말카바돈 카드 (Tier3, PVE 대미지 증가%)
      {
        cid: '17030002', name: '말카바돈', type: '말카바돈', icon: '🐲', tier: 3,
        upgradeStats: [
          { PVEDamageUpVaryper: 0.2 }, { PVEDamageUpVaryper: 0.3 }, { PVEDamageUpVaryper: 0.4 }, { PVEDamageUpVaryper: 0.5 }, { PVEDamageUpVaryper: 0.6 }, { PVEDamageUpVaryper: 0.7 }
        ],
        setEffects: { pair: 'PVE 대미지 +0.3%', triple: 'PVE 대미지 +0.7%, 공격력 +8', straight: '말카바돈의 분노: 주는 피해 증가 +5%' }
      },
    ];

    function loadSamples() {
      // PROTOTYPE_DB 데이터를 마스터 도감(cards)에 채웁니다.
      cards = PROTOTYPE_DB.map(db => ({
        id: uid(), // 도감용 고유 ID (인스턴스와 구분용)
        cid: db.cid,
        name: db.name,
        type: db.type,
        icon: db.icon,
        tier: db.tier,
        upgradeStats: db.upgradeStats,
        stats: { ...db.upgradeStats[0] },
        setEffects: db.setEffects,
        enhance: 0,
      }));

      // [추가] 처음 시작 시 도감의 첫 번째 카드를 유저 인벤토리에 하나 넣어줍니다 (테스트용)
      if (cards.length > 0) {
        obtainCard(cards[0].cid);
      }
      renderAll();
    }

    function uid() { return Math.random().toString(36).slice(2, 9); }

    // ==========================================
    // 스탯 계산
    // ==========================================
    // 강화 레벨 → 업그레이드 단계 매핑: enhance 0~5 → step 0~5
    function effStats(card) {
      // upgradeStats가 있으면 강화 단계에 맞는 스탯 사용
      if (card.upgradeStats) {
        const step = Math.min(card.enhance, card.upgradeStats.length - 1);
        return { ...card.upgradeStats[step] };
      }
      // 레거시(직접 생성 카드): 구 방식 배율 적용
      const m = ENH_MULT[card.enhance] || 1;
      const r = {};
      for (const [k, v] of Object.entries(card.stats || {})) r[k] = Math.round(v * m);
      return r;
    }

    // ==========================================
    // 전체 렌더
    // ==========================================
    function renderAll() {
      renderInventory();
      renderCreatedList();
      renderSlots();
      renderEffectSummary();
      renderEquipSetList();
    }

    // ── 아이콘 그리드 ──
    function renderIconGrid() {
      document.getElementById('icon-grid').innerHTML = ICONS.map(ic =>
        `<div class="icon-btn${ic === selIconVal ? ' active' : ''}" onclick="selIcon('${ic}')">${ic}</div>`
      ).join('');
    }

    // ── 인벤토리 ──
    function renderInventory() {
      const el = document.getElementById('inv-list');
      if (!el) return;

      document.getElementById('inv-count').textContent = userInventory.length + '장';
      const eqIds = slots.filter(Boolean).map(c => c.id);

      // 1. 선택된 필터 값 가져오기
      const statFilter = document.getElementById('inv-stat-filter')?.value || "";

      // 2. 필터링 로직 (티어 + 스탯)
      let list = userInventory.filter(c => {
        // 티어 체크
        const matchTier = invFilterVal === 'all' || String(c.tier) === invFilterVal;

        // 스탯 체크: 현재 강화 단계(effStats)에서 해당 스탯이 0보다 큰지 확인
        const eff = effStats(c);
        const matchStat = !statFilter || (eff[statFilter] && eff[statFilter] > 0);

        return matchTier && matchStat;
      });

      // 3. [개별 장착 편의성] 필터링된 스탯 값이 높은 순서대로 정렬 (선택 사항)
      if (statFilter) {
        list.sort((a, b) => (effStats(b)[statFilter] || 0) - (effStats(a)[statFilter] || 0));
      }

      if (!list.length) {
        el.innerHTML = `<div class="empty"><div class="empty-ico">🎴</div>조건에 맞는 카드가 없습니다.</div>`;
        return;
      }

      el.innerHTML = list.map(c => cardItemHTML(c, eqIds.includes(c.id), 'inv')).join('');
    }

    // 전역 상태 변수 추가
    let masterFilterVal = 'all';

    // [추가] 도감 필터링 함수
    function filterMaster(f, el) {
      masterFilterVal = f;
      document.querySelectorAll('#master-filter .filter-chip').forEach(c => c.classList.remove('active'));
      el.classList.add('active');
      renderCreatedList();
    }

    // ── 생성 목록 ──
    function renderCreatedList() {
      const el = document.getElementById('created-list');
      const searchKeyword = document.getElementById('master-search')?.value.trim().toLowerCase() || "";
      const statFilter = document.getElementById('master-stat-filter')?.value || "";

      if (!cards.length) {
        el.innerHTML = `<div class="empty">등록된 도감이 없습니다.</div>`;
        return;
      }

      // 필터링 로직: 티어, 검색어, 개별 스탯 체크
      let filtered = cards.filter(c => {
        const matchTier = masterFilterVal === 'all' || String(c.tier) === masterFilterVal;
        const matchName = c.name.toLowerCase().includes(searchKeyword);
        const matchStat = !statFilter || (c.upgradeStats && c.upgradeStats[0][statFilter]);
        return matchTier && matchName && matchStat;
      });

      if (!filtered.length) {
        el.innerHTML = `<div class="empty">조건에 맞는 카드가 없습니다.</div>`;
        return;
      }

      el.innerHTML = filtered.map(c => {
        const displayName = searchKeyword
          ? c.name.replace(new RegExp(`(${searchKeyword})`, 'gi'), `<span style="color:var(--gold); font-weight:bold;">$1</span>`)
          : c.name;

        // 0강(Base) 스탯 칩 생성
        const baseStats = c.upgradeStats ? c.upgradeStats[0] : {};
        const statChips = Object.entries(baseStats).map(([k, v]) => {
          const d = STAT_MAP[k];
          return `<span style="display:inline-block; font-size:9px; background:rgba(255,255,255,0.05); padding:1px 5px; border-radius:3px; margin-right:4px; color:var(--text2); border: 1px solid var(--border);">
        ${d ? d.label : k} +${v}${d ? d.unit : ''}
      </span>`;
        }).join('');

        return `
      <div class="card-item ani" data-tier="${c.tier}" data-id="${c.id}" onclick="openCardTooltip('${c.id}')" style="align-items: flex-start;">
        <div class="card-icon" style="width:40px; height:40px; font-size:22px;">${c.icon}</div>
        <div class="card-info" style="flex:1; min-width:0; margin-left:12px;">
          <div style="display:flex; align-items:center; gap:5px; margin-bottom:4px;">
            <span class="card-tier-badge tb${c.tier}">T${c.tier}</span>
            <span class="card-name" style="font-size:13px;">${displayName}</span>
            <span style="font-size:9px; color:var(--gold); opacity:0.8; font-family:'Rajdhani',sans-serif;">[${c.cid}]</span>
          </div>
          
          <div style="display:flex; flex-wrap:wrap; gap:3px; margin-bottom:8px;">
            ${statChips}
          </div>

          <div style="margin-top:5px; display:flex; gap:5px;">
            <button class="btn-import" style="padding: 4px 10px; font-size: 10px;" onclick="event.stopPropagation(); obtainCard('${c.cid}')">➕ 인벤토리 획득</button>
            <button class="btn-danger" style="padding: 4px 10px; font-size: 10px;" onclick="event.stopPropagation(); deleteCard('${c.id}')">도감 삭제</button>
          </div>
        </div>
      </div>`;
      }).join('');
    }



    // ── 카드 HTML 빌더 ──
    function cardItemHTML(card, equipped, mode) {
      const eff = effStats(card);
      const statsHtml = Object.entries(eff).filter(([, v]) => v > 0)
        .map(([k, v]) => {
          const def = STAT_MAP[k];
          const unit = def ? def.unit : '';
          const label = def ? def.label : k;
          return `<span class="stat-chip">+${v}${unit} ${label}</span>`;
        }).join('');
      const enhBadge = card.enhance > 0
        ? `<span class="enh-badge lv${card.enhance}">+${card.enhance}강</span>`
        : `<span class="enh-badge">0강</span>`;

      // [추가] 카드 목록(생성 탭)에서만 CID 노출
      const cidBadge = (mode === 'created' || mode === 'inv')
        ? `<span style="font-family:'Rajdhani',sans-serif; font-size:9px; color:var(--gold); font-weight:700; margin-left:4px; opacity:0.8;">[${card.cid}]</span>`
        : '';

      // 우측 액션
      let actionBtns = '';
      if (mode === 'inv') {
        const eqBtn = equipped
          ? `<span style="font-size:9px;color:var(--green);font-family:'Rajdhani',sans-serif;font-weight:700;letter-spacing:.5px;">✓장착</span>`
          : `<button class="btn-sm" onclick="event.stopPropagation();quickEquip('${card.id}')">장착</button>`;
        actionBtns = `<div style="display:flex;gap:4px;align-items:center;margin-top:5px;">
      ${eqBtn}
      <button class="btn-enh" onclick="event.stopPropagation();openEnhOverlay('${card.id}')">🔥강화</button>
      <button class="btn-danger" onclick="event.stopPropagation();deleteCard('${card.id}')">삭제</button>
    </div>`;
      } else if (mode === 'created') {
        actionBtns = `<div style="margin-top:5px;"><button class="btn-danger" onclick="deleteCard('${card.id}')">삭제</button></div>`;
      } else if (mode === 'modal-slot') {
        actionBtns = `<div style="margin-top:5px;"><button class="btn-sm" onclick="equipFromModal('${card.id}')">선택</button></div>`;
      }

      const clickHandler = `onclick="openCardTooltip('${card.id}')"`;

      return `<div class="card-item${equipped ? ' equipped' : ''} ani" data-tier="${card.tier}" data-id="${card.id}"
    ${clickHandler} draggable="true" ondragstart="if(document.getElementById('enh-overlay').classList.contains('open')){event.preventDefault();return;}onDragStart(event,'${card.id}',null)">
    <div class="card-icon">${card.icon}</div>
    <div class="card-info" style="flex:1;min-width:0;">
      <div style="display:flex;align-items:center;gap:5px;flex-wrap:nowrap;overflow:hidden;">
        <span class="card-tier-badge tb${card.tier}" style="flex-shrink:0;">T${card.tier}</span>
        ${enhBadge}
        <span class="card-name" style="font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${card.name}</span>
        ${cidBadge} </div>
      <div class="card-stats-row">${statsHtml || '<span style="color:var(--text3)">스탯 없음</span>'}</div>
      ${actionBtns}
    </div>
  </div>`;
    }

    // ── 슬롯 ──
    function renderSlots() {
      const el = document.getElementById('slots-grid');
      el.innerHTML = slots.map((card, i) => {
        if (!card) return `
      <div class="slot" id="slot-${i}"
        ondragover="onDragOverSlot(event,${i})" ondrop="onDropSlot(event,${i})" ondragleave="onDragLeaveSlot(${i})"
        onclick="openSlotModal(${i})">
        <div class="slot-num">SLOT ${i + 1}</div>
        <div class="slot-empty-ico">⬜</div>
        <div class="slot-empty-txt">드래그 또는 클릭</div>
      </div>`;
        const eff = effStats(card);
        const statLines = Object.entries(eff).filter(([, v]) => v > 0).map(([k, v]) => {
          const def = STAT_MAP[k]; return `+${v}${def ? def.unit : ''} ${def ? def.label : k}`;
        }).join('<br>');
        const ec = card.enhance > 0 ? ECOLOR[card.enhance] : 'var(--text3)';
        return `
      <div class="slot filled" id="slot-${i}" data-tier="${card.tier}"
        ondragover="onDragOverSlot(event,${i})" ondrop="onDropSlot(event,${i})" ondragleave="onDragLeaveSlot(${i})"
        draggable="true" ondragstart="onDragStart(event,'${card.id}',${i})"
        onclick="openCardTooltip('${card.id}')">
        <div class="slot-num">SLOT ${i + 1}</div>
        <div class="slot-remove" onclick="event.stopPropagation();unequipSlot(${i})">✕</div>
        <div class="slot-ico">${card.icon}</div>
        <div class="slot-name">${card.name}</div>
        <div class="slot-tier" style="color:${TCOLOR[card.tier]}">T${card.tier} · ${card.type}</div>
        ${card.enhance > 0 ? `<div class="slot-enh" style="color:${ec}">+${card.enhance}강</div>` : ''}
        <div class="slot-stats">${statLines}</div>
        <button class="slot-enh-btn" onclick="event.stopPropagation();openEnhOverlay('${card.id}')">🔥 강화</button>
      </div>`;
      }).join('');
    }

    // ── 효과 합산 ──
    function renderEffectSummary() {
      const el = document.getElementById('effect-summary');
      const equipped = slots.filter(Boolean);

      if (equipped.length === 0) {
        el.innerHTML = `<div class="empty" style="padding:16px;">장착된 카드가 없습니다.</div>`;
        renderEquipSetList(); // 독립 패널은 항상 최신화
        return;
      }

      const { active: activeSets } = calcActiveSetEffects(equipped);

      // 1. 개별 카드 스탯 합산
      const individualStats = {};
      equipped.forEach(c => {
        const e = effStats(c);
        Object.entries(e).forEach(([k, v]) => { individualStats[k] = (individualStats[k] || 0) + v; });
      });

      // 2. [추가] 활성화된 모든 세트 보너스 합산
      const setBonusSum = {};
      activeSets.forEach(def => {
        Object.entries(def.effect || {}).forEach(([k, v]) => {
          setBonusSum[k] = (setBonusSum[k] || 0) + v;
        });
      });

      // 3. 최종 합산 및 렌더링
      const allKeys = new Set([...Object.keys(individualStats), ...Object.keys(setBonusSum)]);
      let html = `<div class="total-stats">`;

      // 세트 효과 합산 정보가 있을 경우 상단에 요약 노출
      if (activeSets.length > 0) {
        html += `<div style="margin-bottom:10px; padding:8px; background:rgba(232,184,75,0.05); border:1px solid rgba(232,184,75,0.2); border-radius:6px;">
      <div style="font-size:10px; color:var(--gold); font-weight:700; margin-bottom:4px;">⚡ 적용 중인 세트 효과 합계</div>
      <div style="display:flex; flex-wrap:wrap; gap:5px;">`;
        Object.entries(setBonusSum).forEach(([k, v]) => {
          const d = STAT_MAP[k];
          html += `<span style="font-size:10px; color:var(--gold2);">+${v}${d ? d.unit : ''} ${d ? d.label : k}</span>`;
        });
        html += `</div></div>`;
      }

      html += `<div class="total-grid">`;
      allKeys.forEach(k => {
        const base = individualStats[k] || 0;
        const bonus = setBonusSum[k] || 0;
        const total = base + bonus;
        if (total <= 0) return;

        const d = STAT_MAP[k];
        html += `<div class="total-item">
      <div class="total-name">${d ? d.label : k}</div>
      <div class="total-val">+${total}${d ? d.unit : ''}
        ${bonus > 0 ? `<span style="font-size:8px; color:var(--gold); display:block;">(세트+${bonus})</span>` : ''}
      </div>
    </div>`;
      });
      html += `</div></div>`;
      el.innerHTML = html;

      renderEquipSetList(); // 도감 갱신
    }

    // 필터 칩 클릭 핸들러
    function filterEquipSet(grade, el) {
      // UI 클래스만 교체해주면 renderEquipSetList가 알아서 상태를 읽어갑니다.
      document.querySelectorAll('#equip-set-filter .filter-chip').forEach(c => c.classList.remove('active'));
      el.classList.add('active');
      renderEquipSetList();
    }


    // 전체 세트 도감 렌더링 (장착 탭용)
    function renderEquipSetList() {
      const el = document.getElementById('equip-set-list');
      if (!el) return;

      const searchInput = document.getElementById('equip-set-search');
      const searchKeyword = searchInput ? searchInput.value.trim().toLowerCase() : "";

      const activeFilterChip = document.querySelector('#equip-set-filter .filter-chip.active');
      const currentFilter = activeFilterChip ? activeFilterChip.textContent.trim().toLowerCase() : 'all';

      const equipped = slots.filter(Boolean);
      const { active: activeSets } = calcActiveSetEffects(equipped);
      const activeIds = new Set(activeSets.map(s => s.id));
      const ownedTypes = new Set(userInventory.map(c => c.type));

      // 1. 필터링 로직
      let filtered = setDefs.filter(def => {
        if (currentFilter !== 'all' && def.grade !== currentFilter) return false;
        if (searchKeyword) {
          const nameMatch = def.name.toLowerCase().includes(searchKeyword);
          const cardMatch = def.cardTypes.some(ct => ct.toLowerCase().includes(searchKeyword));
          if (!nameMatch && !cardMatch) return false;
        }
        return true;
      });

      // 2. 정렬 로직 (장착중 최상단 + 완성 임박 순)
      filtered.sort((a, b) => {
        const aActive = activeIds.has(a.id) ? 1 : 0;
        const bActive = activeIds.has(b.id) ? 1 : 0;
        if (aActive !== bActive) return bActive - aActive;

        const aMissingCount = a.cardTypes.filter(type => !ownedTypes.has(type)).length;
        const bMissingCount = b.cardTypes.filter(type => !ownedTypes.has(type)).length;
        if (aMissingCount !== bMissingCount) return aMissingCount - bMissingCount;

        return b.size - a.size;
      });

      if (filtered.length === 0) {
        el.innerHTML = `<div class="empty" style="padding:40px;">🔍 검색 결과가 없습니다.</div>`;
        return;
      }

      // 3. HTML 출력 (장착 버튼 및 ATK 변화량 제거)
      el.innerHTML = filtered.map(def => {
        const isActive = activeIds.has(def.id);
        const missingCount = def.cardTypes.filter(type => !ownedTypes.has(type)).length;

        const memberButtons = def.cardTypes.map(typeName => {
          const isOwned = ownedTypes.has(typeName);
          const cardMaster = cards.find(c => c.type === typeName);
          const tier = cardMaster ? cardMaster.tier : 1;
          const icon = cardMaster ? cardMaster.icon : '?';
          return `
        <button class="set-member-btn ${isOwned ? 'owned' : ''}" 
                onclick="event.stopPropagation(); openCardTooltipFromSet('${typeName}')">
          <span class="card-tier-badge tb${tier}" style="font-size:8px; padding:0 3px;">T${tier}</span>
          ${icon} ${typeName}
        </button>`;
        }).join('');

        const effectHtml = Object.entries(def.effect).map(([k, v]) => {
          const d = STAT_MAP[k];
          return `<span class="eff-stat-chip" style="font-size:8px; background:rgba(232,184,75,0.08); color:var(--gold2);">
                +${v}${d ? d.unit : ''} ${d ? d.label : k}
              </span>`;
        }).join('');

        const progressHint = isActive ? "" :
          (missingCount === 0 ? `<span style="font-size:9px; color:var(--green); margin-left:8px; font-weight:800;">(즉시 완성 가능)</span>` :
            `<span style="font-size:9px; color:var(--text3); margin-left:8px;">(${missingCount}장 부족)</span>`);

        return `
      <div class="set-guide-item ani" style="background:var(--bg2); border:1px solid ${isActive ? 'var(--gold)' : 'var(--border)'}; border-radius:8px; padding:14px; margin-bottom:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <div>
            ${isActive ? `<span style="font-size:9px; background:var(--gold); color:var(--bg); padding:1px 5px; border-radius:3px; font-weight:800; margin-right:6px; vertical-align:middle;">✓ 장착중</span>` : ''}
            <span style="font-size:14px; font-weight:700; color:${isActive ? 'var(--gold2)' : 'var(--text1)'}; margin-right:6px;">${def.name}</span>
            <span style="font-size:9px; color:var(--text3); font-family:'Rajdhani',sans-serif;">${def.grade.toUpperCase()}</span>
            ${progressHint}
          </div>
          </div>
        <div style="margin-bottom:10px; display:flex; flex-wrap:wrap; gap:2px;">
          ${memberButtons}
        </div>
        <div style="display:flex; flex-wrap:wrap; gap:5px;">
          ${effectHtml}
        </div>
      </div>`;
      }).join('');
    }

    // [신규] 세트 도감 내 카드 클릭 시 툴팁 처리
    function openCardTooltipFromSet(typeName) {
      const invCard = userInventory
        .filter(c => c.type === typeName)
        .sort((a, b) => b.enhance - a.enhance)[0];

      const masterCard = cards.find(c => c.type === typeName);
      const targetCard = invCard || masterCard;

      if (targetCard) {
        openCardTooltip(targetCard.id);
      }
    }

    // [추가] 세트 장착 시 스탯 변화량을 시뮬레이션하는 함수
    function simulateStatChange(setId) {
      const def = setDefs.find(s => s.id === setId);
      if (!def) return 0;

      // 1. 현재 총 공격력 계산 (개별 + 세트)
      const currentEquipped = slots.filter(Boolean);
      const currentTotalAtk = calculateTotalStat(currentEquipped, 'AttackVary');

      // 2. 가상 슬롯 생성 및 시뮬레이션 장착 (기존 autoEquipSet 로직의 복사본)
      let virtualSlots = [...slots];
      const targetCards = def.cardTypes.map(typeName => {
        return userInventory
          .filter(c => c.type === typeName)
          .sort((a, b) => b.enhance - a.enhance)[0];
      }).filter(Boolean);

      if (targetCards.length < def.size) return 0; // 재료 부족 시 계산 안 함

      // 가상 슬롯에 자리 확보 (가장 낮은 족보 점수 카드부터 제거하는 시나리오)
      targetCards.forEach(newCard => {
        if (virtualSlots.some(s => s && s.id === newCard.id)) return;
        let dupIdx = virtualSlots.findIndex(s => s && s.type === newCard.type);
        if (dupIdx !== -1) { virtualSlots[dupIdx] = newCard; return; }

        let emptyIdx = virtualSlots.findIndex(s => s === null);
        if (emptyIdx !== -1) { virtualSlots[emptyIdx] = newCard; return; }

        // 자리가 없으면 점수가 가장 낮은 카드 한 장을 제거하고 장착한다고 가정
        let minScore = 999, targetIdx = -1;
        const { active: vActive } = calcActiveSetEffects(virtualSlots.filter(Boolean));
        for (let i = 0; i < 5; i++) {
          let score = 0;
          const s = virtualSlots[i];
          const mySets = vActive.filter(as => as.cardTypes.includes(s.type));
          if (mySets.length > 0) score = Math.max(...mySets.map(ms => (ms.grade === 'straight' ? 30 : ms.grade === 'triple' ? 20 : 10)));
          if (score < minScore) { minScore = score; targetIdx = i; }
        }
        if (targetIdx !== -1) virtualSlots[targetIdx] = newCard;
      });

      // 3. 장착 후 예상 총 공격력 계산
      const nextEquipped = virtualSlots.filter(Boolean);
      const nextTotalAtk = calculateTotalStat(nextEquipped, 'AttackVary');

      return nextTotalAtk - currentTotalAtk;
    }

    // [추가] 총 스탯 합산 보조 함수
    function calculateTotalStat(equippedCards, statKey) {
      let sum = 0;
      equippedCards.forEach(c => { sum += (effStats(c)[statKey] || 0); });
      const { active } = calcActiveSetEffects(equippedCards);
      active.forEach(s => { sum += (s.effect[statKey] || 0); });
      return sum;
    }

    // [신규] 세트 클릭 시 자동 장착 (있는 카드만 필터링)
    function autoEquipSet(setId) {
      const def = setDefs.find(s => s.id === setId);
      if (!def) return;

      let currentSlots = [...slots];
      const targetCards = def.cardTypes.map(typeName => {
        return userInventory
          .filter(c => c.type === typeName)
          .sort((a, b) => b.enhance - a.enhance)[0];
      }).filter(Boolean);

      if (targetCards.length < def.size) {
        showToast(`재료 카드가 부족합니다.`, 'err');
        return;
      }

      // [수정된 로직] 개별 효과 보호를 위해 루프 실행
      targetCards.forEach(newCard => {
        // 1. 이미 같은 ID가 장착되어 있으면 유지
        if (currentSlots.some(s => s && s.id === newCard.id)) return;

        // 2. 같은 종류인데 강화가 더 높은 것이 인벤토리에 있다면 교체(업그레이드)
        let sameTypeIdx = currentSlots.findIndex(s => s && s.type === newCard.type);
        if (sameTypeIdx !== -1) {
          if (newCard.enhance > currentSlots[sameTypeIdx].enhance) {
            currentSlots[sameTypeIdx] = newCard;
          }
          return;
        }

        // 3. 빈 슬롯이 있다면 장착
        let emptyIdx = currentSlots.findIndex(s => s === null);
        if (emptyIdx !== -1) {
          currentSlots[emptyIdx] = newCard;
          return;
        }

        // 4. 자리가 없다면? (개별 효과가 메인이므로 여기서 강제로 빼지 않음)
        // 유저에게 '빈 슬롯을 먼저 만드세요'라고 안내하는 것이 기획 의도에 더 부합할 수 있음
        showToast(`슬롯이 부족하여 [${newCard.name}]을 장착하지 못했습니다.`, 'err');
      });

      slots = currentSlots;
      renderAll();
    }

    // ── Config 테이블 ──
    function renderConfigTable() {
      document.getElementById('config-tbody').innerHTML = enhConfig.map((cfg, i) => {
        const succProb = 100 - cfg.fail;
        const destroyEff = cfg.fail > 0 ? cfg.destroy : 0;
        return `<tr>
      <td><span class="config-lv-label" style="color:${ECOLOR[i + 1]}">${i}강 → +${i + 1}강</span></td>
      <td>
        <input class="config-input" type="number" min="0" max="100" value="${cfg.fail}"
          oninput="updateCfg(${i},'fail',this.value);updateProbBar('fbar${i}',${cfg.fail},this.value)">
      </td>
      <td><div class="prob-bar-wrap"><div class="prob-bar" id="fbar${i}" style="width:${cfg.fail}%;background:var(--red);"></div></div></td>
      <td>
        <input class="config-input" type="number" min="0" max="100" value="${cfg.destroy}"
          oninput="updateCfg(${i},'destroy',this.value);updateProbBar('dbar${i}',${cfg.destroy},this.value)">
      </td>
      <td><div class="prob-bar-wrap"><div class="prob-bar" id="dbar${i}" style="width:${cfg.destroy}%;background:#ff3030;"></div></div></td>
    </tr>`;
      }).join('');
    }

    function updateCfg(idx, key, val) {
      enhConfig[idx][key] = Math.min(100, Math.max(0, parseInt(val) || 0));
      if (enhTargetId) renderEnhOverlayContent();
    }
    function updateProbBar(id, oldVal, newVal) {
      const el = document.getElementById(id);
      if (el) el.style.width = Math.min(100, Math.max(0, parseInt(newVal) || 0)) + '%';
    }

    // ==========================================
    // 강화 오버레이
    // ==========================================
    function openEnhOverlay(cardId) {
      // 도감이 아닌 인벤토리에서 찾습니다.
      const card = userInventory.find(c => c.id === cardId);
      if (!card) return;
      enhTargetId = cardId;
      renderEnhOverlayContent();
      document.getElementById('enh-overlay').classList.add('open');
    }

    function renderEnhOverlayContent() {
      const card = userInventory.find(c => c.id === enhTargetId);
      if (!card) return;

      const curLv = card.enhance;
      const isMax = curLv >= 5;
      const tc = TCOLOR[card.tier];

      // ── 헤더 ──
      const pips = [1, 2, 3, 4, 5].map(i =>
        `<div class="lv-pip${i <= curLv ? ' filled p' + i : ''}"></div>`
      ).join('');
      const lvLabel = isMax
        ? `<span style="color:var(--t7);font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;">⭐ MAX</span>`
        : `<span class="lv-label">${curLv}강 → <span style="color:${ECOLOR[curLv + 1] || 'var(--text1)'}">+${curLv + 1}강</span></span>`;

      document.getElementById('enh-header').innerHTML = `
    <div class="enh-card-big-icon"
      style="border-color:${tc};background:${TIER_BG[card.tier] || 'rgba(255,255,255,.03)'}">
      ${card.icon}
    </div>
    <div class="enh-card-header-info">
      <div class="enh-card-header-name">${card.name}</div>
      <div class="enh-card-header-sub" style="color:${tc}">T${card.tier} &nbsp;·&nbsp; ${card.type}</div>
      <div class="lv-bar">${pips}&nbsp;&nbsp;${lvLabel}</div>
    </div>`;

      // ── 확률 ──
      const probSection = document.getElementById('enh-prob-section');
      const probGrid = document.getElementById('enh-prob-grid');
      if (isMax) {
        probSection.style.display = 'none';
      } else {
        probSection.style.display = 'block';
        const cfg = enhConfig[curLv];
        const succ = 100 - cfg.fail;
        const dest = cfg.fail > 0 ? cfg.destroy : 0;
        probGrid.innerHTML = `
      <div class="prob-card">
        <div class="prob-card-label">성공</div>
        <div class="prob-card-val succ">${succ}%</div>
      </div>
      <div class="prob-card">
        <div class="prob-card-label">실패</div>
        <div class="prob-card-val fail">${cfg.fail}%</div>
      </div>
      <div class="prob-card">
        <div class="prob-card-label">파괴<span style="font-size:8px;font-family:'Rajdhani',sans-serif;color:var(--text3);margin-left:2px;">(실패시)</span></div>
        <div class="prob-card-val dest">${dest}%</div>
      </div>`;
      }

      // ── 스탯 비교 ──
      const statSection = document.getElementById('enh-stat-section');
      const statCompare = document.getElementById('enh-stat-compare');
      if (isMax) {
        statSection.style.display = 'none';
      } else {
        statSection.style.display = 'block';
        const curStats = effStats(card);
        // 다음 단계 스탯 계산
        let nextStats;
        if (card.upgradeStats) {
          const nextStep = Math.min(curLv + 1, card.upgradeStats.length - 1);
          nextStats = { ...card.upgradeStats[nextStep] };
        } else {
          const nextMult = ENH_MULT[curLv + 1];
          nextStats = {};
          for (const [k, v] of Object.entries(card.stats || {})) nextStats[k] = Math.round(v * nextMult);
        }
        const allKeys = new Set([...Object.keys(curStats), ...Object.keys(nextStats)]);
        const statRows = [...allKeys].filter(k => (nextStats[k] || 0) > 0 || (curStats[k] || 0) > 0).map(k => {
          const cur = curStats[k] || 0;
          const next = nextStats[k] || 0;
          const diff = next - cur;
          const def = STAT_MAP[k];
          const unit = def ? def.unit : '';
          const label = def ? def.label : k;
          const ec = ECOLOR[curLv + 1] || 'var(--green)';
          return `<div class="stat-compare-row">
          <div class="stat-cmp-name">${label}</div>
          <div class="stat-cmp-before">${cur}${unit}</div>
          <div class="stat-cmp-arrow">→</div>
          <div class="stat-cmp-after up" style="color:${ec}">
            ${next}${unit}
            ${diff !== 0 ? `<span class="stat-cmp-diff">(${diff > 0 ? '+' : ''}${diff}${unit})</span>` : ''}
          </div>
        </div>`;
        }).join('');
        statCompare.innerHTML = statRows || `<div style="font-size:10px;color:var(--text3);text-align:center;padding:8px;">스탯 없음</div>`;
      }

      // ── 버튼 ──
      const btn = document.getElementById('enh-do-btn');
      const note = document.getElementById('enh-action-note');
      if (isMax) {
        btn.className = 'btn-enhance max';
        btn.textContent = '⭐ 최대 강화 완료';
        btn.disabled = true;
        note.textContent = '이 카드는 이미 최대 강화 상태입니다.';
      } else {
        const cfg = enhConfig[curLv];
        btn.className = 'btn-enhance';
        btn.textContent = `🔥 +${curLv + 1}강 강화 시도`;
        btn.disabled = false;
        note.innerHTML = cfg.destroy > 0 && cfg.fail > 0
          ? `실패 시 <span style="color:var(--red)">${cfg.destroy}%</span> 확률로 카드가 파괴됩니다`
          : cfg.fail > 0
            ? `실패 시 강화 수치가 유지됩니다`
            : `이 단계는 강화가 반드시 성공합니다`;
      }
    }

    function closeEnhOverlay() {
      document.getElementById('enh-overlay').classList.remove('open');
      enhTargetId = null;
    }

    document.getElementById('enh-overlay').addEventListener('click', function (e) {
      if (e.target === this) closeEnhOverlay();
    });

    // ==========================================
    // 강화 실행
    // ==========================================
    function doEnhance() {
      const cardIndex = userInventory.findIndex(c => c.id === enhTargetId);
      if (cardIndex === -1) return;

      const card = userInventory[cardIndex];
      if (card.enhance >= 5) return;

      const curLv = card.enhance;
      const cfg = enhConfig[curLv];
      const roll = Math.random() * 100;

      if (roll >= cfg.fail) {
        // 1. 성공 로직
        card.enhance = curLv + 1;
        // 슬롯에 장착 중인 경우 슬롯 데이터도 업데이트
        slots = slots.map(s => s && s.id === card.id ? { ...card } : s);

        addLog('ok', `"${card.name}" +${curLv} → +${card.enhance}강 성공`);
        renderAll();
        renderEnhOverlayContent();
        showResultPopup('suc', card, curLv);
      } else {
        // 2. 실패 로직
        const destroyRoll = Math.random() * 100;
        if (cfg.destroy > 0 && destroyRoll < cfg.destroy) {
          const destroyedCard = { ...card }; // 팝업 표시를 위한 복사본

          // 실제 데이터 삭제
          userInventory.splice(cardIndex, 1);

          // 장착 중인 슬롯에서도 즉시 제거
          slots = slots.map(s => s && s.id === enhTargetId ? null : s);

          addLog('dest', `"${destroyedCard.name}" +${curLv + 1}강 실패 → 파괴됨`);

          // 상태 초기화 및 UI 갱신
          enhTargetId = null;
          renderAll();
          closeEnhOverlay(); // 파괴되었으므로 강화 창 닫기
          showResultPopup('dest', destroyedCard, curLv);
        } else {
          // 3. 실패(유지) 로직
          addLog('fail', `"${card.name}" +${curLv + 1}강 실패 (${curLv}강 유지)`);
          renderAll();
          renderEnhOverlayContent();
          showResultPopup('fail', card, curLv);
        }
      }
    }

    function addLog(type, txt) {
      const log = document.getElementById('enh-log');
      const noMsg = log.querySelector(':not(.log-row)');
      if (noMsg) noMsg.remove();
      const now = new Date();
      const t = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
      const row = document.createElement('div');
      row.className = 'log-row';
      row.innerHTML = `<span class="log-time">${t}</span><span class="log-txt ${type}">${txt}</span>`;
      log.insertBefore(row, log.firstChild);
    }

    function showResultPopup(type, card, fromLv) {
      const overlay = document.getElementById('result-overlay');
      const box = document.getElementById('result-box');
      const sparks = document.getElementById('result-sparks');
      sparks.innerHTML = '';

      const ico = document.getElementById('result-ico');
      const title = document.getElementById('result-title');
      const desc = document.getElementById('result-desc');

      if (type === 'suc') {
        box.className = 'result-box suc';
        ico.textContent = card.icon;
        title.className = 'result-title s'; title.textContent = '강화 성공!';
        desc.innerHTML = `<strong style="color:var(--text1)">${card.name}</strong><br>+${fromLv}강 → <strong style="color:${ECOLOR[card.enhance] || 'var(--green)'}">+${card.enhance}강</strong> 달성!`;
        // 성공 파티클
        for (let i = 0; i < 24; i++) {
          const s = document.createElement('div'); s.className = 'spark';
          const tx = (Math.random() - .5) * 300, ty = (Math.random() - .5) * 250;
          s.style.cssText = `left:50%;top:50%;background:${['#34d399', '#fbbf24', '#60a5fa', '#a78bfa'][i % 4]};--tx:${tx}px;--ty:${ty}px;animation-delay:${i * .03}s;width:${3 + Math.random() * 4}px;height:${3 + Math.random() * 4}px;`;
          sparks.appendChild(s);
        }
      } else if (type === 'fail') {
        box.className = 'result-box fail';
        ico.textContent = '💫';
        title.className = 'result-title f'; title.textContent = '강화 실패';
        desc.innerHTML = `<strong style="color:var(--text1)">${card.name}</strong><br>+${fromLv + 1}강 강화에 실패했습니다.<br><span style="font-size:11px;color:var(--text3)">강화 수치는 <strong>+${fromLv}강</strong>으로 유지됩니다.</span>`;
      } else {
        box.className = 'result-box dest';
        ico.textContent = '💥';
        title.className = 'result-title d'; title.textContent = '카드 파괴!';
        desc.innerHTML = `<strong style="color:var(--text1)">${card.name}</strong><br>강화 실패와 함께 카드가 소멸했습니다.`;
        for (let i = 0; i < 20; i++) {
          const s = document.createElement('div'); s.className = 'spark';
          const tx = (Math.random() - .5) * 300, ty = (Math.random() - .5) * 250;
          s.style.cssText = `left:50%;top:50%;background:#f87171;--tx:${tx}px;--ty:${ty}px;animation-delay:${i * .04}s;width:5px;height:5px;`;
          sparks.appendChild(s);
        }
      }
      overlay.classList.add('show');
    }

    function closeResult() {
      document.getElementById('result-overlay').classList.remove('show');
    }

    // ==========================================
    // 드래그 앤 드롭
    // ==========================================
    function onDragStart(e, cardId, fromSlot) {
      dragCardId = cardId; dragFromSlot = fromSlot;
      e.dataTransfer.effectAllowed = 'move';
      setTimeout(() => {
        const el = document.querySelector(`.card-item[data-id="${cardId}"]`);
        if (el) el.classList.add('dragging');
      }, 0);
    }
    function onDragOverSlot(e, i) {
      e.preventDefault(); e.dataTransfer.dropEffect = 'move';
      document.getElementById('slot-' + i)?.classList.add('drag-over');
    }
    function onDragLeaveSlot(i) {
      document.getElementById('slot-' + i)?.classList.remove('drag-over');
    }
    function onDropSlot(e, i) {
      e.preventDefault();
      document.getElementById('slot-' + i)?.classList.remove('drag-over');
      if (!dragCardId) return;
      const card = userInventory.find(c => c.id === dragCardId);
      if (!card) return;

      const dupType = slots.some((s, si) => s && s.type === card.type && s.id !== dragCardId && si !== i);
      if (dupType) { showToast(`동일 종류(${card.type}) 이미 장착 중`, 'err'); clearDrag(); return; }

      const existIdx = slots.findIndex(s => s && s.id === dragCardId);
      const targetCard = slots[i];
      if (existIdx !== -1 && existIdx !== i) {
        slots[i] = card; slots[existIdx] = targetCard;
      } else {
        slots[i] = card;
      }
      clearDrag(); renderAll();
      showToast(`슬롯 ${i + 1}에 "${card.name}" 장착!`, 'ok');
    }
    function onDropToList(e) {
      e.preventDefault();
      if (dragFromSlot !== null) { slots[dragFromSlot] = null; clearDrag(); renderAll(); showToast('슬롯 해제', ''); }
    }
    function clearDrag() {
      document.querySelectorAll('.card-item.dragging').forEach(el => el.classList.remove('dragging'));
      dragCardId = null; dragFromSlot = null;
    }

    // ==========================================
    // 슬롯 모달 (클릭 장착)
    // ==========================================
    function openSlotModal(i) {
      activeModalSlot = i;
      const eqTypes = slots.filter((c, si) => c && si !== i).map(c => c.type);
      const eqIds = slots.filter((c, si) => c && si !== i).map(c => c.id);
      const avail = userInventory.filter(c => !eqTypes.includes(c.type) && !eqIds.includes(c.id));
      document.getElementById('modal-title').textContent = `슬롯 ${i + 1} — 카드 선택`;
      document.getElementById('modal-card-list').innerHTML = avail.length
        ? avail.map(c => cardItemHTML(c, false, 'modal-slot')).join('')
        : `<div class="empty"><div class="empty-ico">🎴</div>장착 가능한 카드 없음</div>`;
      document.getElementById('card-modal').classList.add('open');
    }
    function equipFromModal(cardId) {
      if (activeModalSlot === null) return;
      const card = userInventory.find(c => c.id === cardId);
      if (card) { slots[activeModalSlot] = card; renderAll(); showToast(`슬롯 ${activeModalSlot + 1} 장착!`, 'ok'); }
      closeModal();
    }

    // [추가] 인벤토리에서 직접 카드를 획득하기 위한 모달 오픈
    function openObtainModal() {
      if (!cards.length) return showToast('등록된 도감이 없습니다.', 'err');
      activeModalSlot = null;

      document.getElementById('modal-title').textContent = `도감에서 카드 획득`;

      const modalBody = document.querySelector('.modal-body');
      modalBody.innerHTML = `
    <div style="margin-bottom:12px; position:sticky; top:0; z-index:10; background:var(--bg1); padding-bottom:8px; display:flex; flex-direction:column; gap:5px;">
      <input type="text" id="modal-search" class="form-input" placeholder="획득할 카드 검색..." oninput="updateObtainModalList()">
      <div style="display:flex; gap:5px;">
        <select id="modal-tier-filter" class="form-input" style="flex:1; font-size:11px;" onchange="updateObtainModalList()">
          <option value="all">모든 티어</option>
          ${[1, 2, 3, 4, 5, 6, 7].map(t => `<option value="${t}">Tier ${t}</option>`).join('')}
        </select>
        <select id="modal-stat-filter" class="form-input" style="flex:1; font-size:11px;" onchange="updateObtainModalList()">
          <option value="">모든 스탯</option>
          ${STAT_DEFS.map(s => `<option value="${s.key}">${s.label}</option>`).join('')}
        </select>
      </div>
    </div>
    <div class="card-list" id="modal-card-list"></div>
  `;

      updateObtainModalList();
      document.getElementById('card-modal').classList.add('open');
    }

    // [추가] 모달에서 카드를 클릭했을 때 실제 인벤토리로 복사
    function obtainFromModal(cid) {
      obtainCard(cid); // 기존에 만든 획득 로직 재사용
      // 모달을 닫지 않고 계속 획득할 수 있게 두거나, 원하시면 closeModal()을 추가하세요.
      // closeModal(); 
    }



    // [추가] 모달 내 실시간 검색 리스트 갱신
    function updateObtainModalList() {
      const searchKeyword = document.getElementById('modal-search').value.trim().toLowerCase();
      const tierFilter = document.getElementById('modal-tier-filter').value;
      const statFilter = document.getElementById('modal-stat-filter').value;
      const el = document.getElementById('modal-card-list');

      let filtered = cards.filter(c => {
        const matchName = c.name.toLowerCase().includes(searchKeyword);
        const matchTier = tierFilter === 'all' || String(c.tier) === tierFilter;
        const matchStat = !statFilter || (c.upgradeStats && c.upgradeStats[0][statFilter]);
        return matchName && matchTier && matchStat;
      });

      if (!filtered.length) {
        el.innerHTML = `<div class="empty">검색 결과가 없습니다.</div>`;
        return;
      }

      el.innerHTML = filtered.map(c => {
        const displayName = searchKeyword
          ? c.name.replace(new RegExp(`(${searchKeyword})`, 'gi'), `<span style="color:var(--gold); font-weight:bold;">$1</span>`)
          : c.name;

        // [추가] 0강 기준 스탯 칩 생성 로직
        const baseStats = c.upgradeStats ? c.upgradeStats[0] : {};
        const statChips = Object.entries(baseStats).map(([k, v]) => {
          const d = STAT_MAP[k];
          return `<span style="display:inline-block; font-size:9px; background:rgba(255,255,255,0.05); padding:1px 4px; border-radius:3px; margin-right:3px; color:var(--text3);">
        ${d ? d.label : k} +${v}${d ? d.unit : ''}
      </span>`;
        }).join('');

        return `
      <div class="card-item ani" data-tier="${c.tier}" onclick="obtainFromModal('${c.cid}')" style="align-items: flex-start; padding: 10px;">
        <div class="card-icon" style="width:32px; height:32px; font-size:18px;">${c.icon}</div>
        <div class="card-info" style="flex:1; min-width:0; margin-left:10px;">
          <div style="display:flex; align-items:center; gap:5px; margin-bottom:4px;">
            <span class="card-tier-badge tb${c.tier}">T${c.tier}</span>
            <span class="card-name" style="font-size:12px;">${displayName}</span>
          </div>
          <div style="display:flex; flex-wrap:wrap; gap:2px;">
            ${statChips}
          </div>
          <div style="font-size:8px; color:var(--gold); margin-top:6px; opacity:0.7;">단 클릭 시 인벤토리에 즉시 추가</div>
        </div>
      </div>`;
      }).join('');
    }

    function quickEquip(cardId) {
      const card = userInventory.find(c => c.id === cardId);
      if (!card) return;
      if (slots.some(s => s && s.type === card.type && s.id !== cardId)) return showToast(`동일 종류(${card.type}) 이미 장착`, 'err');
      if (slots.some(s => s && s.id === cardId)) return showToast('이미 장착됨', 'err');
      const empty = slots.indexOf(null);
      if (empty === -1) return showToast('슬롯이 가득 찼습니다', 'err');
      slots[empty] = card; renderAll();
      showToast(`슬롯 ${empty + 1}에 "${card.name}" 장착!`, 'ok');
    }
    function unequipSlot(i) {
      const c = slots[i]; slots[i] = null;
      if (c) showToast(`"${c.name}" 해제`, '');
      renderAll();
    }
    function closeModal() { document.getElementById('card-modal').classList.remove('open'); }
    document.getElementById('card-modal').addEventListener('click', e => {
      if (e.target === document.getElementById('card-modal')) closeModal();
    });

    // ==========================================
    // 세트 효과 계산 (새 방식)
    // ==========================================
    function calcActiveSetEffects(equipped) {
      if (!equipped.length) return { active: [], equippedTypes: new Set() };

      // 장착된 카드의 type(이름)들만 모은 Set 생성
      const equippedTypes = new Set(equipped.map(c => c.type));
      const active = [];

      // 모든 세트 도감을 돌며, 구성품이 모두 포함되어 있는지 확인
      setDefs.forEach(def => {
        const allPresent = def.cardTypes.every(t => equippedTypes.has(t));
        if (allPresent) active.push(def);
      });

      // 활성화된 세트와 분석된 타입 정보를 함께 반환
      return { active, equippedTypes };
    }
    // 최상위 활성 세트 등급 계산 (표시용)
    function topSetGrade(activeSets) {
      if (activeSets.some(s => s.grade === 'straight')) return 'straight';
      if (activeSets.some(s => s.grade === 'triple')) return 'triple';
      if (activeSets.length >= 2) return 'twopair';
      if (activeSets.some(s => s.grade === 'pair')) return 'pair';
      return 'none';
    }

    // ==========================================
    // 세트 조합 탭 렌더링
    // ==========================================
    const GRADE_LABEL = { pair: '페어', triple: '트리플', straight: '스트레이트' };
    const GRADE_COLOR = { pair: 'var(--pair-c)', triple: 'var(--triple-c)', straight: 'var(--straight-c)' };
    const GRADE_SIZE = { pair: 2, triple: 3, straight: 5 };

    let sfPendingStats = {}; // 세트 폼 임시 스탯

    function renderSetDefsTab() {
      renderSetDefsList();
      renderSetFormCardPicker();
    }

    function renderSetDefsList() {
      const el = document.getElementById('set-defs-list');
      const searchKeyword = document.getElementById('set-search').value.trim().toLowerCase();
      if (!el) return;

      const equipped = slots.filter(Boolean);
      const { active: activeSets } = calcActiveSetEffects(equipped);
      const activeIds = new Set(activeSets.map(s => s.id));
      const ownedTypes = new Set(userInventory.map(c => c.type)); // 보유 여부 체크용

      // 1. 필터링 로직 (등급 + 스탯 + 검색어)
      let filtered = setDefs.filter(def => {
        if (setFilterGrade !== 'all' && def.grade !== setFilterGrade) return false;
        if (setFilterStat && !def.effect[setFilterStat]) return false;
        if (searchKeyword) {
          const nameMatch = def.name.toLowerCase().includes(searchKeyword);
          const cardMatch = def.cardTypes.some(ct => ct.toLowerCase().includes(searchKeyword));
          if (!nameMatch && !cardMatch) return false;
        }
        return true;
      });

      // 2. [동기화] 지능형 정렬 로직 적용
      filtered.sort((a, b) => {
        // 1순위: 현재 장착 중(발동 중)인 세트
        const aActive = activeIds.has(a.id) ? 1 : 0;
        const bActive = activeIds.has(b.id) ? 1 : 0;
        if (aActive !== bActive) return bActive - aActive;

        // 2순위: 세트 완성까지 남은 카드 장수 (보유 현황 반영)
        const aMissingCount = a.cardTypes.filter(type => !ownedTypes.has(type)).length;
        const bMissingCount = b.cardTypes.filter(type => !ownedTypes.has(type)).length;
        if (aMissingCount !== bMissingCount) return aMissingCount - bMissingCount;

        return b.size - a.size;
      });

      if (!filtered.length) {
        el.innerHTML = `<div class="empty"><div class="empty-ico">🔍</div>검색 결과가 없습니다.</div>`;
        return;
      }

      // 검색어 강조 함수
      const highlight = (text) => {
        if (!searchKeyword) return text;
        return text.replace(new RegExp(`(${searchKeyword})`, 'gi'), `<span style="color:var(--gold); font-weight:bold;">$1</span>`);
      };

      // 3. 렌더링 (보유 중인 카드를 노란색 버튼으로 강조)
      el.innerHTML = filtered.map(def => {
        const gc = GRADE_COLOR[def.grade] || 'var(--text3)';
        const gl = GRADE_LABEL[def.grade] || def.grade;
        const isActive = activeIds.has(def.id);
        const missingCount = def.cardTypes.filter(type => !ownedTypes.has(type)).length;

        const effChips = Object.entries(def.effect || {}).filter(([, v]) => v > 0).map(([k, v]) => {
          const d = STAT_MAP[k];
          return `<span class="set-def-efx-chip">+${v}${d ? d.unit : ''} ${d ? d.label : k}</span>`;
        }).join('');

        const memberButtons = def.cardTypes.map(typeName => {
          const isOwned = ownedTypes.has(typeName);
          const cardInfo = cards.find(c => c.type === typeName || c.name === typeName);
          const tier = cardInfo ? cardInfo.tier : 1;
          const icon = cardInfo ? cardInfo.icon : '?';

          // 장착 탭과 동일하게 'owned' 클래스를 활용해 시각적 보유 상태 표시
          return `
        <button class="set-member-btn ${isOwned ? 'owned' : ''}" 
                onclick="event.stopPropagation(); openCardTooltipFromSet('${typeName}')">
          <span class="card-tier-badge tb${tier}" style="font-size:8px; padding:0 3px;">T${tier}</span>
          ${icon} ${highlight(typeName)}
        </button>`;
        }).join('');

        // 진행도 힌트 추가
        const progressHint = isActive ? "" :
          (missingCount === 0 ? `<span style="font-size:9px; color:var(--green); margin-left:8px; font-weight:800;">(즉시 완성 가능)</span>` :
            `<span style="font-size:9px; color:var(--text3); margin-left:8px;">(${missingCount}장 부족)</span>`);

        return `
      <div class="set-def-card grade-${def.grade}${isActive ? ' set-def-active' : ''} ani" style="${isActive ? 'border-color:var(--gold);' : ''}">
        ${isActive ? `<div class="set-def-active-badge">⚡ 발동 중</div>` : ''}
        <div class="set-def-name">${highlight(def.name)} ${progressHint}</div>
        <div class="set-def-grade" style="background:${gc}20;color:${gc};">${gl} · ${def.size}장</div>
        <div style="margin-bottom:8px; display:flex; flex-wrap:wrap; gap:2px;">
          ${memberButtons}
        </div>
        ${def.desc ? `<div class="set-def-desc">${def.desc}</div>` : ''}
        <div class="set-def-effect">${effChips}</div>
        <div class="set-def-actions" style="margin-top:10px;">
          <button class="btn-sm" onclick="editSetDef('${def.id}')">편집</button>
          <button class="btn-danger" onclick="deleteSetDef('${def.id}')">삭제</button>
        </div>
      </div>`;
      }).join('');
    }

    function renderSetFormCardPicker() {
      const el = document.getElementById('sf-card-picker');
      if (!el) return;

      const grade = document.querySelector('input[name="sf-grade"]:checked')?.value || 'pair';
      const editId = document.getElementById('sf-edit-id')?.value || '';
      const targetSize = GRADE_SIZE[grade];

      // 1. 인벤토리 카드 목록을 정렬 조건에 맞춰 정렬
      // 중복되지 않은 'Type'을 기준으로 하지만, 정렬을 위해 카드 객체 원본을 활용합니다.
      const uniqueCards = [];
      const typeSet = new Set();

      // 현재 인벤토리의 모든 카드를 확인하여 중복되지 않는 종류만 추출
      cards.forEach(c => {
        if (!typeSet.has(c.type)) {
          typeSet.add(c.type);
          uniqueCards.push(c);
        }
      });

      // 2. [핵심] 정렬 로직 적용
      uniqueCards.sort((a, b) => {
        // ① 티어 내림차순 (T7 -> T1)
        if (Number(b.tier) !== Number(a.tier)) {
          return Number(b.tier) - Number(a.tier);
        }
        // ② 동일 티어 내 CID 오름차순
        return String(a.cid).localeCompare(String(b.cid), undefined, { numeric: true });
      });

      const selected = editId ? getSelectedCardTypes() : [];
      const hintEl = document.getElementById('sf-card-hint');
      if (hintEl) {
        hintEl.textContent = `${targetSize}장 선택 (${selected.length}/${targetSize})`;
        hintEl.style.color = GRADE_COLOR[grade];
      }

      if (!uniqueCards.length) {
        el.innerHTML = `<span style="font-size:10px;color:var(--text3);">인벤토리에 카드가 없습니다</span>`;
        return;
      }

      // 3. 정렬된 uniqueCards를 기반으로 HTML 생성
      el.innerHTML = uniqueCards.map(card => {
        const isSel = selected.includes(card.type);
        const isDisabled = !isSel && selected.length >= targetSize;

        return `
      <div class="card-picker-chip${isSel ? ' selected' : ''}${isDisabled ? ' disabled' : ''}"
        onclick="togglePickerType('${card.type}')">
        <span class="card-tier-badge tb${card.tier}" style="font-size:8px; padding:0 3px; margin-right:4px; vertical-align:middle;">T${card.tier}</span>
        ${card.icon} ${card.type}
      </div>`;
      }).join('');
    }

    let setFilterGrade = 'all'; // all -> pair -> triple -> straight -> all
    let setFilterStat = null;   // 클릭한 스탯 키 저장
    // 등급 순환 토글
    function toggleGradeFilter() {
      const sequence = ['all', 'pair', 'triple', 'straight'];
      let idx = sequence.indexOf(setFilterGrade);
      setFilterGrade = sequence[(idx + 1) % sequence.length];

      const btn = document.getElementById('filter-grade-toggle');
      const labels = { all: '등급: 전체', pair: '등급: 페어', triple: '등급: 트리플', straight: '등급: 스트레이트' };
      btn.textContent = labels[setFilterGrade];
      renderSetDefsList();
    }

    // 스탯 필터 토글
    function toggleStatFilter(statKey) {
      setFilterStat = statKey || null; // 선택된 값이 없으면 null
      renderSetDefsList();
    }


    //드롭다운 메뉴를 채워주는 함수
    function renderStatFilterDropdown() {
      const dropdown = document.getElementById('filter-stat-dropdown');
      if (!dropdown) return;

      // STAT_DEFS에 정의된 모든 스탯을 <option> 태그로 변환
      const options = STAT_DEFS.map(s =>
        `<option value="${s.key}">${s.label}${s.unit ? '(' + s.unit + ')' : ''}</option>`
      ).join('');

      // 초기값과 함께 드롭다운에 삽입
      dropdown.innerHTML = `<option value="">스탯 필터: 전체</option>` + options;
    }

    function renderMasterStatDropdown() {
      const dropdown = document.getElementById('master-stat-filter');
      const modalDropdown = document.getElementById('modal-stat-filter'); // 모달용도 대비
      if (!dropdown) return;

      const options = STAT_DEFS.map(s =>
        `<option value="${s.key}">${s.label}</option>`
      ).join('');

      dropdown.innerHTML = `<option value="">스탯 필터: 전체</option>` + options;
    }

    function getSelectedCardTypes() {
      return [...document.querySelectorAll('.card-picker-chip.selected')].map(el => el.textContent.trim().replace(/^\S+\s*/, '').trim());
    }

    function togglePickerType(type) {
      const el = document.querySelector(`.card-picker-chip[onclick="togglePickerType('${type}')"]`);
      if (!el) return;
      const grade = document.querySelector('input[name="sf-grade"]:checked')?.value || 'pair';
      const targetSize = GRADE_SIZE[grade];
      const selected = getSelectedCardTypes();
      if (el.classList.contains('selected')) {
        el.classList.remove('selected');
      } else {
        if (selected.length >= targetSize) return;
        el.classList.add('selected');
      }
      // disabled 상태 갱신
      const newSel = getSelectedCardTypes();
      document.querySelectorAll('.card-picker-chip').forEach(chip => {
        const t = chip.textContent.trim().replace(/^\S+\s*/, '').trim();
        if (!newSel.includes(t)) {
          chip.classList.toggle('disabled', newSel.length >= targetSize);
        }
      });
      const hintEl = document.getElementById('sf-card-hint');
      if (hintEl) hintEl.textContent = `${targetSize}장 선택 (${newSel.length}/${targetSize})`;
    }

    function onGradeChange(radio) {
      renderSetFormCardPicker();
      sfPendingStats = {};
      renderSfStatList();
    }

    function addSetStat() {
      const key = document.getElementById('sf-stat-key').value;
      const val = parseFloat(document.getElementById('sf-stat-val').value);
      if (!key) return showToast('스탯을 선택하세요', 'err');
      if (isNaN(val) || val <= 0) return showToast('값을 입력하세요 (0 초과)', 'err');
      sfPendingStats[key] = val;
      renderSfStatList();
      document.getElementById('sf-stat-key').value = '';
      document.getElementById('sf-stat-val').value = '';
    }

    function removeSfStat(key) {
      delete sfPendingStats[key];
      renderSfStatList();
    }

    function renderSfStatList() {
      const el = document.getElementById('sf-stat-list');
      if (!el) return;
      el.innerHTML = Object.entries(sfPendingStats).map(([k, v]) => {
        const d = STAT_MAP[k];
        return `<div class="sf-stat-row">
      <span class="sf-stat-row-name">${d ? d.label : k}</span>
      <span class="sf-stat-row-val">+${v}${d ? d.unit : ''}</span>
      <button class="btn-danger" style="padding:2px 7px;font-size:9px;" onclick="removeSfStat('${k}')">✕</button>
    </div>`;
      }).join('') || `<span style="font-size:10px;color:var(--text3);">보너스 스탯 없음</span>`;
    }

    function saveSetDef() {
      const name = document.getElementById('sf-name').value.trim();
      const grade = document.querySelector('input[name="sf-grade"]:checked')?.value || 'pair';
      const cardTypes = getSelectedCardTypes();
      const targetSize = GRADE_SIZE[grade];
      const desc = document.getElementById('sf-desc').value.trim();
      const editId = document.getElementById('sf-edit-id').value;

      if (!name) return showToast('세트 이름을 입력하세요', 'err');
      if (cardTypes.length !== targetSize) return showToast(`카드 ${targetSize}장을 선택하세요`, 'err');

      // --- [추가] 제 1규칙 검사 로직 ---
      const isViolation = setDefs.some(existing => {
        if (existing.id === editId) return false; // 현재 편집 중인 세트는 제외

        // 1. 내가 만들려는 게 스트레이트인 경우: 기존의 페어/트리플을 포함하는지 확인
        if (grade === 'straight') {
          if (existing.grade === 'pair' || existing.grade === 'triple') {
            const isContained = existing.cardTypes.every(type => cardTypes.includes(type));
            if (isContained) {
              showToast(`규칙 위반: "${existing.name}"(${existing.grade})을 포함할 수 없습니다.`, 'err');
              return true;
            }
          }
        }
        // 2. 내가 만들려는 게 페어/트리플인 경우: 기존 스트레이트에 내가 포함되는지 확인
        else {
          if (existing.grade === 'straight') {
            const amIContained = cardTypes.every(type => existing.cardTypes.includes(type));
            if (amIContained) {
              showToast(`규칙 위반: "${existing.name}"(스트레이트)에 포함되는 조합입니다.`, 'err');
              return true;
            }
          }
        }
        return false;
      });

      if (isViolation) return; // 위반 시 함수 종료 및 저장 중단
      // --------------------------------

      const defObj = {
        id: editId || 'set_' + uid(),
        name, grade, size: targetSize,
        cardTypes, desc,
        effect: { ...sfPendingStats },
      };

      if (editId) {
        const idx = setDefs.findIndex(s => s.id === editId);
        if (idx !== -1) setDefs[idx] = defObj;
      } else {
        setDefs.push(defObj);
      }

      resetSetForm();
      renderSetDefsList();
      renderEffectSummary();
      showToast(editId ? `"${name}" 수정 완료` : `"${name}" 추가 완료!`, 'ok');
    }

    function editSetDef(id) {
      const def = setDefs.find(s => s.id === id);
      if (!def) return;
      document.getElementById('sf-name').value = def.name;
      document.getElementById('sf-desc').value = def.desc || '';
      document.getElementById('sf-edit-id').value = def.id;
      document.getElementById('set-form-title').textContent = '✏️ 세트 편집';
      // 등급 라디오
      const radio = document.querySelector(`input[name="sf-grade"][value="${def.grade}"]`);
      if (radio) radio.checked = true;
      sfPendingStats = { ...(def.effect || {}) };
      renderSfStatList();
      // 카드 피커 재렌더 후 선택 표시
      renderSetFormCardPicker();
      setTimeout(() => {
        def.cardTypes.forEach(t => {
          const el = document.querySelector(`.card-picker-chip[onclick="togglePickerType('${t}')"]`);
          if (el && !el.classList.contains('selected')) togglePickerType(t);
        });
      }, 50);
    }

    function deleteSetDef(id) {
      const def = setDefs.find(s => s.id === id);
      if (!def) return;
      setDefs = setDefs.filter(s => s.id !== id);
      renderSetDefsList();
      renderEffectSummary();
      showToast(`"${def.name}" 세트 삭제`, '');
    }

    function resetSetForm() {
      document.getElementById('sf-name').value = '';
      document.getElementById('sf-desc').value = '';
      document.getElementById('sf-edit-id').value = '';
      document.getElementById('set-form-title').textContent = '✨ 새 세트 추가';

      const radio = document.querySelector('input[name="sf-grade"][value="pair"]');
      if (radio) radio.checked = true;

      sfPendingStats = {};
      renderSfStatList();

      // [추가] 카드 피커의 모든 선택(selected)과 비활성(disabled) 클래스 제거
      document.querySelectorAll('.card-picker-chip').forEach(chip => {
        chip.classList.remove('selected', 'disabled');
      });

      renderSetFormCardPicker(); // 상태에 맞춰 다시 그림
    }

    // ==========================================
    // 카드 CRUD
    // ==========================================
    let pendingStats = {}; // { StatKey: value } 임시 저장
    let pendingUpgradeStats = Array(6).fill(null).map(() => ({})); // 0~5강 임시 스탯 저장
    let currentStepIdx = 0; // 현재 편집 중인 강화 단계 (0:기본, 1~5:강화)

    // 편집할 강화 단계 전환
    function switchStep(step) {
      currentStepIdx = step;

      // step-btn 클래스를 가진 버튼들만 초기화
      document.querySelectorAll('.step-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      // 선택된 버튼만 강조
      const activeBtn = document.getElementById(`step-btn-${step}`);
      if (activeBtn) {
        activeBtn.classList.add('active');
      }

      renderStepStatEntries();
    }

    function addStatEntry() {
      const sel = document.getElementById('stat-select');
      const valEl = document.getElementById('stat-val');
      const key = sel.value;
      const val = parseFloat(valEl.value);

      if (!key) return showToast('스탯을 선택하세요', 'err');
      if (isNaN(val) || val <= 0) return showToast('값을 입력하세요', 'err');

      // 현재 선택된 강화 단계에 스탯 저장
      pendingUpgradeStats[currentStepIdx][key] = val;
      renderStepStatEntries();

      valEl.value = '';
    }

    // [수정] 0강(Base) 스탯을 기준으로 단계마다 n씩 더해서 복사 (산술 급수)
    function copyBaseToAll() {
      const baseStats = pendingUpgradeStats[0];
      if (Object.keys(baseStats).length === 0) {
        return showToast('복사할 0강 스탯이 없습니다.', 'err');
      }

      const n = parseFloat(document.getElementById('copy-all-n').value);
      if (isNaN(n)) return showToast('유효한 수치를 입력하세요.', 'err');

      if (!confirm(`0강 스탯을 기준으로 단계마다 ${n}씩 더하여 모든 단계에 복사할까요?`)) return;

      for (let i = 1; i < 6; i++) {
        const newStepStats = {};
        for (const [key, val] of Object.entries(baseStats)) {
          // 수식: 0강 수치 + (단계 * n)
          newStepStats[key] = Math.round((val + (i * n)) * 10) / 10;
        }
        pendingUpgradeStats[i] = newStepStats;
      }

      renderStepStatEntries();
      showToast(`전체 단계에 단계별 ${n} 가산 복사 완료`, 'ok');
    }

    // [수정] 이전 단계의 스탯에 n을 더하여 현재 단계에 적용
    function copyPrevStep() {
      if (currentStepIdx === 0) return showToast('0강은 이전 단계가 없습니다.', 'err');

      const prevStats = pendingUpgradeStats[currentStepIdx - 1];
      if (Object.keys(prevStats).length === 0) {
        return showToast('이전 단계에 설정된 스탯이 없습니다.', 'err');
      }

      const n = parseFloat(document.getElementById('copy-prev-n').value);
      if (isNaN(n)) return showToast('유효한 수치를 입력하세요.', 'err');

      const newStepStats = {};
      for (const [key, val] of Object.entries(prevStats)) {
        // 수식: 이전 단계 수치 + n
        newStepStats[key] = Math.round((val + n) * 10) / 10;
      }

      pendingUpgradeStats[currentStepIdx] = newStepStats;
      renderStepStatEntries();
      showToast(`${currentStepIdx - 1}강 스탯에 ${n}을 더해 현재 단계에 적용`, 'ok');
    }


    function removeStatEntry(key) {
      delete pendingUpgradeStats[currentStepIdx][key];
      renderStepStatEntries();
    }

    function renderStepStatEntries() {
      const el = document.getElementById('stat-entries');
      const currentStats = pendingUpgradeStats[currentStepIdx];
      const keys = Object.keys(currentStats);

      if (!keys.length) {
        el.innerHTML = `<div style="font-size:10px;color:var(--text3);text-align:center;padding:5px;">현재 단계에 설정된 스탯이 없습니다.</div>`;
        return;
      }

      el.innerHTML = keys.map(k => {
        const def = STAT_MAP[k];
        return `<div style="display:flex;align-items:center;gap:8px;padding:5px 10px;background:var(--bg);border:1px solid var(--border2);border-radius:5px;font-size:11px;">
      <span style="flex:1;color:var(--text2);font-family:'Rajdhani',sans-serif;">${def ? def.label : k}</span>
      <span style="color:var(--gold2);font-family:'Rajdhani',sans-serif;font-weight:700;">+${currentStats[k]}${def ? def.unit : ''}</span>
      <button onclick="removeStatEntry('${k}')" style="background:none;border:none;color:var(--red);cursor:pointer;padding:0 2px;">✕</button>
    </div>`;
      }).join('');
    }

    // 티어 선택 시 CID 자동 생성 로직 추가
    function selTier(n, el) {
      selTierVal = n;
      // 모든 버튼에서 active 제거 후 클릭한 버튼에만 추가
      document.querySelectorAll('.tier-btn').forEach(b => b.classList.remove('active'));
      el.classList.add('active');

      // CID 생성 실행
      generateCID(n);
    }

    function generateCID(tier) {
      if (!tier) return;

      // 현재 인벤토리(cards)에서 해당 티어의 일련번호 찾기
      const tierCards = cards.filter(c => Number(c.tier) === Number(tier));
      let nextNum = 1;

      if (tierCards.length > 0) {
        // CID 170{티어}XXXX 중 끝 4자리를 추출하여 최대값 + 1
        const nums = tierCards.map(c => {
          const cidStr = String(c.cid);
          return parseInt(cidStr.substring(4)) || 0;
        });
        nextNum = Math.max(...nums) + 1;
      }

      const cid = `170${tier}${String(nextNum).padStart(4, '0')}`;
      document.getElementById('c-cid').value = cid;
    }

    // [추가] 도감 데이터를 바탕으로 실제 소유 카드 생성
    function obtainCard(masterCid) {
      const master = cards.find(c => c.cid === masterCid);
      if (!master) return showToast('도감 정보를 찾을 수 없습니다.', 'err');

      // 도감 데이터의 '복사본'을 만듭니다. (Deep Copy)
      const newItem = JSON.parse(JSON.stringify(master));

      // 중요: 인벤토리 아이템은 고유한 id와 개별적인 강화 수치를 가집니다.
      newItem.id = uid();    // 인벤토리 내 고유 식별자 부여
      newItem.enhance = 0;   // 획득 시 0강 고정

      userInventory.push(newItem);
      renderAll();
      showToast(`"${master.name}" 획득!`, 'ok');
    }

    function createCard() {
      const cid = document.getElementById('c-cid').value;
      const name = document.getElementById('c-name').value.trim();

      if (!cid) return showToast('티어를 선택하세요', 'err');
      if (!name) return showToast('카드 이름을 입력하세요', 'err');
      if (!Object.keys(pendingUpgradeStats[0]).length) return showToast('0강(Base) 스탯은 필수입니다', 'err');

      // 데이터 무결성 체크: 0강 이후 단계가 비어있으면 이전 단계 스탯으로 보충
      const finalUpgradeStats = [...pendingUpgradeStats];
      for (let i = 1; i < 6; i++) {
        if (Object.keys(finalUpgradeStats[i]).length === 0) {
          finalUpgradeStats[i] = { ...finalUpgradeStats[i - 1] };
        }
      }

      const newCard = {
        id: uid(),
        cid: cid,
        name: name,
        type: name,
        icon: selIconVal,
        tier: selTierVal,
        upgradeStats: finalUpgradeStats,
        stats: { ...finalUpgradeStats[0] },
        enhance: 0,
        setEffects: { pair: "", triple: "", straight: "" }
      };

      cards.push(newCard);

      //카드 생성 시 세트 조합 탭의 카드 목록도 즉시 갱신 
      renderSetFormCardPicker();

      renderAll();
      clearForm(); // 폼 초기화

      // [추가된 부분] 현재 선택된 티어의 다음 일련번호로 CID 즉시 갱신
      if (selTierVal) {
        generateCID(selTierVal);
      }

      showToast(`"${name}" 생성 완료!`, 'ok');
    }

    function deleteCard(id) {
      // 1. 먼저 인벤토리에서 찾아봅니다.
      const invIdx = userInventory.findIndex(c => c.id === id);
      if (invIdx !== -1) {
        userInventory.splice(invIdx, 1);
        slots = slots.map(s => s && s.id === id ? null : s);
        showToast('인벤토리 아이템 파괴됨', '');
      } else {
        // 2. 인벤토리에 없으면 도감에서 삭제합니다.
        const masterIdx = cards.findIndex(c => c.id === id);
        if (masterIdx !== -1) {
          if (!confirm('도감 데이터를 영구 삭제하시겠습니까?')) return;
          cards.splice(masterIdx, 1);
          showToast('도감 데이터 삭제됨', 'err');
        }
      }
      renderAll();
    }

    function clearAll() {
      if (!confirm('모든 카드를 삭제할까요?')) return;
      cards = []; slots = [null, null, null, null, null]; closeEnhOverlay(); renderAll();
    }
    function clearForm() {
      document.getElementById('c-name').value = '';
      document.getElementById('c-cid').value = '';
      pendingUpgradeStats = Array(6).fill(null).map(() => ({}));
      switchStep(0); // 0강 입력 상태로 복귀
      renderStepStatEntries();
    }

    // ==========================================
    // 탭 / 기타
    // ==========================================
    function switchTab(tab) {
      document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      document.getElementById('tab-' + tab).style.display = 'block';
      ['equip', 'create', 'config', 'sets'].forEach((t, i) => {
        if (t === tab) document.querySelectorAll('.tab-btn')[i].classList.add('active');
      });
      if (tab === 'sets') renderSetDefsTab();
    }

    function selIcon(ic) { selIconVal = ic; renderIconGrid(); }
    function filterInv(f, el) {
      invFilterVal = f;
      document.querySelectorAll('#inv-filter .filter-chip').forEach(c => c.classList.remove('active'));
      el.classList.add('active'); renderInventory();
    }

    // ==========================================
    // CSV Export (PrototypeDB.csv 포맷)
    // ==========================================
    function exportCSV() {
      if (!cards.length) return showToast('내보낼 카드가 없습니다', 'err');

      // 1. CID 기준으로 카드 리스트 정렬
      const sortedCards = [...cards].sort((a, b) => {
        return String(a.cid).localeCompare(String(b.cid), undefined, { numeric: true });
      });

      const rows = [];
      // 헤더명을 Icon에서 IconIndex로 명확히 변경
      rows.push('Cid,Name,UpgradeStep,StatName,Stat,Tier,IconIndex');

      const tierLabel = n => `Tier${n}`;

      // 2. 정렬된 리스트를 바탕으로 행 생성
      sortedCards.forEach(card => {
        const tierStr = tierLabel(card.tier);

        // [중요] 아이콘 문자를 ICONS 배열에서 찾아 '인덱스 번호'를 추출
        // 만약 찾지 못하면 기본값으로 0(첫 번째 아이콘)을 할당
        const iconIdx = ICONS.indexOf(card.icon);
        const saveIdx = (iconIdx !== -1) ? iconIdx : 0;

        if (card.upgradeStats && card.upgradeStats.length > 0) {
          card.upgradeStats.forEach((stepStats, step) => {
            const entries = Object.entries(stepStats);
            if (!entries.length) return;
            // 복수 스탯은 | 구분자로 한 행에 묶어서 내보냄
            const statNames = entries.map(([k]) => { const d = STAT_MAP[k]; return d ? d.label : k; }).join('|');
            // per 스탯은 내부 % 단위 → 게임 DB 천분률(*1000)로 역변환
            const statVals  = entries.map(([k, v]) => k.endsWith('per') ? Math.round(v * 1000) : v).join('|');
            rows.push(`${card.cid || ''},${card.name},${step},${statNames},${statVals},${tierStr},${saveIdx}`);
          });
        } else {
          // 레거시 대응용 (upgradeStats가 없는 경우)
          const entries = Object.entries(card.stats || {}).filter(([, v]) => v > 0);
          if (entries.length) {
            const statNames = entries.map(([k]) => { const d = STAT_MAP[k]; return d ? d.label : k; }).join('|');
            const statVals  = entries.map(([k, v]) => k.endsWith('per') ? Math.round(v * 1000) : v).join('|');
            rows.push(`${card.cid || 'custom'},${card.name},0,${statNames},${statVals},${tierStr},${saveIdx}`);
          }
        }
      });

      const csv = rows.join('\n');
      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      // 파일명에 Index임을 명시하여 구분하기 쉽게 합니다.
      a.download = `PrototypeDB_Index_export_${new Date().toISOString().slice(0, 10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);

      showToast(`${sortedCards.length}개 카드 내보내기 완료!`, 'ok');
    }

    // ==========================================
    // CSV Import (PrototypeDB.csv 포맷)
    // ==========================================
    function importCSV(event) {
      const file = event.target.files[0];
      if (!file) return;
      event.target.value = ''; // 파일 재선택 가능하게 초기화

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const text = e.target.result.replace(/^\uFEFF/, ''); // BOM 제거
          const lines = text.split(/\r?\n/).filter(l => l.trim());
          if (!lines.length) return showToast('빈 파일입니다', 'err');

          // 헤더 파싱
          const header = lines[0].split(',').map(h => h.trim().toLowerCase());
          const idxCid = header.indexOf('cid');
          const idxName = header.indexOf('name');
          const idxStep = header.indexOf('upgradestep');
          const idxStat = header.indexOf('statname');
          const idxVal = header.indexOf('stat');
          const idxTier = header.indexOf('tier');
          const idxIcon = header.indexOf('iconindex'); // 인덱스 기반 아이콘 컬럼

          // [복구 완료] 필수 헤더 예외 처리 구문
          if ([idxCid, idxName, idxStep, idxStat, idxVal, idxTier].some(i => i === -1)) {
            return showToast('CSV 포맷 오류: 필수 헤더가 누락되었습니다.', 'err');
          }

          // StatName 매핑 정보 준비
          const labelToKey = {};
          STAT_DEFS.forEach(s => {
            labelToKey[s.label] = s.key;
            labelToKey[s.key] = s.key;
          });

          const cardMap = new Map();
          for (let i = 1; i < lines.length; i++) {
            const cols = lines[i].split(',').map(c => c.trim());
            if (cols.length < 6) continue;

            const cid = cols[idxCid];
            if (!cardMap.has(cid)) {
              // IconIndex가 있으면 해당 인덱스의 아이콘을, 없거나 잘못됐으면 0번 아이콘 사용
              const iconNum = (idxIcon !== -1) ? parseInt(cols[idxIcon]) : 0;
              const iconChar = ICONS[iconNum] || ICONS[0];

              cardMap.set(cid, {
                cid: cid,
                name: cols[idxName],
                tier: parseInt(cols[idxTier].replace(/[^0-9]/g, '')) || 1,
                icon: iconChar,
                upgradeStats: [{}, {}, {}, {}, {}, {}]
              });
            }

            // StatName/Stat 컬럼은 '|'로 복수 스탯을 구분할 수 있음
            const statKeys = cols[idxStat].split('|').map(s => labelToKey[s.trim()] || null);
            const statVals = cols[idxVal].split('|');
            const step = Math.max(0, Math.min(5, parseInt(cols[idxStep]) || 0));
            statKeys.forEach((statKey, si) => {
              if (!statKey) return;
              let val = parseFloat(statVals[si]) || 0;
              // per 스탯은 게임 DB에서 천분률(1000 = 1%)이므로 /1000 변환
              if (statKey.endsWith('per')) val = Math.round(val / 10) / 100;
              cardMap.get(cid).upgradeStats[step][statKey] = val;
            });
          }

          // 기존 cards 배열 업데이트 또는 신규 추가
          cardMap.forEach(entry => {
            const existingIdx = cards.findIndex(c => c.cid === entry.cid);

            // 빈 단계 보정 (앞 단계 스탯으로 채움)
            for (let s = 1; s < 6; s++) {
              if (Object.keys(entry.upgradeStats[s]).length === 0) {
                entry.upgradeStats[s] = { ...entry.upgradeStats[s - 1] };
              }
            }

            const cardObj = {
              id: existingIdx !== -1 ? cards[existingIdx].id : uid(),
              cid: entry.cid,
              name: entry.name,
              type: entry.name,
              icon: entry.icon,
              tier: entry.tier,
              upgradeStats: entry.upgradeStats,
              stats: { ...entry.upgradeStats[0] },
              enhance: 0,
              setEffects: { pair: "", triple: "", straight: "" }
            };

            if (existingIdx !== -1) {
              cards[existingIdx] = cardObj;
            } else {
              cards.push(cardObj);
            }
          });

          renderAll();
          showToast(`가져오기 완료`, 'ok');
        } catch (err) {
          console.error(err);
          showToast('CSV 처리 중 오류가 발생했습니다.', 'err');
        }
      };
      reader.readAsText(file, 'UTF-8');
    }

    // ==========================================
    // [추가] 세트 정의 CSV Export (기획자님 요청 포맷)
    // ==========================================
    function exportSetsCSV() {
      if (!setDefs.length) return showToast('내보낼 세트 데이터가 없습니다', 'err');

      const headers = ["ID", "Name", "Members", "Size", "Grade", "Description", "Effects"];
      const rows = [headers.join(',')];

      setDefs.forEach(set => {
        const members = set.cardTypes.join('|');
        // per 스탯은 내부 % 단위 → 게임 DB 천분률(*1000)로 역변환 후 직렬화
        const exportEffect = {};
        Object.entries(set.effect).forEach(([k, v]) => {
          exportEffect[k] = k.endsWith('per') ? Math.round(v * 1000) : v;
        });
        const effects = JSON.stringify(exportEffect).replace(/"/g, "'");

        const row = [
          set.id,
          `"${set.name.replace(/"/g, '""')}"`,
          `"${members}"`,
          set.size,
          set.grade,
          `"${set.desc.replace(/"/g, '""')}"`,
          `"${effects}"`
        ];
        rows.push(row.join(','));
      });

      const csvContent = "\uFEFF" + rows.join("\n");
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", `SetDefinitions_DB_${new Date().getTime()}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showToast(`${setDefs.length}개 세트 내보내기 완료`, 'ok');
    }

    // ==========================================
    // [추가] 세트 정의 CSV Import
    // ==========================================
    function importSetsCSV(event) {
      const file = event.target.files[0];
      if (!file) return;
      event.target.value = '';

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const text = e.target.result.replace(/^\uFEFF/, '');
          const lines = text.split(/\r?\n/).filter(line => line.trim());
          if (lines.length < 2) return showToast('데이터가 부족합니다', 'err');

          const newSets = [];
          for (let i = 1; i < lines.length; i++) {
            // 따옴표 내부 쉼표를 무시하는 파싱 정규식
            const cols = lines[i].match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g) || [];
            const cleanCols = cols.map(c => c.replace(/^"|"$/g, '').trim());

            if (cleanCols.length < 7) continue;

            const [id, name, members, size, grade, desc, effects] = cleanCols;

            // {'Key': Val} 형태를 JSON 객체로 복구
            let parsedEffect = {};
            try {
              const jsonString = effects.replace(/'/g, '"');
              const rawEffect = JSON.parse(jsonString);
              // per 스탯은 게임 DB에서 천분률(1000 = 1%)이므로 /1000 변환
              Object.entries(rawEffect).forEach(([k, v]) => {
                parsedEffect[k] = k.endsWith('per') ? Math.round(v / 10) / 100 : v;
              });
            } catch (err) { console.error("Effect 파싱 에러:", effects); }

            newSets.push({
              id: id || `set_${Date.now()}_${i}`,
              name: name,
              cardTypes: members.split('|'),
              size: parseInt(size) || 0,
              grade: grade,
              desc: desc,
              effect: parsedEffect
            });
          }

          if (newSets.length > 0) {
            setDefs = newSets;
            renderSetDefsList(); // 세트 조합 리스트 갱신
            if (typeof renderEquipSetList === 'function') renderEquipSetList(); // 장착 도감 갱신
            renderEffectSummary(); // 메인 스탯 합산 갱신
            showToast(`${newSets.length}개 세트 데이터를 가져왔습니다.`, 'ok');
          }
        } catch (err) {
          console.error(err);
          showToast('CSV 처리 중 오류가 발생했습니다.', 'err');
        }
      };
      reader.readAsText(file, 'UTF-8');
    }

    // ==========================================
    // 카드 툴팁 오버레이
    // ==========================================
    function openCardTooltip(cardId) {
      const invCard = userInventory.find(c => c.id === cardId); //클릭중인게 실물 카드니? 도감 카드니? 실물 카드여야만 강화,파괴 버튼을 보여준다.
      const masterCard = cards.find(c => c.id === cardId);
      const card = invCard || masterCard;
      if (!card) return;

      const tc = TCOLOR[card.tier];
      const tierBg = TIER_BG[card.tier] || 'rgba(255,255,255,.03)';
      const eff = effStats(card);

      // ── 헤더 ──
      const pips = card.enhance > 0
        ? `<span class="enh-badge lv${card.enhance}" style="margin-right:4px;">+${card.enhance}강</span>`
        : `<span class="enh-badge" style="margin-right:4px;">0강</span>`;
      document.getElementById('ctt-header').innerHTML = `
    <div class="ctt-big-icon" style="border-color:${tc};background:${tierBg};">${card.icon}</div>
    <div class="ctt-title-block">
      <div class="ctt-name">${card.name}</div>
      <div class="ctt-sub" style="color:${tc}">T${card.tier} &nbsp;·&nbsp; ${card.type}</div>
      <div>${pips}</div>
    </div>
    <div class="ctt-close-hint">ESC / 배경 클릭으로 닫기</div>`;

      // ── 바디 ──
      let body = '';

      // 현재 스탯
      body += `<div class="ctt-section-label">현재 능력치</div>`;
      const effEntries = Object.entries(eff).filter(([, v]) => v > 0);
      if (effEntries.length) {
        body += effEntries.map(([k, v]) => {
          const def = STAT_MAP[k];
          const unit = def ? def.unit : '';
          const label = def ? def.label : k;
          return `<div class="ctt-stat-row">
        <span class="ctt-stat-name">${label}</span>
        <span class="ctt-stat-val">+${v}${unit}</span>
      </div>`;
        }).join('');
      } else {
        body += `<div style="font-size:10px;color:var(--text3);padding:4px;">스탯 없음</div>`;
      }

      // 업그레이드 단계별 스탯 (upgradeStats 있는 카드만)
      if (card.upgradeStats && card.upgradeStats.length > 1) {
        body += `<div class="ctt-section-label">강화 단계별 능력치</div>`;
        // 스탯 키 추출
        const keys = [...new Set(card.upgradeStats.flatMap(s => Object.keys(s)))];
        const stepColors = ['var(--text2)', 'var(--e1)', 'var(--e2)', 'var(--e3)', 'var(--e4)', 'var(--e5)'];
        body += `<table class="ctt-upgrade-table">
      <thead><tr><th>강화</th>${keys.map(k => {
          const def = STAT_MAP[k]; return `<th>${def ? def.label : k}</th>`;
        }).join('')}</tr></thead>
      <tbody>${card.upgradeStats.map((stepStats, step) => {
          const isActive = step === card.enhance;
          const stepLabel = step === 0 ? '기본' : `+${step}강`;
          const color = stepColors[step] || 'var(--text2)';
          return `<tr${isActive ? ' class="active-step"' : ''}>
          <td style="color:${color};font-weight:700;">${stepLabel}</td>
          ${keys.map(k => {
            const def = STAT_MAP[k];
            const unit = def ? def.unit : '';
            const v = stepStats[k] || 0;
            return `<td>+${v}${unit}</td>`;
          }).join('')}
        </tr>`;
        }).join('')}</tbody>
    </table>`;
      }


      // 역추적: 이 카드가 포함된 세트 찾기
      const relatedSets = setDefs.filter(def => def.cardTypes.includes(card.type));

      let relatedSetsHtml = `<div class="ctt-section-label">포함된 세트 조합 (${relatedSets.length})</div>`;

      if (relatedSets.length > 0) {
        relatedSetsHtml += `<div style="display:flex; flex-direction:column; gap:6px;">`;
        relatedSetsHtml += relatedSets.map(set => {
          const gc = GRADE_COLOR[set.grade] || 'var(--text3)';
          const gl = GRADE_LABEL[set.grade] || set.grade;
          return `
        <div style="padding:8px; background:rgba(255,255,255,.03); border:1px solid var(--border); border-radius:6px; cursor:pointer;" 
             onclick="closeCardTooltip(); switchTab('sets'); focusSet('${set.id}')">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
            <span style="font-size:11px; font-weight:700; color:var(--text1);">${set.name}</span>
            <span style="font-family:'Rajdhani',sans-serif; font-size:9px; color:${gc}; font-weight:700;">${gl}</span>
          </div>
          <div style="font-size:9px; color:var(--text3);">${set.cardTypes.join(' · ')}</div>
        </div>`;
        }).join('');
        relatedSetsHtml += `</div>`;
      } else {
        relatedSetsHtml += `<div style="font-size:10px; color:var(--text3); padding:4px;">포함된 세트가 없습니다.</div>`;
      }

      // 기존 body 내용에 역추적 섹션 결합
      document.getElementById('ctt-body').innerHTML = body + relatedSetsHtml;

      // ── 푸터 (액션 버튼) ──
      let footerBtns = '';

      if (invCard) {
        // [A] 인벤토리에 있는 "실물 카드"일 때
        const isEquipped = slots.some(s => s && s.id === cardId);
        const isMax = card.enhance >= 5;

        // 1. 삭제 버튼 (가장 왼쪽)
        footerBtns += `<button class="btn-danger" style="flex:1;" onclick="deleteCard('${cardId}');closeCardTooltip()">삭제</button>`;

        // 2. 강화 버튼 (가운데)
        if (!isMax) {
          footerBtns += `<button class="btn-enh" style="flex:1;" onclick="closeCardTooltip();openEnhOverlay('${cardId}')">🔥 강화</button>`;
        } else {
          footerBtns += `<span style="font-size:10px;color:var(--t7);font-family:'Rajdhani',sans-serif;font-weight:700;flex:1;display:flex;align-items:center;justify-content:center;">⭐ MAX</span>`;
        }

        // 3. 장착 버튼 (가장 오른쪽)
        if (isEquipped) {
          footerBtns += `<span style="font-size:10px;color:var(--green);font-family:'Rajdhani',sans-serif;font-weight:700;flex:1;display:flex;align-items:center;justify-content:center;">✓ 장착중</span>`;
        } else {
          footerBtns += `<button class="btn-sm" style="flex:1;" onclick="quickEquip('${cardId}');closeCardTooltip()">장착</button>`;
        }

      } else {
        // [B] 도감(Master)에 있는 카드일 때
        footerBtns += `<button class="btn-import" style="flex:1;" onclick="obtainCard('${card.cid}');closeCardTooltip()">➕ 인벤토리 획득</button>`;
        footerBtns += `<button class="btn-sm" style="flex:1;" onclick="closeCardTooltip()">닫기</button>`;
      }

      document.getElementById('ctt-footer').innerHTML = footerBtns;
      document.getElementById('card-tooltip-overlay').classList.add('open');
    }

    // 특정 세트를 강조해주는 보조 함수
    function focusSet(setId) {
      // 검색창을 해당 세트 이름으로 채워 필터링 효과를 줌
      const set = setDefs.find(s => s.id === setId);
      if (set) {
        const searchInput = document.getElementById('set-search');
        if (searchInput) {
          searchInput.value = set.name;
          renderSetDefsList();
        }
      }
    }

    function closeCardTooltip() {
      document.getElementById('card-tooltip-overlay').classList.remove('open');
    }

    // ESC 키로 툴팁/강화오버레이 닫기
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        closeCardTooltip();
        closeEnhOverlay();
      }
    });

    // 토스트
    let toastT;
    function showToast(msg, type = '') {
      const el = document.getElementById('toast');
      el.textContent = msg; el.className = 'show' + (type ? ' ' + type : '');
      clearTimeout(toastT); toastT = setTimeout(() => el.className = '', 2400);
    }


    // ==========================================
    // ==========================================
    // 자동 생성 로직
    // ==========================================

    // StatLimit 상수 (StatLimit.csv 기반)
    const STAT_LIMIT = {
      AttackVary: 100, PhysicalDefenseVary: 50, MagicDefenseVary: 50,
      AtkSpeedVaryper: 8000, MoveSpeedVaryper: 8000,
      MaxHpVary: 5000, MaxMpVary: 5000, RegenHpVary: 5000, RegenMpVary: 5000,
      DamageUpVaryper: 10000, DamageDownVaryper: 10000,
      PhysicalDamageUpVaryper: 10000, PhysicalDamageDownVaryper: 10000,
      MagicDamageUpVaryper: 10000, MagicDamageDownVaryper: 10000,
      PVEDamageUpVaryper: 10000, PVEDamageDownVaryper: 10000,
      PVPDamageUpVaryper: 10000, PVPDamageDownVaryper: 10000,
      DodgeVaryper: 10000, CriVaryper: 10000, CriDamageVaryper: 100000,
      SkillCooldownAccVary: 10000, SCNegativeRecoveryVary: 10000,
      CostMpDownVaryper: 10000, MountSpeedVaryper: 10000,
    };

    // 스탯 키 목록
    const ALL_STAT_KEYS = Object.keys(STAT_LIMIT);

    // per 스탯 여부
    const isPer = k => k.endsWith('per');

    // 5슬롯 7티어 보스 +5강 기준 카드 1장의 +5강 목표치 (천분율 원시값)
    function calcTarget5(statKey, tier, weight) {
      return (STAT_LIMIT[statKey] || 1) / 5 * (tier / 7) * weight;
    }

    // 내부 저장 단위: per는 /1000 → % 실수, 비per는 정수
    function toInternalStat(key, rawVal) {
      return isPer(key) ? Math.round(rawVal) / 1000 : Math.round(rawVal);
    }

    // CSV 출력 단위: per는 ×1000 → 천분율 정수, 비per는 정수 그대로
    function toRawStat(key, internalVal) {
      return isPer(key) ? Math.round(internalVal * 1000) : internalVal;
    }

    // 카드/세트 임시 저장
    let _agCards = [];
    let _agSets  = [];

    function runAutoGenerate() {
      const tierFrom  = parseInt(document.getElementById('ag-tier-from').value);
      const tierTo    = parseInt(document.getElementById('ag-tier-to').value);
      const cntNormal = Math.max(0, parseInt(document.getElementById('ag-cnt-normal').value) || 0);
      const cntHero   = Math.max(0, parseInt(document.getElementById('ag-cnt-hero').value)   || 0);
      const cntBoss   = Math.max(0, parseInt(document.getElementById('ag-cnt-boss').value)   || 0);
      const wNormal   = parseFloat(document.getElementById('ag-w-normal').value) || 0.6;
      const wHero     = parseFloat(document.getElementById('ag-w-hero').value)   || 0.8;
      const wBoss     = parseFloat(document.getElementById('ag-w-boss').value)   || 1.0;
      const genSets   = document.getElementById('ag-gen-sets').checked;
      const cntPair   = parseInt(document.getElementById('ag-set-pair').value)     || 0;
      const cntTriple = parseInt(document.getElementById('ag-set-triple').value)   || 0;
      const cntStr    = parseInt(document.getElementById('ag-set-straight').value) || 0;

      if (tierFrom > tierTo) return showToast('티어 범위를 확인하세요', 'err');
      if ((tierTo - tierFrom + 1) * (cntNormal + cntHero + cntBoss) === 0)
        return showToast('생성할 카드가 없습니다', 'err');

      _agCards = [];

      // 몬스터 이름 풀 (티어별)
      const NAMEPOOLS = [
        ['슬라임','박쥐','고블린','거미','늑대','스켈레톤','유령','스톤골렘','드래곤렛','코볼트','쥐인간','해충','돌거북','주술사','땅두더지'],
        ['임프','하피','오크','정찰견','놀','리치','뱀파이어','만티코어','혼령','트롤','독거미','모래인간','악어','워그','켈피'],
        ['가고일','바실리스크','강철인형','모래충','그리핀','듀라한','서큐버스','베히모스','골렘','사이클롭스','기가스','암굴왕','맹독뱀','스핑크스','철마'],
        ['와이번','히드라','키메라','메두사','피닉스','발록','켄타우로스','미노타우로스','카이저웜','스톰이글','선더도마뱀','철갑거북','용기사','암흑정령','죽음의기사'],
        ['가시나무괴물','늪지악어','검은표범','바위도마뱀','설원예티','서리거인','화염악마','백룡','원소정령','어비스워커','결빙군주','독기운','심연의가시','폭풍매','지진가디언'],
        ['심연의눈','고대의기사','지옥마','맹독전갈','거대오우거','타락천사','공포의지배자','흑룡','파멸의전령','저주받은영혼','부패의군주','재앙의숨결','혼돈의화신','공허지배자','어둠의수호자'],
        ['신성한사슴','천공의독수리','해룡','대지의수호자','태양의불사조','파괴의신','죽음의인도자','차원지배자','창세의신','혼돈의지배자','무한의용사','운명의칼날','심판의눈','원초의힘','절대의수호'],
      ];

      for (let tier = tierFrom; tier <= tierTo; tier++) {
        const pool = [...NAMEPOOLS[tier - 1]].sort(() => Math.random() - 0.5);
        let nameIdx = 0;

        // Array.from으로 독립 객체 생성 (fill은 같은 참조를 공유하므로 사용 금지)
        const configs = [
          ...Array.from({ length: cntNormal }, () => ({ rarity: 'normal', weight: wNormal, dualStat: false })),
          ...Array.from({ length: cntHero },   () => ({ rarity: 'hero',   weight: wHero,   dualStat: Math.random() < 0.5 })),
          ...Array.from({ length: cntBoss },   () => ({ rarity: 'boss',   weight: wBoss,   dualStat: true })),
        ];

        configs.forEach((cfg, idx) => {
          // CID: 170{tier}{4자리 순번} — e.g. 17010001
          const cid  = `170${tier}${String(idx + 1).padStart(4, '0')}`;
          const name = `${tier}T ${pool[nameIdx++ % pool.length]}`;

          // 스탯 키 선정: 보스=2, 영웅=1~2(랜덤), 일반=1
          const statCount  = cfg.dualStat ? 2 : 1;
          const chosenKeys = [...ALL_STAT_KEYS].sort(() => Math.random() - 0.5).slice(0, statCount);

          // upgradeStats 0강~5강: 0강=target5×50%, 이후 단계별 +20% of 0강
          const upgradeStats = Array.from({ length: 6 }, (_, step) => {
            const obj = {};
            chosenKeys.forEach(k => {
              const raw5 = calcTarget5(k, tier, cfg.weight);
              const base = raw5 * 0.5;
              const inc  = base * 0.2;
              obj[k] = toInternalStat(k, base + inc * step);
            });
            return obj;
          });

          _agCards.push({
            id: uid(), cid, name, type: name,
            icon: ICONS[Math.floor(Math.random() * ICONS.length)],
            tier, rarity: cfg.rarity,
            upgradeStats,
            stats: { ...upgradeStats[0] },
            enhance: 0,
            setEffects: { pair: '', triple: '', straight: '' },
            _statKeys: chosenKeys,
          });
        });
      }

      // ── 세트 생성 ──
      _agSets = [];
      if (genSets && _agCards.length >= 2) {
        const makeBuffDesc = (maxTier) => {
          const prob = 3 + Math.round(Math.random() * 12);
          const secs = 5 + Math.round(maxTier / 2);
          const t = maxTier;
          switch(Math.floor(Math.random() * 6)) {
            case 0: return `공격 시 ${prob}% 확률로 ${secs}초간 공격력 ${Math.round(t * 3)} 증가`;
            case 1: return `피격 시 ${prob}% 확률로 ${secs}초간 ${Math.round(t * 250)}의 피해를 흡수하는 보호막 생성`;
            case 2: return `치명타 발생 시 ${prob}% 확률로 ${secs}초간 치명타 피해 ${Math.round(t * 2000)} 증가`;
            case 3: return `스킬 사용 시 ${prob}% 확률로 ${secs}초간 이동 속도 ${Math.round(t * 200)} 증가`;
            case 4: return `체력이 30% 이하일 때 ${prob}% 확률로 즉시 ${Math.round(t * 200)}의 체력 회복 (재발동 대기 ${secs + 2}초)`;
            default: return `스킬 사용 시 ${prob}% 확률로 ${secs}초간 공격 속도 ${Math.round(t * 150)} 증가`;
          }
        };

        const SET_NAMES = [
          '고대의 비밀','고대의 서약','고대의 결속','고대의 투지','고대의 지혜','고대의 균형',
          '고대의 심판','천공의 맹약','심연의 계약','불멸의 동맹','혼돈의 협약','창세의 서원',
          '운명의 결속','절대의 맹세','파멸의 약속','재앙의 동반','순환의 법칙','영원의 서약',
          '태초의 각인','망각의 계보','소멸의 서','부활의 맹약','심판의 선언','천지의 약속',
        ];
        let setIdx = 0;

        const makeSet = (size, grade) => {
          for (let attempt = 0; attempt < 300; attempt++) {
            const shuffled  = [..._agCards].sort(() => Math.random() - 0.5);
            const picked    = [];
            const usedStats = new Set();
            for (const card of shuffled) {
              if ((card._statKeys || []).some(k => usedStats.has(k))) continue;
              picked.push(card);
              (card._statKeys || []).forEach(k => usedStats.add(k));
              if (picked.length === size) break;
            }
            if (picked.length < size) continue;

            const maxTier   = Math.max(...picked.map(c => c.tier));
            let descText    = makeBuffDesc(maxTier);
            let bonusEffect = {};

            if (grade === 'straight') {
              const bonusKey = ALL_STAT_KEYS[Math.floor(Math.random() * ALL_STAT_KEYS.length)];
              const raw      = calcTarget5(bonusKey, maxTier, 1.0) * 0.3;
              const internal = toInternalStat(bonusKey, raw);
              if (internal > 0) {
                bonusEffect[bonusKey] = internal;
                const def     = STAT_MAP[bonusKey];
                const dispVal = isPer(bonusKey) ? `${(internal * 100).toFixed(1)}%` : internal;
                descText += ` / [추가 보너스] ${def ? def.label : bonusKey} +${dispVal}`;
              }
            }

            _agSets.push({
              id: `set_ag_${uid()}`,
              name: `${SET_NAMES[setIdx % SET_NAMES.length]} ${setIdx + 1}`,
              cardTypes: picked.map(c => c.name),
              size, grade, desc: descText, effect: bonusEffect,
            });
            setIdx++;
            return true;
          }
          return false;
        };

        for (let i = 0; i < cntPair;   i++) makeSet(2, 'pair');
        for (let i = 0; i < cntTriple; i++) makeSet(3, 'triple');
        for (let i = 0; i < cntStr;    i++) makeSet(5, 'straight');
      }

      // ── 미리보기 ──
      const NL = '\n';
      let preview = '\u2705 카드 ' + _agCards.length + '장 생성 (T' + tierFrom + '~T' + tierTo + ')' + NL;
      preview += _agCards.slice(0, 10).map(c => {
        const stats = Object.entries(c.upgradeStats[0]).map(([k, v]) => {
          const def  = STAT_MAP[k];
          const disp = isPer(k) ? ((v * 100).toFixed(2) + '%') : v;
          return (def ? def.label : k) + ' ' + disp;
        }).join(' / ');
        return '  [T' + c.tier + '\u00B7' + c.rarity + '] ' + c.name + '  \u2192  ' + stats;
      }).join(NL);
      if (_agCards.length > 10) preview += NL + '  ... \uc678 ' + (_agCards.length - 10) + '\uc7a5';

      if (_agSets.length) {
        preview += NL + NL + '\u2705 세트 ' + _agSets.length + '개 생성' + NL;
        preview += _agSets.map(s =>
          '  [' + s.grade + '] ' + s.name + ' : ' + s.cardTypes.join(' | ')
        ).join(NL);
      }

      document.getElementById('ag-preview-body').textContent = preview;
      document.getElementById('ag-preview').style.display   = '';
      document.getElementById('ag-dl-sets-btn').style.display = genSets ? '' : 'none';
      showToast('카드 ' + _agCards.length + '장 + 세트 ' + _agSets.length + '개 생성 완료', 'ok');
    }

    function applyAutoGenerate() {
      if (!_agCards.length) return showToast('먼저 생성을 실행하세요', 'err');
      const mode = document.querySelector('input[name="ag-mode"]:checked')?.value || 'replace';
      const cleanCard = c => { const r = { ...c }; delete r._statKeys; return r; };

      if (mode === 'replace') {
        cards   = _agCards.map(cleanCard);
        setDefs = [..._agSets];
      } else {
        const existingCids   = new Set(cards.map(c => c.cid));
        const existingSetIds = new Set(setDefs.map(s => s.id));
        _agCards.forEach(c => { if (!existingCids.has(c.cid))   cards.push(cleanCard(c)); });
        _agSets.forEach(s  => { if (!existingSetIds.has(s.id)) setDefs.push(s); });
      }
      renderAll();
      if (typeof renderSetDefsList === 'function') renderSetDefsList();
      showToast(`${_agCards.length}장 카드 + ${_agSets.length}개 세트 적용 완료`, 'ok');
    }

    function downloadAutoCSV(type) {
      if (type === 'cards') {
        if (!_agCards.length) return showToast('생성된 카드 없음', 'err');
        const rows = ['Cid,Name,UpgradeStep,StatName,Stat,Tier,IconIndex'];
        _agCards.forEach(card => {
          const iconIdx = ICONS.indexOf(card.icon);
          const saveIdx = iconIdx !== -1 ? iconIdx : 0;
          card.upgradeStats.forEach((stepStats, step) => {
            const entries = Object.entries(stepStats);
            if (!entries.length) return;
            const statNames = entries.map(([k]) => k).join('|');
            // 내부값 → 천분율 원시값으로 역변환
            const statVals  = entries.map(([k, v]) => toRawStat(k, v)).join('|');
            rows.push(`${card.cid},${card.name},${step},${statNames},${statVals},Tier${card.tier},${saveIdx}`);
          });
        });
        _downloadCSV(rows.join('\n'), 'MonsterCards_DB.csv');

      } else {
        if (!_agSets.length) return showToast('생성된 세트 없음', 'err');
        const rows = ['ID,Name,Members,Size,Grade,Description,Effects'];
        _agSets.forEach(set => {
          const exportEffect = {};
          Object.entries(set.effect).forEach(([k, v]) => {
            exportEffect[k] = isPer(k) ? Math.round(v * 1000) : v;
          });
          const effects = JSON.stringify(exportEffect).replace(/"/g, "'");
          rows.push([
            set.id,
            `"${set.name.replace(/"/g,'""')}"`,
            `"${set.cardTypes.join('|')}"`,
            set.size, set.grade,
            `"${set.desc.replace(/"/g,'""')}"`,
            `"${effects}"`
          ].join(','));
        });
        _downloadCSV(rows.join('\n'), 'SetDefinitions_DB.csv');
      }
    }

    function _downloadCSV(csvContent, filename) {
      const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
      showToast(`${filename} 다운로드`, 'ok');
    }


        init();
  </script>


</body>

</html>